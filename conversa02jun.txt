Microsoft Windows [vers√£o 10.0.19045.5854]
(c) Microsoft Corporation. Todos os direitos reservados.

C:\Users\Usuario>cd C:\projetos\whatsapp-chatgpt-bot

C:\projetos\whatsapp-chatgpt-bot>npm run dev

> whatsapp-chatgpt-bot@1.1.0 dev
> ts-node-dev --respawn src/server.ts

[INFO] 13:29:39 ts-node-dev ver. 2.0.0 (using ts-node ver. 10.9.2, typescript ver. 5.8.3)
[2025-06-02 13:29:51] info: [env] ‚úÖ Vari√°veis de ambiente carregadas com sucesso
[2025-06-02 13:29:52] info: [db] Pool de conex√£o criado para banco: bot_whatsapp
[2025-06-02 13:29:53] info: [openai] Inicializando cliente OpenAI
[2025-06-02 13:29:59] info: [bootstrap] üåç Ambiente: development
[2025-06-02 13:29:59] info: [bootstrap] üì° Iniciando servidor na porta 3000...
[2025-06-02 13:29:59] debug: [bootstrap] üîÑ Criando pool do MySQL...
[2025-06-02 13:29:59] debug: [db] createDbPool() chamado
[2025-06-02 13:29:59] debug: [bootstrap] üîÑ Testando conex√£o MySQL...
[2025-06-02 13:29:59] info: [db] ‚úÖ Conex√£o com o banco de dados bem-sucedida: {
  "0": {
    "1": 1
  }
}
[2025-06-02 13:29:59] debug: [bootstrap] ‚úÖ MySQL conectado com sucesso
[2025-06-02 13:29:59] debug: [bootstrap] üîÑ Conectando ao MongoDB...
[2025-06-02 13:29:59] debug: [mongo] ‚è≥ Conectando ao MongoDB em: mongodb://localhost:27017/bot_whatsapp
[2025-06-02 13:30:00] info: [mongo] ‚úÖ Conectado com sucesso ao MongoDB: mongodb://localhost:27017/bot_whatsapp
[2025-06-02 13:30:00] debug: [bootstrap] ‚úÖ MongoDB conectado com sucesso
[2025-06-02 13:30:00] debug: [bootstrap] üöß Criando app Express...
[2025-06-02 13:30:00] info: [app] Inicializando aplica√ß√£o Express
[2025-06-02 13:30:00] debug: [app] Helmet aplicado
[2025-06-02 13:30:00] debug: [app] CORS habilitado
[2025-06-02 13:30:00] debug: [app] bodyParser JSON registrado
[2025-06-02 13:30:00] debug: [app] rateLimiterMiddleware aplicado
[2025-06-02 13:30:00] info: [app] Swagger UI dispon√≠vel em /api-docs
[2025-06-02 13:30:00] debug: [app] Rota /webhook registrada
[2025-06-02 13:30:00] debug: [app] errorMiddleware registrado
[2025-06-02 13:30:00] info: [app] Aplica√ß√£o configurada com sucesso
[2025-06-02 13:30:00] info: [bootstrap] üöÄ Servidor rodando em http://localhost:3000
[2025-06-02 13:30:07] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:30:07] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748881807337
[2025-06-02 13:30:07] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkNEQzUyNjcwNDE0NzAyOTY3QQA=",
                "status": "sent",
                "timestamp": "1748881828",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:30:07] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:30:08] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:30:08] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748881808148
[2025-06-02 13:30:08] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkNEQzUyNjcwNDE0NzAyOTY3QQA=",
                "status": "delivered",
                "timestamp": "1748881830",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:30:08] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:33:28] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:33:28] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882008372
[2025-06-02 13:33:28] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZCODRCQjY0Q0FGMzc1MkFBQzk4MzQxRkRGMzNDRTM5AA==",
                "timestamp": "1748882030",
                "text": {
                  "body": "Ol√°"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:33:28] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:33:28] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882008372
[2025-06-02 13:33:28] debug: [webhook] Texto recebido: Ol√°
[2025-06-02 13:33:28] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ol√°"
[2025-06-02 13:33:28] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882008383) para 5512988256404
[2025-06-02 13:33:28] debug: [handleMessage] [exec-1748882008383] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ol√°", isAudio=false
[2025-06-02 13:33:28] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:33:28] info: [handleMessage] [exec-1748882008383] Estado atual do cliente: pos_venda
[2025-06-02 13:33:28] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:33:28] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:33:28] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:33:28] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:33:28] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:33:28] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:33:28] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:33:28] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "pos_venda",
  "userMessage": "Ol√°"
}
[2025-06-02 13:33:28] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: pos_venda\nMensagem do cliente: Ol√°\nüìå DADOS J√Å "
    }
  ]
}
[2025-06-02 13:33:30] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "reativacao"
}
[2025-06-02 13:33:30] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 422,
    "completion_tokens": 3,
    "total_tokens": 425,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:33:30] info: [aiStateDecider] üß≠ Etapa atual: pos_venda ‚Äî IA sugeriu: reativacao
[2025-06-02 13:33:30] info: [handleMessage] [exec-1748882008383] Estado sugerido pela IA: reativacao
[2025-06-02 13:33:30] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí reativacao
[2025-06-02 13:33:30] debug: [ClientRepository] current_state atualizado para 'reativacao' e retries resetado
[2025-06-02 13:33:30] info: [handleMessage] [exec-1748882008383] Estado atualizado: pos_venda ‚Üí reativacao
[2025-06-02 13:33:30] debug: [handleMessage] [exec-1748882008383] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:33:30] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:33:30] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:33:31] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:33:31] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:33:31] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:33:31] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:33:31] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:33:31] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:33:31] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:33:31] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:33:31] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:33:35] debug: [extractByIA] Resultado IA: Desculpe, mas para poder ajud√°-lo, eu preciso que voc√™ descreva alguma situa√ß√£o ou problema no qual voc√™ j√° tentou algumas solu√ß√µes. Por exemplo: "Estou com problemas com meu roteador de internet. J√° tentei reinici√°-lo e tamb√©m verifiquei todas as conex√µes".
[2025-06-02 13:33:35] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:33:37] debug: [extractByIA] Resultado IA: Ol√°! Como posso ajud√°-lo hoje? Qual servi√ßo voc√™ est√° se referindo?
[2025-06-02 13:33:37] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:33:39] debug: [extractByIA] Resultado IA: O cliente n√£o especificou um n√≠vel de urg√™ncia na mensagem fornecida.
[2025-06-02 13:33:39] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:33:41] debug: [extractByIA] Resultado IA: Como voc√™ apenas disse "Ol√°", √© dif√≠cil determinar em qual est√°gio voc√™ est√° sem mais informa√ß√µes. Voc√™ pode estar em qualquer est√°gio, desde o interesse inicial at√© o fechamento. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:33:41] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:33:44] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu informa√ß√µes suficientes para determinar o tipo de obje√ß√£o do cliente.
[2025-06-02 13:33:44] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:33:45] debug: [extractByIA] Resultado IA: A sua mensagem n√£o expressa inten√ß√£o de compra.
[2025-06-02 13:33:45] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:33:46] debug: [extractByIA] Resultado IA: Ol√°! Como posso ajud√°-lo hoje?
[2025-06-02 13:33:46] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:33:49] debug: [extractByIA] Resultado IA: Seu texto n√£o fornece informa√ß√µes sobre a disponibilidade de hor√°rio. Poderia fornecer mais detalhes, por favor?
[2025-06-02 13:33:49] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:33:51] debug: [extractByIA] Resultado IA: Sem informa√ß√µes suficientes para extrair uma obje√ß√£o do cliente. Por favor, forne√ßa um contexto adequado.
[2025-06-02 13:33:51] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:33:53] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:33:53] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882033623
[2025-06-02 13:33:53] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZCODRCQjY0Q0FGMzc1MkFBQzk4MzQxRkRGMzNDRTM5AA==",
                "timestamp": "1748882030",
                "text": {
                  "body": "Ol√°"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:33:53] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:33:53] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882033623
[2025-06-02 13:33:53] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZCODRCQjY0Q0FGMzc1MkFBQzk4MzQxRkRGMzNDRTM5AA==
[2025-06-02 13:33:54] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° informa√ß√£o suficiente para responder √† sua pergunta. Por favor, forne√ßa um cen√°rio ou contexto mais detalhado.
[2025-06-02 13:33:54] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:33:56] debug: [extractByIA] Resultado IA: Desculpe, sua mensagem n√£o cont√©m informa√ß√µes suficientes para uma resposta. Poderia fornecer mais detalhes?
[2025-06-02 13:33:56] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:33:56] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:33:57] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o menciona qualquer forma de pagamento.
[2025-06-02 13:33:57] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:33:59] debug: [extractByIA] Resultado IA: Desculpe, mas essa resposta n√£o confirma se o cliente fechou ou n√£o.
[2025-06-02 13:33:59] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:34:01] debug: [extractByIA] Resultado IA: Voc√™ n√£o forneceu nenhum nome ou contato para eu extrair. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:34:01] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 30 mensagens.
[2025-06-02 13:34:01] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:34:01] info: [validadorMultiplos] [exec-1748882008383] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'reativacao'
[2025-06-02 13:34:01] info: [validadorMultiplos] [exec-1748882008383] üß© Validando metas da etapa: reativacao
[2025-06-02 13:34:01] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:34:01] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:34:01] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:34:01] debug: [validadorMultiplos] [exec-1748882008383] ‚ö†Ô∏è Campo 'reactivation_reason' n√£o identificado no texto.
[2025-06-02 13:34:01] debug: [validadorMultiplos] [exec-1748882008383] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'reactivation_reason': 2.87ms
[2025-06-02 13:34:01] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:34:02] debug: [extractByIA] Resultado IA: Ol√°! Como posso ajudar voc√™ hoje?
[2025-06-02 13:34:02] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:34:02] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "indicacao"
[2025-06-02 13:34:02] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Ol√°! Como posso ajudar voc√™ hoje?"
[2025-06-02 13:34:02] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ol√°"
[2025-06-02 13:34:02] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:34:03] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-06-02 13:34:03] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 631ms
[2025-06-02 13:34:03] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "indicacao",
  "valor": "Ol√°! Como posso ajudar voc√™ hoje?",
  "contexto": "Ol√°",
  "resposta": "n√£o",
  "tempo_ms": 631,
  "validado": false
}
[2025-06-02 13:34:03] warn: [validadorMultiplos] [exec-1748882008383] ‚ùå Campo 'indicacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:34:03] info: [ClientRepository] Atualizando campo indicacao para 5512988256404: null
[2025-06-02 13:34:03] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:34:03] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | indicacao
[2025-06-02 13:34:03] debug: [validadorMultiplos] [exec-1748882008383] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'indicacao': 1829.13ms
[2025-06-02 13:34:03] info: [validadorMultiplos] [exec-1748882008383] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'reativacao'
[2025-06-02 13:34:03] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:34:03] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ol√° {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:34:03] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:34:03] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:34:03] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:34:03] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:34:03] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:34:03] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:34:03] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:34:03] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:34:03] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:34:03] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:34:03] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:34:03] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:34:03] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:34:03] info: [temperatura] üîç Calculando temperatura com base na etapa "reativacao" e perfil do cliente
[2025-06-02 13:34:03] debug: [temperatura] Etapa reconhecida: "reativacao" ‚Üí base inicial: 0.8
[2025-06-02 13:34:03] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:34:03] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:34:03] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:34:03] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:34:03] info: [temperatura] ‚úÖ Temperatura final calculada: 0.85
[2025-06-02 13:34:06] info: [handleMessage] [exec-1748882008383] üîç Texto bruto da IA antes do filtro: Oi! Espero que esteja tudo bem. üòä Trouxe uma novidade: agora temos um pacote especial com cuidados p√≥s-procedimento incluso. Que tal retomarmos a conversa sobre a micropigmenta√ß√£o de barba?
[2025-06-02 13:34:06] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:34:06] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa reativacao, phone=5512988256404
[2025-06-02 13:34:06] info: [handleMessage] [exec-1748882008383] ‚úÖ Texto final p√≥s-processado: Oi! Espero que esteja tudo bem. ÔøΩ  Trouxe uma novidade: agora temos um pacote especial com cuidados p√≥s-procedimento incluso. Que tal retomarmos a conversa sobre a micropigmenta√ß√£o de barba?
[2025-06-02 13:34:06] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:34:06] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:34:06] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:34:06] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4463ms
[2025-06-02 13:34:11] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:34:11] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Oi! Espero que esteja tudo bem. üòä Trouxe uma novidade: agora temos um pacote especial com cuidados p√≥s-procedimento incluso. Que tal retomarmos a conversa sobre a micropigmenta√ß√£o de barba?" Timestamp=1748882051140
[2025-06-02 13:34:11] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:34:11] debug: [whatsapp] Conte√∫do da mensagem: "Oi! Espero que esteja tudo bem. üòä Trouxe uma novidade: agora temos um pacote especial com cuidados p√≥s-procedimento incluso. Que tal retomarmos a conversa sobre a micropigmenta√ß√£o de barba?"
[2025-06-02 13:34:11] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Oi! Espero que esteja tudo bem. üòä Trouxe uma novidade: agora temos um pacote especial com cuidados p√≥s-procedimento incluso. Que tal retomarmos a conversa sobre a micropigmenta√ß√£o de barba?"
  }
}
[2025-06-02 13:34:11] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:34:11] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:34:11] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjY2M0M5M0Y0NTdCRDY0MDZCRgA="
    }
  ]
}
[2025-06-02 13:34:11] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:34:13] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:34:13] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882053305
[2025-06-02 13:34:13] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjY2M0M5M0Y0NTdCRDY0MDZCRgA=",
                "status": "delivered",
                "timestamp": "1748882075",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:34:13] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:34:13] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:34:13] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882053332
[2025-06-02 13:34:13] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjY2M0M5M0Y0NTdCRDY0MDZCRgA=",
                "status": "sent",
                "timestamp": "1748882075",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:34:13] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:35:06] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:35:06] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882106730
[2025-06-02 13:35:06] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNDNkREMTJBMjdDMzY5OEY5MDRCNkY0OENCOTVBQUMzAA==",
                "timestamp": "1748882128",
                "text": {
                  "body": "Ah √©? E o que √© isso?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:35:06] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:35:06] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882106730
[2025-06-02 13:35:06] debug: [webhook] Texto recebido: Ah √©? E o que √© isso?
[2025-06-02 13:35:06] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ah √©? E o que √© isso?"
[2025-06-02 13:35:06] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882106756) para 5512988256404
[2025-06-02 13:35:06] debug: [handleMessage] [exec-1748882106756] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ah √©? E o que √© isso?", isAudio=false
[2025-06-02 13:35:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:35:06] info: [handleMessage] [exec-1748882106756] Estado atual do cliente: reativacao
[2025-06-02 13:35:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:35:06] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:35:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:35:06] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:35:06] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:35:06] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:35:06] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:35:06] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "reativacao",
  "userMessage": "Ah √©? E o que √© isso?"
}
[2025-06-02 13:35:06] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: reativacao\nMensagem do cliente: Ah √©? E o que √©"
    }
  ]
}
[2025-06-02 13:35:08] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "levantamento"
}
[2025-06-02 13:35:08] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 428,
    "completion_tokens": 2,
    "total_tokens": 430,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:35:08] info: [aiStateDecider] üß≠ Etapa atual: reativacao ‚Äî IA sugeriu: levantamento
[2025-06-02 13:35:08] info: [handleMessage] [exec-1748882106756] Estado sugerido pela IA: levantamento
[2025-06-02 13:35:08] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí levantamento
[2025-06-02 13:35:08] debug: [ClientRepository] current_state atualizado para 'levantamento' e retries resetado
[2025-06-02 13:35:08] info: [handleMessage] [exec-1748882106756] Estado atualizado: reativacao ‚Üí levantamento
[2025-06-02 13:35:08] debug: [handleMessage] [exec-1748882106756] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:35:08] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:35:08] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:35:09] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:35:09] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:35:09] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:35:09] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:35:09] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:35:09] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:35:09] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:35:09] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:35:09] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:35:10] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:35:10] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:35:13] debug: [extractByIA] Resultado IA: Desculpe, a informa√ß√£o que voc√™ est√° pedindo n√£o est√° clara. Por favor, especifique para que eu possa fornecer uma resposta precisa.
[2025-06-02 13:35:13] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:35:14] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi especificado nesta declara√ß√£o.
[2025-06-02 13:35:14] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:35:18] debug: [extractByIA] Resultado IA: Com base em seu coment√°rio, parece que o cliente est√° no est√°gio da "d√∫vida" ou "interesse", uma vez que est√° buscando informa√ß√µes adicionais ou n√£o est√° familiarizado com o t√≥pico discutido.
[2025-06-02 13:35:18] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:35:20] debug: [extractByIA] Resultado IA: A obje√ß√£o apresentada pelo cliente poderia ser classificada como confus√£o ou falta de entendimento sobre o produto ou servi√ßo.
[2025-06-02 13:35:20] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:35:20] debug: [extractByIA] Resultado IA: N√£o
[2025-06-02 13:35:20] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:35:22] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° nenhuma prefer√™ncia de agendamento mencionada em sua declara√ß√£o.
[2025-06-02 13:35:22] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:35:24] debug: [extractByIA] Resultado IA: A pergunta parece estar solicitando uma informa√ß√£o que n√£o foi fornecida. Por favor, forne√ßa um contexto ou exemplo adequado.
[2025-06-02 13:35:24] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:35:26] debug: [extractByIA] Resultado IA: O cliente parece estar confuso ou desinformado sobre o produto/servi√ßo.
[2025-06-02 13:35:26] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:35:28] debug: [extractByIA] Resultado IA: O cliente n√£o ofereceu uma alternativa neste trecho.
[2025-06-02 13:35:28] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:35:29] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o forneceu nenhuma informa√ß√£o onde eu possa extrair o valor percentual de desconto solicitado.
[2025-06-02 13:35:29] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:35:29] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:35:31] debug: [extractByIA] Resultado IA: O texto n√£o menciona nenhuma forma de pagamento.
[2025-06-02 13:35:31] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:35:31] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:35:31] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882131942
[2025-06-02 13:35:31] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNDNkREMTJBMjdDMzY5OEY5MDRCNkY0OENCOTVBQUMzAA==",
                "timestamp": "1748882128",
                "text": {
                  "body": "Ah √©? E o que √© isso?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:35:31] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:35:31] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882131942
[2025-06-02 13:35:31] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNDNkREMTJBMjdDMzY5OEY5MDRCNkY0OENCOTVBQUMzAA==
[2025-06-02 13:35:32] debug: [extractByIA] Resultado IA: Desculpe, n√£o consigo confirmar com base nessa informa√ß√£o.
[2025-06-02 13:35:32] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:35:34] debug: [extractByIA] Resultado IA: Desculpe, mas o cliente n√£o forneceu nenhuma informa√ß√£o sobre uma pessoa ou contato.
[2025-06-02 13:35:34] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 31 mensagens.
[2025-06-02 13:35:34] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:35:34] info: [validadorMultiplos] [exec-1748882106756] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'levantamento'
[2025-06-02 13:35:34] info: [validadorMultiplos] [exec-1748882106756] üß© Validando metas da etapa: levantamento
[2025-06-02 13:35:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:35:34] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:35:34] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:35:34] debug: [validadorMultiplos] [exec-1748882106756] ‚ö†Ô∏è Campo 'needs' n√£o identificado no texto.
[2025-06-02 13:35:34] debug: [validadorMultiplos] [exec-1748882106756] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'needs': 2.67ms
[2025-06-02 13:35:34] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:35:36] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre quais solu√ß√µes o cliente j√° tentou anteriormente.
[2025-06-02 13:35:36] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:35:36] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "attempted_solutions"
[2025-06-02 13:35:36] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O texto n√£o fornece informa√ß√µes sobre quais solu√ß√µes o cliente j√° tentou anteriormente."
[2025-06-02 13:35:36] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ah √©? E o que √© isso?"
[2025-06-02 13:35:36] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:35:37] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:35:37] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 779ms
[2025-06-02 13:35:37] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "attempted_solutions",
  "valor": "O texto n√£o fornece informa√ß√µes sobre quais solu√ß√µes o cliente j√° tentou anteriormente.",
  "contexto": "Ah √©? E o que √© isso?",
  "resposta": "n√£o.",
  "tempo_ms": 779,
  "validado": false
}
[2025-06-02 13:35:37] warn: [validadorMultiplos] [exec-1748882106756] ‚ùå Campo 'attempted_solutions' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:35:37] info: [ClientRepository] Atualizando campo attempted_solutions para 5512988256404: null
[2025-06-02 13:35:37] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:35:37] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | attempted_solutions
[2025-06-02 13:35:37] debug: [validadorMultiplos] [exec-1748882106756] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'attempted_solutions': 2765.22ms
[2025-06-02 13:35:37] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:35:40] debug: [extractByIA] Resultado IA: Desculpe, parece que houve um erro ou mal-entendido. Eu fiz uma pergunta gen√©rica e n√£o me referi a qualquer servi√ßo espec√≠fico. Poderia me dizer a qual servi√ßo voc√™ est√° se referindo para que eu possa lhe fornecer uma resposta melhor?
[2025-06-02 13:35:40] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:35:40] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "expectations"
[2025-06-02 13:35:40] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, parece que houve um erro ou mal-entendido. Eu fiz uma pergunta gen√©rica e n√£o me referi a qualquer servi√ßo espec√≠fico. Poderia me dizer a qual servi√ßo voc√™ est√° se referindo para que eu possa lhe fornecer uma resposta melhor?"
[2025-06-02 13:35:40] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ah √©? E o que √© isso?"
[2025-06-02 13:35:40] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:35:41] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:35:41] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 933ms
[2025-06-02 13:35:41] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "expectations",
  "valor": "Desculpe, parece que houve um erro ou mal-entendido. Eu fiz uma pergunta gen√©rica e n√£o me referi a qualquer servi√ßo espec√≠fico. Poderia me dizer a qual servi√ßo voc√™ est√° se referindo para que eu possa lhe fornecer uma resposta melhor?",
  "contexto": "Ah √©? E o que √© isso?",
  "resposta": "n√£o.",
  "tempo_ms": 933,
  "validado": false
}
[2025-06-02 13:35:41] warn: [validadorMultiplos] [exec-1748882106756] ‚ùå Campo 'expectations' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:35:41] info: [ClientRepository] Atualizando campo expectations para 5512988256404: null
[2025-06-02 13:35:41] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:35:41] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | expectations
[2025-06-02 13:35:41] debug: [validadorMultiplos] [exec-1748882106756] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'expectations': 4231.25ms
[2025-06-02 13:35:41] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:35:43] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi especificado nesta mensagem.
[2025-06-02 13:35:43] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:35:43] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "urgency_level"
[2025-06-02 13:35:43] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O n√≠vel de urg√™ncia do cliente n√£o foi especificado nesta mensagem."
[2025-06-02 13:35:43] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ah √©? E o que √© isso?"
[2025-06-02 13:35:43] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:35:44] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:35:44] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1403ms
[2025-06-02 13:35:44] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "urgency_level",
  "valor": "O n√≠vel de urg√™ncia do cliente n√£o foi especificado nesta mensagem.",
  "contexto": "Ah √©? E o que √© isso?",
  "resposta": "n√£o.",
  "tempo_ms": 1403,
  "validado": false
}
[2025-06-02 13:35:44] warn: [validadorMultiplos] [exec-1748882106756] ‚ùå Campo 'urgency_level' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:35:44] info: [ClientRepository] Atualizando campo urgency_level para 5512988256404: null
[2025-06-02 13:35:44] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:35:44] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | urgency_level
[2025-06-02 13:35:44] debug: [validadorMultiplos] [exec-1748882106756] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'urgency_level': 3126.10ms
[2025-06-02 13:35:44] info: [validadorMultiplos] [exec-1748882106756] Campo 'client_stage' j√° est√° preenchido: O cliente est√° no es. Pulando.
[2025-06-02 13:35:44] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:35:49] debug: [extractByIA] Resultado IA: Desculpe, acredito que houve um mal entendido. Eu estava pedindo por um exemplo de frase para que eu possa extrair a disponibilidade de hor√°rio, como "Estarei dispon√≠vel amanh√£ de manh√£." Ou "Gostaria de marcar para sexta √† tarde."
[2025-06-02 13:35:49] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:35:49] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "disponibilidade"
[2025-06-02 13:35:49] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, acredito que houve um mal entendido. Eu estava pedindo por um exemplo de frase para que eu possa extrair a disponibilidade de hor√°rio, como "Estarei dispon√≠vel amanh√£ de manh√£." Ou "Gostaria de marcar para sexta √† tarde.""
[2025-06-02 13:35:49] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ah √©? E o que √© isso?"
[2025-06-02 13:35:49] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:35:50] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:35:50] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 643ms
[2025-06-02 13:35:50] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "disponibilidade",
  "valor": "Desculpe, acredito que houve um mal entendido. Eu estava pedindo por um exemplo de frase para que eu possa extrair a disponibilidade de hor√°rio, como \"Estarei dispon√≠vel amanh√£ de manh√£.\" Ou \"Gostaria de marcar para sexta √† tarde.\"",
  "contexto": "Ah √©? E o que √© isso?",
  "resposta": "n√£o.",
  "tempo_ms": 643,
  "validado": false
}
[2025-06-02 13:35:50] warn: [validadorMultiplos] [exec-1748882106756] ‚ùå Campo 'disponibilidade' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:35:50] info: [ClientRepository] Atualizando campo disponibilidade para 5512988256404: null
[2025-06-02 13:35:50] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:35:50] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | disponibilidade
[2025-06-02 13:35:50] debug: [validadorMultiplos] [exec-1748882106756] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'disponibilidade': 5721.51ms
[2025-06-02 13:35:50] info: [validadorMultiplos] [exec-1748882106756] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'levantamento'
[2025-06-02 13:35:50] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:35:50] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ah √©? E o que √© isso? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:35:51] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:35:51] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:35:51] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:35:51] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:35:51] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:35:51] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:35:51] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:35:51] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:35:51] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:35:51] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:35:51] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:35:51] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:35:51] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:35:51] info: [temperatura] üîç Calculando temperatura com base na etapa "levantamento" e perfil do cliente
[2025-06-02 13:35:51] debug: [temperatura] Etapa reconhecida: "levantamento" ‚Üí base inicial: 0.85
[2025-06-02 13:35:51] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:35:51] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:35:51] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:35:51] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:35:51] info: [temperatura] ‚úÖ Temperatura final calculada: 0.9
[2025-06-02 13:35:55] info: [handleMessage] [exec-1748882106756] üîç Texto bruto da IA antes do filtro: A micropigmenta√ß√£o de barba √© um procedimento est√©tico que utiliza uma t√©cnica especial para implantar pigmentos na pele, preenchendo as falhas e dando um aspecto de barba cheia e natural. Gostaria de saber mais sobre como o procedimento √© realizado ou tem alguma d√∫vida espec√≠fica?
[2025-06-02 13:35:55] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:35:55] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa levantamento, phone=5512988256404
[2025-06-02 13:35:55] info: [handleMessage] [exec-1748882106756] ‚úÖ Texto final p√≥s-processado: A micropigmenta√ß√£o de barba √© um procedimento est√©tico que utiliza uma t√©cnica especial para implantar pigmentos na pele, preenchendo as falhas e dando um aspecto de barba cheia e natural. Gostaria de saber mais sobre como o procedimento √© realizado ou tem alguma d√∫vida espec√≠fica?
[2025-06-02 13:35:55] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:35:55] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:35:55] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:35:55] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6324ms
[2025-06-02 13:36:01] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:36:01] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "A micropigmenta√ß√£o de barba √© um procedimento est√©tico que utiliza uma t√©cnica especial para implantar pigmentos na pele, preenchendo as falhas e dando um aspecto de barba cheia e natural. Gostaria de saber mais sobre como o procedimento √© realizado ou tem alguma d√∫vida espec√≠fica?" Timestamp=1748882161414
[2025-06-02 13:36:01] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:36:01] debug: [whatsapp] Conte√∫do da mensagem: "A micropigmenta√ß√£o de barba √© um procedimento est√©tico que utiliza uma t√©cnica especial para implantar pigmentos na pele, preenchendo as falhas e dando um aspecto de barba cheia e natural. Gostaria de saber mais sobre como o procedimento √© realizado ou tem alguma d√∫vida espec√≠fica?"
[2025-06-02 13:36:01] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "A micropigmenta√ß√£o de barba √© um procedimento est√©tico que utiliza uma t√©cnica especial para implantar pigmentos na pele, preenchendo as falhas e dando um aspecto de barba cheia e natural. Gostaria de saber mais sobre como o procedimento √© realizado ou tem alguma d√∫vida espec√≠fica?"
  }
}
[2025-06-02 13:36:01] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:36:02] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:36:02] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkFDODhCMTIzMDZFNEY5QTMyMgA="
    }
  ]
}
[2025-06-02 13:36:02] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:36:03] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:36:03] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882163910
[2025-06-02 13:36:03] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkFDODhCMTIzMDZFNEY5QTMyMgA=",
                "status": "delivered",
                "timestamp": "1748882186",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:36:03] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:36:03] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:36:03] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882163956
[2025-06-02 13:36:03] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkFDODhCMTIzMDZFNEY5QTMyMgA=",
                "status": "sent",
                "timestamp": "1748882185",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:36:03] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:36:49] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:36:49] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882209186
[2025-06-02 13:36:49] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA2NDczNzZDMDMzOUZFMTI4Q0RCOUM0NURFQTg4NTU2AA==",
                "timestamp": "1748882230",
                "type": "audio",
                "audio": {
                  "mime_type": "audio/ogg; codecs=opus",
                  "sha256": "eR1gk+MLDavpvwQJVZiIAXTWoGcQEK0D/uHYjl2UY5E=",
                  "id": "9668318206629655",
                  "voice": true
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:36:49] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:36:49] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882209186
[2025-06-02 13:36:49] debug: [whatsapp] Iniciando download de m√≠dia: mediaId=9668318206629655
[2025-06-02 13:36:50] info: [whatsapp] M√≠dia baixada com sucesso: mediaId=9668318206629655
[2025-06-02 13:36:50] debug: [audioService] Iniciando transcri√ß√£o de √°udio
[2025-06-02 13:36:52] info: [audioService] Transcri√ß√£o conclu√≠da com sucesso
[2025-06-02 13:36:52] debug: [webhook] √Åudio transcrito: √ì, voc√™ falou de cuidados p√≥s-procedimento incluso, eu queria saber o que que √© isso?
[2025-06-02 13:36:52] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "√ì, voc√™ falou de cuidados p√≥s-procedimento incluso, eu queria saber o que que √© isso?"
[2025-06-02 13:36:52] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882212792) para 5512988256404
[2025-06-02 13:36:52] debug: [handleMessage] [exec-1748882212792] üì≤ Iniciando atendimento: phone=5512988256404, texto="√ì, voc√™ falou de cuidados p√≥s-procedimento incluso, eu queria saber o que que √© isso?", isAudio=true
[2025-06-02 13:36:52] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:36:52] info: [handleMessage] [exec-1748882212792] Estado atual do cliente: levantamento
[2025-06-02 13:36:52] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:36:52] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:36:52] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:36:52] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:36:52] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:36:52] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:36:52] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:36:52] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "levantamento",
  "userMessage": "√ì, voc√™ falou de cuidados p√≥s-procedimento incluso, eu queria saber o que que √© isso?"
}
[2025-06-02 13:36:52] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: levantamento\nMensagem do cliente: √ì, voc√™ falou"
    }
  ]
}
[2025-06-02 13:36:53] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "proposta"
}
[2025-06-02 13:36:53] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 445,
    "completion_tokens": 2,
    "total_tokens": 447,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:36:53] info: [aiStateDecider] üß≠ Etapa atual: levantamento ‚Äî IA sugeriu: proposta
[2025-06-02 13:36:53] info: [handleMessage] [exec-1748882212792] Estado sugerido pela IA: proposta
[2025-06-02 13:36:53] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí proposta
[2025-06-02 13:36:53] debug: [ClientRepository] current_state atualizado para 'proposta' e retries resetado
[2025-06-02 13:36:53] info: [handleMessage] [exec-1748882212792] Estado atualizado: levantamento ‚Üí proposta
[2025-06-02 13:36:53] debug: [handleMessage] [exec-1748882212792] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:36:53] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:36:53] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:36:54] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:36:54] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:36:54] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:36:54] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:36:54] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:36:54] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:36:54] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:36:54] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:36:54] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:36:56] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou nenhuma solu√ß√£o que tenha tentado anteriormente.
[2025-06-02 13:36:56] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:37:04] debug: [extractByIA] Resultado IA: Os cuidados p√≥s-procedimento s√£o as medidas que voc√™ deve tomar ap√≥s um determinado procedimento m√©dico ou est√©tico para garantir que voc√™ se recupere corretamente e obtenha os melhores resultados poss√≠veis.

Isso pode incluir coisas como evitar exposi√ß√£o ao sol, usar medicamentos ou cremes espec√≠ficos, evitar certas atividades, seguir uma dieta especial ou voltar para fazer visitas de acompanhamento.

No seu caso espec√≠fico, eu precisaria saber mais sobre o procedimento que voc√™ est√° considerando para lhe dar conselhos mais detalhados.
[2025-06-02 13:37:04] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:37:05] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o √© mencionado nesta solicita√ß√£o.
[2025-06-02 13:37:05] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:37:07] debug: [extractByIA] Resultado IA: O cliente est√° no est√°gio de d√∫vida.
[2025-06-02 13:37:07] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:37:09] debug: [extractByIA] Resultado IA: A obje√ß√£o do cliente √© relativa √† compreens√£o/entendimento sobre os servi√ßos oferecidos (Cuidados P√≥s-Procedimento).
[2025-06-02 13:37:09] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:37:11] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:37:11] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:37:12] debug: [extractByIA] Resultado IA: A prefer√™ncia de agendamento do cliente n√£o foi mencionada neste texto.
[2025-06-02 13:37:12] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:37:14] debug: [extractByIA] Resultado IA: A mensagem n√£o apresenta uma disponibilidade de hor√°rio.
[2025-06-02 13:37:14] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:37:14] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:37:14] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882234682
[2025-06-02 13:37:14] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA2NDczNzZDMDMzOUZFMTI4Q0RCOUM0NURFQTg4NTU2AA==",
                "timestamp": "1748882230",
                "type": "audio",
                "audio": {
                  "mime_type": "audio/ogg; codecs=opus",
                  "sha256": "eR1gk+MLDavpvwQJVZiIAXTWoGcQEK0D/uHYjl2UY5E=",
                  "id": "9668318206629655",
                  "voice": true
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:37:14] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:37:14] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882234682
[2025-06-02 13:37:14] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA2NDczNzZDMDMzOUZFMTI4Q0RCOUM0NURFQTg4NTU2AA==
[2025-06-02 13:37:16] debug: [extractByIA] Resultado IA: O cliente est√° questionando sobre o que se trata os cuidados p√≥s-procedimento mencionados.
[2025-06-02 13:37:16] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:37:18] debug: [extractByIA] Resultado IA: O cliente prop√µe a alternativa de obter mais informa√ß√µes sobre os cuidados p√≥s-procedimento inclusos.
[2025-06-02 13:37:18] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:37:21] debug: [extractByIA] Resultado IA: A solicita√ß√£o n√£o parece incluir nenhuma informa√ß√£o sobre um desconto percentual.
[2025-06-02 13:37:21] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:37:21] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:37:23] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou nenhuma forma de pagamento neste trecho.
[2025-06-02 13:37:23] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:37:28] debug: [extractByIA] Resultado IA: Desculpe, mas sua pergunta anterior n√£o menciona um fechamento de neg√≥cio ou contrato. Posso te ajudar com os cuidados p√≥s-procedimento. Normalmente, esses s√£o os cuidados ou precau√ß√µes que voc√™ precisa tomar ap√≥s realizar um procedimento m√©dico, est√©tico ou similar para garantir que sua recupera√ß√£o seja feita corretamente e sem complica√ß√µes.
[2025-06-02 13:37:28] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:37:31] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o posso fornecer o nome ou contato, porque voc√™ n√£o forneceu nenhuma informa√ß√£o sobre uma pessoa espec√≠fica.
[2025-06-02 13:37:31] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 32 mensagens.
[2025-06-02 13:37:31] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:37:31] info: [validadorMultiplos] [exec-1748882212792] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'proposta'
[2025-06-02 13:37:31] info: [validadorMultiplos] [exec-1748882212792] üß© Validando metas da etapa: proposta
[2025-06-02 13:37:31] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:37:31] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:37:31] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:37:31] debug: [validadorMultiplos] [exec-1748882212792] ‚ö†Ô∏è Campo 'budget' n√£o identificado no texto.
[2025-06-02 13:37:31] debug: [validadorMultiplos] [exec-1748882212792] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'budget': 3.20ms
[2025-06-02 13:37:31] info: [validadorMultiplos] [exec-1748882212792] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'proposta'
[2025-06-02 13:37:31] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:37:31] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados √ì, voc√™ falou de cuidados p√≥s-procedimento incluso, eu queria saber o que que √© isso? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:37:32] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "posvenda"
}
[2025-06-02 13:37:32] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "posvenda"
[2025-06-02 13:37:32] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:37:32] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:37:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:37:32] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:37:32] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:37:32] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:37:32] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:37:32] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:37:32] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:37:32] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:37:32] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:37:32] info: [temperatura] üîç Calculando temperatura com base na etapa "proposta" e perfil do cliente
[2025-06-02 13:37:32] debug: [temperatura] Etapa reconhecida: "proposta" ‚Üí base inicial: 0.75
[2025-06-02 13:37:32] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:37:32] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:37:32] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:37:32] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:37:32] info: [temperatura] ‚úÖ Temperatura final calculada: 0.8
[2025-06-02 13:37:34] info: [handleMessage] [exec-1748882212792] üîç Texto bruto da IA antes do filtro: O cuidado p√≥s-procedimento inclui instru√ß√µes detalhadas sobre como manter a √°rea tratada para garantir a melhor cicatriza√ß√£o e durabilidade dos resultados.
[2025-06-02 13:37:34] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:37:34] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa proposta, phone=5512988256404
[2025-06-02 13:37:34] info: [handleMessage] [exec-1748882212792] ‚úÖ Texto final p√≥s-processado: O cuidado p√≥s-procedimento inclui instru√ß√µes detalhadas sobre como manter a √°rea tratada para garantir a melhor cicatriza√ß√£o e durabilidade dos resultados.
[2025-06-02 13:37:34] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:37:34] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:37:34] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:37:34] debug: [audioService] Iniciando s√≠ntese de voz: "O cuidado p√≥s-procedimento inc..."
[2025-06-02 13:37:34] debug: [audioService] Texto naturalizado: "O cuidado p√≥s-procedimento inclui instru√ß√µes detalhadas sobre como manter a √°rea tratada para garantir a melhor cicatriza√ß√£o e durabilidade dos resultados."
ffmpeg version 7.1.1-essentials_build-www.gyan.dev Copyright (c) 2000-2025 the FFmpeg developers
  built with gcc 14.2.0 (Rev1, Built by MSYS2 project)
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-bzlib --enable-lzma --enable-zlib --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-sdl2 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-mediafoundation --enable-libass --enable-libfreetype --enable-libfribidi --enable-libharfbuzz --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-dxva2 --enable-d3d11va --enable-d3d12va --enable-ffnvcodec --enable-libvpl --enable-nvdec --enable-nvenc --enable-vaapi --enable-libgme --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libtheora --enable-libvo-amrwbenc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-librubberband
  libavutil      59. 39.100 / 59. 39.100
  libavcodec     61. 19.101 / 61. 19.101
  libavformat    61.  7.100 / 61.  7.100
  libavdevice    61.  3.100 / 61.  3.100
  libavfilter    10.  4.100 / 10.  4.100
  libswscale      8.  3.100 /  8.  3.100
  libswresample   5.  3.100 /  5.  3.100
  libpostproc    58.  3.100 / 58.  3.100
[mp3 @ 0000020b200061c0] Estimating duration from bitrate, this may be inaccurate
Input #0, mp3, from 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.mp3':
  Metadata:
    encoder         : Lavf59.27.100
  Duration: 00:00:08.96, start: 0.000000, bitrate: 128 kb/s
  Stream #0:0: Audio: mp3 (mp3float), 44100 Hz, mono, fltp, 128 kb/s
Stream mapping:
  Stream #0:0 -> #0:0 (mp3 (mp3float) -> opus (libopus))
Press [q] to stop, [?] for help
Output #0, ogg, to 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg':
  Metadata:
    encoder         : Lavf61.7.100
  Stream #0:0: Audio: opus, 48000 Hz, mono, flt, 64 kb/s
      Metadata:
        encoder         : Lavc61.19.101 libopus
[out#0/ogg @ 0000020b20020f80] video:0KiB audio:84KiB subtitle:0KiB other streams:0KiB global headers:0KiB muxing overhead: 1.038825%
size=      85KiB time=00:00:08.96 bitrate=  77.7kbits/s speed=68.6x
[2025-06-02 13:37:37] info: [audioService] √Åudio gerado e convertido com sucesso
[2025-06-02 13:37:37] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de √°udio ‚Äî aguardando 4489ms
[2025-06-02 13:37:41] info: [typingSimulator] üöÄ Enviando mensagem de √°udio ap√≥s digita√ß√£o
[2025-06-02 13:37:41] debug: [whatsapp] Enviando √°udio para 5512988256404
[2025-06-02 13:37:41] debug: [whatsapp] üîº Upload de √°udio iniciado para C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-06-02 13:37:41] debug: [whatsapp] Headers do FormData: {
  "Authorization": "Bearer EAARCeDx95qgBO1pHhrQseDqzPPtQ1ZAkjrUY539yOyGEZAsZAqy0w5AAq0VhNKzAiJ711GXUzA66halYEvyd5oxaS9vSS2H2HNCUVua1KevProQQWRUZAAxgEiazSGQksCXP46qRKrX4b0IbbZAZCDCefhuk6gnZBZAjGBmkxcLlVpIIYpoToUGZA5vmGQOhywNOUmDVITAEFDpkq8O7RvhM210EZBRlx3zH5ZCJsgfl3CFjiLAeYUZD",
  "content-type": "multipart/form-data; boundary=--------------------------380207518882185067839164"
}
[2025-06-02 13:37:43] info: [whatsapp] ‚úÖ Upload de √°udio conclu√≠do com media_id: 728967619790860
[2025-06-02 13:37:44] info: [whatsapp] ‚úÖ √Åudio enviado com sucesso para 5512988256404
[2025-06-02 13:37:44] debug: [whatsapp] üßπ Arquivo tempor√°rio removido: C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-06-02 13:37:44] info: [typingSimulator] ‚úÖ mensagem de √°udio enviada com sucesso
[2025-06-02 13:37:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:37:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882265694
[2025-06-02 13:37:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjY1ODg5QkNENTZDM0QxMDhDMgA=",
                "status": "sent",
                "timestamp": "1748882287",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:37:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:37:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:37:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882265894
[2025-06-02 13:37:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjY1ODg5QkNENTZDM0QxMDhDMgA=",
                "status": "delivered",
                "timestamp": "1748882288",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:37:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:38:19] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:38:19] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882299163
[2025-06-02 13:38:19] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDJFMkQzREEyMUYxQUYyMDcwRDg1NDhCQjYyMDYwNUJGAA==",
                "timestamp": "1748882321",
                "text": {
                  "body": "S√≥ isso?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:38:19] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:38:19] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882299163
[2025-06-02 13:38:19] debug: [webhook] Texto recebido: S√≥ isso?
[2025-06-02 13:38:19] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "S√≥ isso?"
[2025-06-02 13:38:19] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882299177) para 5512988256404
[2025-06-02 13:38:19] debug: [handleMessage] [exec-1748882299177] üì≤ Iniciando atendimento: phone=5512988256404, texto="S√≥ isso?", isAudio=false
[2025-06-02 13:38:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:38:19] info: [handleMessage] [exec-1748882299177] Estado atual do cliente: proposta
[2025-06-02 13:38:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:38:19] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:38:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:38:19] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:38:19] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:38:19] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:38:19] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:38:19] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "proposta",
  "userMessage": "S√≥ isso?"
}
[2025-06-02 13:38:19] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: proposta\nMensagem do cliente: S√≥ isso?\nüìå DADOS"
    }
  ]
}
[2025-06-02 13:38:20] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "objecoes"
}
[2025-06-02 13:38:20] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 422,
    "completion_tokens": 3,
    "total_tokens": 425,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:38:20] info: [aiStateDecider] üß≠ Etapa atual: proposta ‚Äî IA sugeriu: objecoes
[2025-06-02 13:38:20] info: [handleMessage] [exec-1748882299177] Estado sugerido pela IA: objecoes
[2025-06-02 13:38:20] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí objecoes
[2025-06-02 13:38:20] debug: [ClientRepository] current_state atualizado para 'objecoes' e retries resetado
[2025-06-02 13:38:20] info: [handleMessage] [exec-1748882299177] Estado atualizado: proposta ‚Üí objecoes
[2025-06-02 13:38:20] debug: [handleMessage] [exec-1748882299177] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:38:20] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:38:20] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:38:21] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:38:21] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:38:21] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:38:21] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:38:21] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:38:21] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:38:21] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:38:21] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:38:21] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:38:24] debug: [extractByIA] Resultado IA: Desculpe, mas para lhe ajudar, preciso que voc√™ me informe sobre o problema que est√° ocorrendo. Por favor, me conte mais sobre ele e as solu√ß√µes que j√° tentou para resolver.
[2025-06-02 13:38:24] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:38:26] debug: [extractByIA] Resultado IA: Desculpe, precisarei de mais informa√ß√µes para responder √† sua pergunta. Qual servi√ßo espec√≠fico o cliente est√° interessado?
[2025-06-02 13:38:26] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:38:28] debug: [extractByIA] Resultado IA: O texto fornecido n√£o fornece informa√ß√µes suficientes para determinar o n√≠vel de urg√™ncia do cliente.
[2025-06-02 13:38:28] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:38:31] debug: [extractByIA] Resultado IA: Com base nessa resposta, parece que o cliente est√° no est√°gio de d√∫vida ou incerteza, pois ele n√£o deu informa√ß√µes suficientes ou fez perguntas espec√≠ficas para prosseguir.
[2025-06-02 13:38:31] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:38:34] debug: [extractByIA] Resultado IA: A obje√ß√£o apresentada pelo cliente aqui poderia ser interpretada como uma quest√£o de valor. Ele pode sentir que o produto ou servi√ßo oferecido n√£o atende plenamente √†s suas necessidades ou expectativas.
[2025-06-02 13:38:34] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:38:36] debug: [extractByIA] Resultado IA: N√£o
[2025-06-02 13:38:36] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:38:38] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o especifica uma prefer√™ncia de agendamento. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:38:38] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:38:40] debug: [extractByIA] Resultado IA: O exemplo fornecido n√£o inclui informa√ß√µes sobre a disponibilidade de hor√°rio do cliente. Por favor, forne√ßa mais informa√ß√µes.
[2025-06-02 13:38:40] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:38:42] debug: [extractByIA] Resultado IA: O cliente acha que a oferta ou o servi√ßo √© insuficiente ou inexpressivo.
[2025-06-02 13:38:42] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:38:44] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:38:44] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882324380
[2025-06-02 13:38:44] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDJFMkQzREEyMUYxQUYyMDcwRDg1NDhCQjYyMDYwNUJGAA==",
                "timestamp": "1748882321",
                "text": {
                  "body": "S√≥ isso?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:38:44] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:38:44] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882324380
[2025-06-02 13:38:44] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDJFMkQzREEyMUYxQUYyMDcwRDg1NDhCQjYyMDYwNUJGAA==
[2025-06-02 13:38:44] debug: [extractByIA] Resultado IA: A entrada fornecida n√£o apresenta uma oferta principal nem uma alternativa proposta pelo cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:38:44] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:38:46] debug: [extractByIA] Resultado IA: A sua pergunta n√£o cont√©m qualquer informa√ß√£o a respeito de um desconto. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:38:46] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:38:46] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:38:48] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou nenhum m√©todo de pagamento em sua declara√ß√£o.
[2025-06-02 13:38:48] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:38:49] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:38:49] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:38:51] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu informa√ß√µes sobre uma pessoa ou contato. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:38:51] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 33 mensagens.
[2025-06-02 13:38:51] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:38:51] info: [validadorMultiplos] [exec-1748882299177] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'objecoes'
[2025-06-02 13:38:51] info: [validadorMultiplos] [exec-1748882299177] üß© Validando metas da etapa: objecoes
[2025-06-02 13:38:51] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:38:51] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:38:51] info: [validadorMultiplos] [exec-1748882299177] Campo 'objection_type' j√° est√° preenchido: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.. Pulando.
[2025-06-02 13:38:51] info: [validadorMultiplos] [exec-1748882299177] Campo 'motivo_obje√ß√£o' j√° est√° preenchido: O cliente est√° preocupado com o custo do procedimento.. Pulando.
[2025-06-02 13:38:51] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:38:52] debug: [extractByIA] Resultado IA: Desculpe, a pergunta n√£o forneceu uma op√ß√£o alternativa apresentada pelo cliente.
[2025-06-02 13:38:52] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:38:52] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "alternativa"
[2025-06-02 13:38:52] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, a pergunta n√£o forneceu uma op√ß√£o alternativa apresentada pelo cliente."
[2025-06-02 13:38:52] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "S√≥ isso?"
[2025-06-02 13:38:52] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:38:53] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-06-02 13:38:53] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 795ms
[2025-06-02 13:38:53] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "alternativa",
  "valor": "Desculpe, a pergunta n√£o forneceu uma op√ß√£o alternativa apresentada pelo cliente.",
  "contexto": "S√≥ isso?",
  "resposta": "n√£o",
  "tempo_ms": 795,
  "validado": false
}
[2025-06-02 13:38:53] warn: [validadorMultiplos] [exec-1748882299177] ‚ùå Campo 'alternativa' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:38:53] info: [ClientRepository] Atualizando campo alternativa para 5512988256404: null
[2025-06-02 13:38:53] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:38:53] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | alternativa
[2025-06-02 13:38:53] debug: [validadorMultiplos] [exec-1748882299177] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'alternativa': 2670.08ms
[2025-06-02 13:38:53] info: [validadorMultiplos] [exec-1748882299177] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'objecoes'
[2025-06-02 13:38:53] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:38:53] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados S√≥ isso? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:38:54] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:38:54] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:38:54] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:38:54] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:38:54] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:38:54] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:38:54] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:38:54] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:38:54] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:38:54] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:38:54] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:38:54] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:38:54] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:38:54] info: [temperatura] üîç Calculando temperatura com base na etapa "objecoes" e perfil do cliente
[2025-06-02 13:38:54] warn: [temperatura] Etapa desconhecida: "objecoes". Usando base padr√£o: 0.7
[2025-06-02 13:38:54] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:38:54] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:38:54] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:38:54] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:38:54] info: [temperatura] ‚úÖ Temperatura final calculada: 0.75
[2025-06-02 13:38:56] info: [handleMessage] [exec-1748882299177] üîç Texto bruto da IA antes do filtro: √â natural avaliar as op√ß√µes quando se trata de um investimento em si mesmo. Gostaria de saber o que mais poderia te ajudar a tomar uma decis√£o?
[2025-06-02 13:38:56] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:38:56] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa objecoes, phone=5512988256404
[2025-06-02 13:38:56] info: [handleMessage] [exec-1748882299177] ‚úÖ Texto final p√≥s-processado: √â natural avaliar as op√ß√µes quando se trata de um investimento em si mesmo. Gostaria de saber o que mais poderia te ajudar a tomar uma decis√£o?
[2025-06-02 13:38:56] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:38:56] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:38:56] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:38:56] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4510ms
[2025-06-02 13:39:01] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:39:01] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "√â natural avaliar as op√ß√µes quando se trata de um investimento em si mesmo. Gostaria de saber o que mais poderia te ajudar a tomar uma decis√£o?" Timestamp=1748882341069
[2025-06-02 13:39:01] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:39:01] debug: [whatsapp] Conte√∫do da mensagem: "√â natural avaliar as op√ß√µes quando se trata de um investimento em si mesmo. Gostaria de saber o que mais poderia te ajudar a tomar uma decis√£o?"
[2025-06-02 13:39:01] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "√â natural avaliar as op√ß√µes quando se trata de um investimento em si mesmo. Gostaria de saber o que mais poderia te ajudar a tomar uma decis√£o?"
  }
}
[2025-06-02 13:39:01] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:39:01] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:39:01] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhBNzU2OUY2MzRCOEYwOUYwQQA="
    }
  ]
}
[2025-06-02 13:39:01] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:39:02] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:39:02] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882342890
[2025-06-02 13:39:02] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhBNzU2OUY2MzRCOEYwOUYwQQA=",
                "status": "sent",
                "timestamp": "1748882365",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:39:02] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:39:02] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:39:02] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882342936
[2025-06-02 13:39:02] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhBNzU2OUY2MzRCOEYwOUYwQQA=",
                "status": "delivered",
                "timestamp": "1748882365",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:39:02] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:40:32] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:40:32] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882432239
[2025-06-02 13:40:32] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDcxNjM0NDM3M0JCQkY4QjI3MTdBRjFBQkMxQThCNkQ1AA==",
                "timestamp": "1748882454",
                "text": {
                  "body": "Acabei n√£o perguntando seu nome üòÖ"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:40:32] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:40:32] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882432239
[2025-06-02 13:40:32] debug: [webhook] Texto recebido: Acabei n√£o perguntando seu nome üòÖ
[2025-06-02 13:40:32] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Acabei n√£o perguntando seu nome üòÖ"
[2025-06-02 13:40:32] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882432251) para 5512988256404
[2025-06-02 13:40:32] debug: [handleMessage] [exec-1748882432251] üì≤ Iniciando atendimento: phone=5512988256404, texto="Acabei n√£o perguntando seu nome üòÖ", isAudio=false
[2025-06-02 13:40:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:40:32] info: [handleMessage] [exec-1748882432251] Estado atual do cliente: objecoes
[2025-06-02 13:40:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:40:32] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:40:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:40:32] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:40:32] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:40:32] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:40:32] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:40:32] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "objecoes",
  "userMessage": "Acabei n√£o perguntando seu nome üòÖ"
}
[2025-06-02 13:40:32] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: objecoes\nMensagem do cliente: Acabei n√£o pergun"
    }
  ]
}
[2025-06-02 13:40:33] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-06-02 13:40:33] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 430,
    "completion_tokens": 3,
    "total_tokens": 433,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:40:33] info: [aiStateDecider] üß≠ Etapa atual: objecoes ‚Äî IA sugeriu: negociacao
[2025-06-02 13:40:33] info: [handleMessage] [exec-1748882432251] Estado sugerido pela IA: negociacao
[2025-06-02 13:40:33] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-06-02 13:40:33] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-06-02 13:40:33] info: [handleMessage] [exec-1748882432251] Estado atualizado: objecoes ‚Üí negociacao
[2025-06-02 13:40:33] debug: [handleMessage] [exec-1748882432251] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:40:33] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:40:33] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:40:33] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:40:33] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:40:33] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:40:33] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:40:33] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:40:33] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:40:33] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:40:33] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:40:33] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:40:36] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:40:36] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:40:38] debug: [extractByIA] Resultado IA: Voc√™ precisa fornecer mais informa√ß√µes para que eu possa fornecer uma resposta precisa. O que √© exatamente o servi√ßo em quest√£o?
[2025-06-02 13:40:38] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:40:40] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi mencionado nesta declara√ß√£o.
[2025-06-02 13:40:40] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:40:42] debug: [extractByIA] Resultado IA: Como a informa√ß√£o fornecida n√£o se refere diretamente ao status de um cliente em um processo de vendas, n√£o √© poss√≠vel identificar em que est√°gio o cliente est√°.
[2025-06-02 13:40:42] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:40:45] debug: [extractByIA] Resultado IA: O cliente n√£o apresentou uma obje√ß√£o. Esta entrada diz respeito √† falha na comunica√ß√£o/incorre√ß√£o do vendedor que esqueceu de perguntar o nome do cliente.
[2025-06-02 13:40:45] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:40:46] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:40:46] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:40:48] debug: [extractByIA] Resultado IA: O texto fornecido n√£o cont√©m informa√ß√µes sobre a prefer√™ncia de agendamento do cliente.
[2025-06-02 13:40:48] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:40:50] debug: [extractByIA] Resultado IA: A disponibilidade de hor√°rio do cliente n√£o foi mencionada na mensagem.
[2025-06-02 13:40:50] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:40:51] debug: [extractByIA] Resultado IA: O assistente n√£o forneceu o motivo da obje√ß√£o do cliente.
[2025-06-02 13:40:51] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:40:53] debug: [extractByIA] Resultado IA: Desculpe, mas parece n√£o haver uma alternativa proposta pelo cliente neste caso. Voc√™ poderia fornecer mais contexto?
[2025-06-02 13:40:53] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:40:54] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° informa√ß√µes sobre o valor percentual de desconto na sua pergunta.
[2025-06-02 13:40:54] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:40:54] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:40:56] debug: [extractByIA] Resultado IA: O texto fornecido n√£o menciona uma forma de pagamento.
[2025-06-02 13:40:56] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:40:57] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:40:57] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882457436
[2025-06-02 13:40:57] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDcxNjM0NDM3M0JCQkY4QjI3MTdBRjFBQkMxQThCNkQ1AA==",
                "timestamp": "1748882454",
                "text": {
                  "body": "Acabei n√£o perguntando seu nome üòÖ"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:40:57] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:40:57] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882457436
[2025-06-02 13:40:57] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDcxNjM0NDM3M0JCQkY4QjI3MTdBRjFBQkMxQThCNkQ1AA==
[2025-06-02 13:40:58] debug: [extractByIA] Resultado IA: Desculpe, mas essa informa√ß√£o n√£o confirma se o cliente fechou o neg√≥cio. Por favor, tente novamente.
[2025-06-02 13:40:58] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:41:00] debug: [extractByIA] Resultado IA: Desculpe, sou um assistente virtual e n√£o tenho um nome espec√≠fico. Como posso ajud√°-lo hoje?
[2025-06-02 13:41:00] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 34 mensagens.
[2025-06-02 13:41:00] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:41:00] info: [validadorMultiplos] [exec-1748882432251] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-06-02 13:41:00] info: [validadorMultiplos] [exec-1748882432251] üß© Validando metas da etapa: negociacao
[2025-06-02 13:41:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:41:00] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:41:00] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:41:00] debug: [validadorMultiplos] [exec-1748882432251] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-06-02 13:41:00] debug: [validadorMultiplos] [exec-1748882432251] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 2.58ms
[2025-06-02 13:41:00] info: [validadorMultiplos] [exec-1748882432251] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-06-02 13:41:00] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:41:02] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o inclui informa√ß√µes sobre um desconto percentual.
[2025-06-02 13:41:02] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:41:02] debug: [validadorMultiplos] [exec-1748882432251] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-06-02 13:41:02] debug: [validadorMultiplos] [exec-1748882432251] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 2166.61ms
[2025-06-02 13:41:02] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:41:03] debug: [extractByIA] Resultado IA: O texto n√£o menciona uma forma de pagamento.
[2025-06-02 13:41:03] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:41:03] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-06-02 13:41:03] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O texto n√£o menciona uma forma de pagamento."
[2025-06-02 13:41:03] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Acabei n√£o perguntando seu nome üòÖ"
[2025-06-02 13:41:03] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:41:04] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:41:04] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 701ms
[2025-06-02 13:41:04] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O texto n√£o menciona uma forma de pagamento.",
  "contexto": "Acabei n√£o perguntando seu nome üòÖ",
  "resposta": "n√£o.",
  "tempo_ms": 701,
  "validado": false
}
[2025-06-02 13:41:04] warn: [validadorMultiplos] [exec-1748882432251] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:41:04] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-06-02 13:41:04] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:41:04] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-06-02 13:41:04] debug: [validadorMultiplos] [exec-1748882432251] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 1687.27ms
[2025-06-02 13:41:04] info: [validadorMultiplos] [exec-1748882432251] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-06-02 13:41:04] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:41:04] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Acabei n√£o perguntando seu nome üòÖ {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:41:05] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:41:05] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:41:05] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:41:05] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:41:05] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:41:05] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:41:05] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:41:05] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:41:05] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:41:05] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:41:05] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:41:05] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:41:05] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:41:05] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-06-02 13:41:05] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-06-02 13:41:05] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:41:05] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:41:05] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:41:05] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:41:05] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-06-02 13:41:07] info: [handleMessage] [exec-1748882432251] üîç Texto bruto da IA antes do filtro: N√£o se preocupe, estou aqui para ajudar com o que precisar. Em rela√ß√£o ao procedimento de micropigmenta√ß√£o de barba, h√° mais alguma informa√ß√£o ou detalhe que gostaria de saber?
[2025-06-02 13:41:07] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:41:07] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-06-02 13:41:07] info: [handleMessage] [exec-1748882432251] ‚úÖ Texto final p√≥s-processado: N√£o se preocupe, estou aqui para ajudar com o que precisar. Em rela√ß√£o ao procedimento de micropigmenta√ß√£o de barba, h√° mais alguma informa√ß√£o ou detalhe que gostaria de saber?
[2025-06-02 13:41:07] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:41:07] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:41:07] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:41:07] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6251ms
[2025-06-02 13:41:14] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:41:14] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "N√£o se preocupe, estou aqui para ajudar com o que precisar. Em rela√ß√£o ao procedimento de micropigmenta√ß√£o de barba, h√° mais alguma informa√ß√£o ou detalhe que gostaria de saber?" Timestamp=1748882474202
[2025-06-02 13:41:14] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:41:14] debug: [whatsapp] Conte√∫do da mensagem: "N√£o se preocupe, estou aqui para ajudar com o que precisar. Em rela√ß√£o ao procedimento de micropigmenta√ß√£o de barba, h√° mais alguma informa√ß√£o ou detalhe que gostaria de saber?"
[2025-06-02 13:41:14] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "N√£o se preocupe, estou aqui para ajudar com o que precisar. Em rela√ß√£o ao procedimento de micropigmenta√ß√£o de barba, h√° mais alguma informa√ß√£o ou detalhe que gostaria de saber?"
  }
}
[2025-06-02 13:41:14] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:41:15] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:41:15] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkIyNjJFNUE1QTNBMzcxQUVCRQA="
    }
  ]
}
[2025-06-02 13:41:15] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:41:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:41:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882476072
[2025-06-02 13:41:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkIyNjJFNUE1QTNBMzcxQUVCRQA=",
                "status": "sent",
                "timestamp": "1748882498",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:41:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:41:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:41:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882476319
[2025-06-02 13:41:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkIyNjJFNUE1QTNBMzcxQUVCRQA=",
                "status": "delivered",
                "timestamp": "1748882498",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:41:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:41:56] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:41:56] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882516719
[2025-06-02 13:41:56] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCRjBDRTU4QkFCODA4REVDN0MwQzlDNTIwMzA3Mjk1AA==",
                "timestamp": "1748882538",
                "text": {
                  "body": "Como vc se chama?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:41:56] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:41:56] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882516719
[2025-06-02 13:41:56] debug: [webhook] Texto recebido: Como vc se chama?
[2025-06-02 13:41:56] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Como vc se chama?"
[2025-06-02 13:41:56] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882516743) para 5512988256404
[2025-06-02 13:41:56] debug: [handleMessage] [exec-1748882516743] üì≤ Iniciando atendimento: phone=5512988256404, texto="Como vc se chama?", isAudio=false
[2025-06-02 13:41:56] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:41:56] info: [handleMessage] [exec-1748882516743] Estado atual do cliente: negociacao
[2025-06-02 13:41:56] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:41:56] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:41:56] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:41:56] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:41:56] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:41:56] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:41:56] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:41:56] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Como vc se chama?"
}
[2025-06-02 13:41:56] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Como vc se cham"
    }
  ]
}
[2025-06-02 13:41:58] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-06-02 13:41:58] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 424,
    "completion_tokens": 3,
    "total_tokens": 427,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:41:58] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: negociacao
[2025-06-02 13:41:58] info: [handleMessage] [exec-1748882516743] Estado sugerido pela IA: negociacao
[2025-06-02 13:41:58] debug: [ClientRepository] Atualizando retries para 5512988256404: 1
[2025-06-02 13:41:58] info: [ClientRepository] retries atualizado para 1 no cliente 5512988256404
[2025-06-02 13:41:58] debug: [handleMessage] [exec-1748882516743] Repeti√ß√£o detectada. Retries incrementado para 1
[2025-06-02 13:41:58] debug: [handleMessage] [exec-1748882516743] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:41:58] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:41:58] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:41:58] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:41:58] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:41:58] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:41:58] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:41:58] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:41:58] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:41:58] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:41:58] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:41:58] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:42:00] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o cont√©m detalhes sobre as solu√ß√µes que um cliente tentou anteriormente. Por favor, forne√ßa as informa√ß√µes adequadas.
[2025-06-02 13:42:00] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:42:02] debug: [extractByIA] Resultado IA: Meu nome √© OpenAI, sou uma intelig√™ncia artificial desenvolvida para auxiliar e responder perguntas!
[2025-06-02 13:42:02] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:42:03] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o permite determinar o n√≠vel de urg√™ncia do cliente.
[2025-06-02 13:42:03] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:42:06] debug: [extractByIA] Resultado IA: Este coment√°rio indica que cliente ainda est√° na fase de "interesse".
[2025-06-02 13:42:06] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:42:09] debug: [extractByIA] Resultado IA: A obje√ß√£o apresentada pelo cliente n√£o est√° relacionada a pre√ßo, tempo ou confian√ßa, mas sim a informa√ß√µes pessoais sobre o vendedor.
[2025-06-02 13:42:09] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:42:11] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o permite determinar uma inten√ß√£o de compra. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:11] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:42:12] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:12] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882532788
[2025-06-02 13:42:12] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDBFMUMwNUZEMDJEMkE0MTkzNTEyQjM1MkIwRjQ3RUQ2AA==",
                "timestamp": "1748882554",
                "text": {
                  "body": "ü§î"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:12] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:42:12] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882532788
[2025-06-02 13:42:12] debug: [webhook] Texto recebido: ü§î
[2025-06-02 13:42:12] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "ü§î"
[2025-06-02 13:42:12] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882532801) para 5512988256404
[2025-06-02 13:42:12] debug: [handleMessage] [exec-1748882532801] üì≤ Iniciando atendimento: phone=5512988256404, texto="ü§î", isAudio=false
[2025-06-02 13:42:12] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:12] info: [handleMessage] [exec-1748882532801] Estado atual do cliente: negociacao
[2025-06-02 13:42:12] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:12] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:42:12] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:12] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:42:12] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:42:12] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:42:12] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:42:12] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "ü§î"
}
[2025-06-02 13:42:12] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: ü§î\nüìå DADOS J√Å "
    }
  ]
}
[2025-06-02 13:42:13] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-06-02 13:42:13] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 422,
    "completion_tokens": 3,
    "total_tokens": 425,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:42:13] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-06-02 13:42:13] info: [handleMessage] [exec-1748882532801] Estado sugerido pela IA: fechamento
[2025-06-02 13:42:13] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-06-02 13:42:13] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-06-02 13:42:13] info: [handleMessage] [exec-1748882532801] Estado atualizado: negociacao ‚Üí fechamento
[2025-06-02 13:42:13] debug: [handleMessage] [exec-1748882532801] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:42:13] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:42:13] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:42:13] debug: [extractByIA] Resultado IA: Desculpe, como um assistente de intelig√™ncia artificial, n√£o tenho prefer√™ncias de agendamento. Minha fun√ß√£o √© ajudar a entender as suas. Voc√™ poderia fornecer suas prefer√™ncias de agendamento?
[2025-06-02 13:42:13] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:42:14] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:42:14] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:42:14] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:14] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:14] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:42:14] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:42:14] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:42:14] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:42:14] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:42:15] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° disponibilidade de hor√°rio mencionada nesta frase.
[2025-06-02 13:42:15] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:42:16] debug: [extractByIA] Resultado IA: O cliente est√° buscando saber o nome do atendente.
[2025-06-02 13:42:16] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:42:17] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o foi mencionado qualquer oferta ou alternativa nesta frase. Pode fornecer mais detalhes?
[2025-06-02 13:42:17] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:42:18] debug: [extractByIA] Resultado IA: Como um assistente IA, preciso de um contexto ou uma situa√ß√£o espec√≠fica para responder √† pergunta. Por exemplo, uma descri√ß√£o de um problema que um cliente est√° enfrentando e as a√ß√µes que ele j√° tentou para resolver isso. Por favor, forne√ßa mais informa√ß√µes para que eu possa te ajudar melhor.
[2025-06-02 13:42:18] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:42:19] debug: [extractByIA] Resultado IA: Desculpe, mas sua pergunta n√£o cont√©m um valor percentual de desconto para eu extrair.
[2025-06-02 13:42:19] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:42:19] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:42:21] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:21] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882541998
[2025-06-02 13:42:22] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCRjBDRTU4QkFCODA4REVDN0MwQzlDNTIwMzA3Mjk1AA==",
                "timestamp": "1748882538",
                "text": {
                  "body": "Como vc se chama?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:22] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:42:22] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882541998
[2025-06-02 13:42:22] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCRjBDRTU4QkFCODA4REVDN0MwQzlDNTIwMzA3Mjk1AA==
[2025-06-02 13:42:22] debug: [extractByIA] Resultado IA: Desculpe, eu n√£o posso responder a essa pergunta, pois nenhuma forma de pagamento foi mencionada. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:22] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:42:23] debug: [extractByIA] Resultado IA: Voc√™ n√£o mencionou qual √© o servi√ßo em quest√£o. Pode por favor fornecer mais detalhes? De maneira geral, um cliente geralmente espera que o servi√ßo atenda √†s suas necessidades, resolva seus problemas, seja de alta qualidade e que tenha um bom custo-benef√≠cio. Al√©m disso, pontualidade, aten√ß√£o ao cliente, profissionalismo e efici√™ncia s√£o aspectos valorizados.
[2025-06-02 13:42:23] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:42:24] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o est√° relacionada √† pergunta. Por favor, confirme se o cliente confirmou o fechamento.
[2025-06-02 13:42:24] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:42:24] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:24] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882544873
[2025-06-02 13:42:24] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEZBMjRFNUE3NDI1MzdDMTc5NUMxMjk4Mzg4RjZERDI1AA==",
                "timestamp": "1748882566",
                "text": {
                  "body": "Que mist√©rio √© esse?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:24] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:42:24] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882544873
[2025-06-02 13:42:24] debug: [webhook] Texto recebido: Que mist√©rio √© esse?
[2025-06-02 13:42:24] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Que mist√©rio √© esse?"
[2025-06-02 13:42:24] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882544885) para 5512988256404
[2025-06-02 13:42:24] debug: [handleMessage] [exec-1748882544885] üì≤ Iniciando atendimento: phone=5512988256404, texto="Que mist√©rio √© esse?", isAudio=false
[2025-06-02 13:42:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:24] info: [handleMessage] [exec-1748882544885] Estado atual do cliente: fechamento
[2025-06-02 13:42:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:24] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:42:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:24] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:42:24] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:42:24] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:42:24] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:42:24] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Que mist√©rio √© esse?"
}
[2025-06-02 13:42:24] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Que mist√©rio √© "
    }
  ]
}
[2025-06-02 13:42:25] debug: [extractByIA] Resultado IA: Desculpe, mas para realizar a a√ß√£o solicitada, preciso que voc√™ fornecesse um contexto ou uma situa√ß√£o espec√≠fica na qual posso avaliar o n√≠vel de urg√™ncia do cliente.
[2025-06-02 13:42:25] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:42:25] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-06-02 13:42:25] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 426,
    "completion_tokens": 3,
    "total_tokens": 429,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:42:25] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: negociacao
[2025-06-02 13:42:25] info: [handleMessage] [exec-1748882544885] Estado sugerido pela IA: negociacao
[2025-06-02 13:42:25] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-06-02 13:42:25] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-06-02 13:42:25] info: [handleMessage] [exec-1748882544885] Estado atualizado: fechamento ‚Üí negociacao
[2025-06-02 13:42:25] debug: [handleMessage] [exec-1748882544885] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:42:25] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:42:25] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:42:26] debug: [extractByIA] Resultado IA: Desculpe pela confus√£o, mas como um assistente de intelig√™ncia artificial, eu n√£o tenho um nome. Estou aqui para ajudar com suas perguntas e tarefas.
[2025-06-02 13:42:26] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 35 mensagens.
[2025-06-02 13:42:26] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:42:26] info: [validadorMultiplos] [exec-1748882516743] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-06-02 13:42:26] info: [validadorMultiplos] [exec-1748882516743] üß© Validando metas da etapa: negociacao
[2025-06-02 13:42:26] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:26] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:42:26] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:26] debug: [validadorMultiplos] [exec-1748882516743] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-06-02 13:42:26] debug: [validadorMultiplos] [exec-1748882516743] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 3.21ms
[2025-06-02 13:42:26] info: [validadorMultiplos] [exec-1748882516743] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-06-02 13:42:26] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:42:27] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:42:27] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:42:27] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:27] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:27] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:42:27] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:42:27] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:42:27] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:42:27] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:42:28] debug: [extractByIA] Resultado IA: A informa√ß√£o solicitada n√£o cont√©m um valor percentual de desconto.
[2025-06-02 13:42:28] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:42:28] debug: [validadorMultiplos] [exec-1748882516743] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-06-02 13:42:28] debug: [validadorMultiplos] [exec-1748882516743] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1334.86ms
[2025-06-02 13:42:28] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:42:28] debug: [extractByIA] Resultado IA: Com base no emoticon fornecido, parece que o cliente est√° no est√°gio de "d√∫vida".
[2025-06-02 13:42:28] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:42:29] debug: [extractByIA] Resultado IA: Essa frase n√£o menciona uma forma de pagamento.
[2025-06-02 13:42:29] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:42:29] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-06-02 13:42:29] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Essa frase n√£o menciona uma forma de pagamento."
[2025-06-02 13:42:29] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Como vc se chama?"
[2025-06-02 13:42:29] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:42:29] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-06-02 13:42:29] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 579ms
[2025-06-02 13:42:29] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "Essa frase n√£o menciona uma forma de pagamento.",
  "contexto": "Como vc se chama?",
  "resposta": "n√£o",
  "tempo_ms": 579,
  "validado": false
}
[2025-06-02 13:42:29] warn: [validadorMultiplos] [exec-1748882516743] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:42:29] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-06-02 13:42:29] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:42:29] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-06-02 13:42:29] debug: [validadorMultiplos] [exec-1748882516743] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 1832.43ms
[2025-06-02 13:42:29] info: [validadorMultiplos] [exec-1748882516743] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-06-02 13:42:29] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:42:29] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Como vc se chama? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:42:30] debug: [extractByIA] Resultado IA: Como assistente, preciso de mais informa√ß√µes para responder √† pergunta. Por favor, forne√ßa detalhes ou um contexto mais espec√≠fico.
[2025-06-02 13:42:30] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:42:30] debug: [extractByIA] Resultado IA: Desculpe, mas eu preciso de mais informa√ß√µes para fornecer uma resposta adequada. A pergunta n√£o fornece detalhes sobre nenhum problema ou solu√ß√£o que um cliente possa ter tentado.
[2025-06-02 13:42:30] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:42:30] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:42:30] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:42:30] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:42:30] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:42:30] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:30] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:42:30] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:42:30] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:42:30] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:42:30] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:42:30] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:42:30] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:42:30] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:42:30] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-06-02 13:42:30] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-06-02 13:42:30] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:42:30] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:42:30] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:42:30] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:42:30] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-06-02 13:42:31] debug: [extractByIA] Resultado IA: Sua resposta √© amb√≠gua. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:31] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:42:32] debug: [extractByIA] Resultado IA: Desculpe, eu sou uma intelig√™ncia artificial e n√£o entendi a pergunta. Voc√™ poderia especificar qual servi√ßo voc√™ est√° se referindo? Isso ajudar√° a fornecer uma resposta mais precisa.
[2025-06-02 13:42:32] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:42:33] info: [handleMessage] [exec-1748882516743] üîç Texto bruto da IA antes do filtro: Sou o assistente virtual da barbearia O MOTIM, pronto para ajudar com suas d√∫vidas sobre a micropigmenta√ß√£o de barba. Como posso auxili√°-lo hoje?
[2025-06-02 13:42:33] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:42:33] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-06-02 13:42:33] info: [handleMessage] [exec-1748882516743] ‚úÖ Texto final p√≥s-processado: Sou o assistente virtual da barbearia O MOTIM, pronto para ajudar com suas d√∫vidas sobre a micropigmenta√ß√£o de barba. Como posso auxili√°-lo hoje?
[2025-06-02 13:42:33] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:42:33] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:42:33] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:42:33] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4634ms
[2025-06-02 13:42:34] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o pode ser determinado a partir desta declara√ß√£o.
[2025-06-02 13:42:34] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:42:34] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o consegui ver nenhuma informa√ß√£o na sua mensagem. Por favor, forne√ßa o texto a partir do qual devo extrair a prefer√™ncia de agendamento.
[2025-06-02 13:42:34] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:42:36] debug: [extractByIA] Resultado IA: O cliente parece estar no est√°gio de d√∫vida, precisando de mais informa√ß√µes esclarecedoras sobre o produto ou servi√ßo.
[2025-06-02 13:42:36] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:42:36] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° nenhuma informa√ß√£o fornecida sobre a disponibilidade de hor√°rio do cliente no seu texto.
[2025-06-02 13:42:36] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:42:37] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:42:37] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Sou o assistente virtual da barbearia O MOTIM, pronto para ajudar com suas d√∫vidas sobre a micropigmenta√ß√£o de barba. Como posso auxili√°-lo hoje?" Timestamp=1748882557798
[2025-06-02 13:42:37] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:42:37] debug: [whatsapp] Conte√∫do da mensagem: "Sou o assistente virtual da barbearia O MOTIM, pronto para ajudar com suas d√∫vidas sobre a micropigmenta√ß√£o de barba. Como posso auxili√°-lo hoje?"
[2025-06-02 13:42:37] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Sou o assistente virtual da barbearia O MOTIM, pronto para ajudar com suas d√∫vidas sobre a micropigmenta√ß√£o de barba. Como posso auxili√°-lo hoje?"
  }
}
[2025-06-02 13:42:37] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:42:37] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:37] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882557876
[2025-06-02 13:42:37] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDBFMUMwNUZEMDJEMkE0MTkzNTEyQjM1MkIwRjQ3RUQ2AA==",
                "timestamp": "1748882554",
                "text": {
                  "body": "ü§î"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:37] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:42:37] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882557876
[2025-06-02 13:42:37] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDBFMUMwNUZEMDJEMkE0MTkzNTEyQjM1MkIwRjQ3RUQ2AA==
[2025-06-02 13:42:38] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:42:38] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhGRkYzMkM4RjY1MjI4QkFERgA="
    }
  ]
}
[2025-06-02 13:42:38] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:42:39] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu nenhuma informa√ß√£o ou contexto para extrair um motivo de obje√ß√£o do cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:39] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:42:39] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:39] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882559565
[2025-06-02 13:42:39] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhGRkYzMkM4RjY1MjI4QkFERgA=",
                "status": "sent",
                "timestamp": "1748882581",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:39] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:42:39] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:39] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882559672
[2025-06-02 13:42:39] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhGRkYzMkM4RjY1MjI4QkFERgA=",
                "status": "delivered",
                "timestamp": "1748882582",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:39] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:42:40] debug: [extractByIA] Resultado IA: A obje√ß√£o apresentada pelo cliente n√£o est√° claramente indicada na pergunta. No entanto, isso poderia ser interpretado como uma obje√ß√£o de 'confus√£o' ou 'falta de entendimento' em rela√ß√£o ao produto, servi√ßo ou proposta que est√° sendo discutida.
[2025-06-02 13:42:40] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:42:41] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:42:41] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:42:42] debug: [extractByIA] Resultado IA: Desculpe, esta solicita√ß√£o n√£o forneceu uma situa√ß√£o ou contexto espec√≠fico para que eu possa ajudar a determinar a alternativa proposta pelo cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:42] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:42:43] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre a prefer√™ncia de agendamento do cliente.
[2025-06-02 13:42:43] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:42:44] debug: [extractByIA] Resultado IA: Sua solicita√ß√£o n√£o inclui um valor percentual de desconto. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:44] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:42:44] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:42:45] debug: [extractByIA] Resultado IA: Desculpe, sua mensagem n√£o cont√©m informa√ß√µes sobre a disponibilidade de hor√°rio. Por gentileza, pode fornecer mais informa√ß√µes?
[2025-06-02 13:42:45] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:42:45] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o foi mencionada nenhuma forma de pagamento na mensagem anterior.
[2025-06-02 13:42:45] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:42:47] debug: [extractByIA] Resultado IA: O cliente est√° confuso ou n√£o entendeu algo.
[2025-06-02 13:42:47] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:42:47] debug: [extractByIA] Resultado IA: Desculpe, sua resposta est√° incerta. Por favor, confirme se o cliente fechou o neg√≥cio.
[2025-06-02 13:42:47] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:42:49] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:49] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882569844
[2025-06-02 13:42:49] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEZBMjRFNUE3NDI1MzdDMTc5NUMxMjk4Mzg4RjZERDI1AA==",
                "timestamp": "1748882566",
                "text": {
                  "body": "Que mist√©rio √© esse?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:49] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:42:49] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882569844
[2025-06-02 13:42:49] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEZBMjRFNUE3NDI1MzdDMTc5NUMxMjk4Mzg4RjZERDI1AA==
[2025-06-02 13:42:50] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o posso realizar essa tarefa j√° que n√£o recebi informa√ß√µes suficientes. Por favor, indicar a pessoa cujo nome ou contato eu devo extrair.
[2025-06-02 13:42:50] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 36 mensagens.
[2025-06-02 13:42:50] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:42:50] debug: [handleMessage] [exec-1748882532801] Validando checklist de fechamento...
[2025-06-02 13:42:50] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-06-02 13:42:50] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-06-02 13:42:50] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-06-02 13:42:50] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-06-02 13:42:50] warn: [conversationManager] [exec-1748882532801] ‚ùå Fechamento bloqueado ‚Äî campos ausentes ou contradit√≥rios: address, schedule_time, confirmacao
[2025-06-02 13:42:50] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5059ms
[2025-06-02 13:42:51] debug: [extractByIA] Resultado IA: Desculpe, mas sua solicita√ß√£o n√£o inclui uma oferta principal ou uma alternativa proposta. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:42:51] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:42:53] debug: [extractByIA] Resultado IA: Desculpe, sua entrada n√£o parece incluir informa√ß√µes sobre um desconto percentual. Por favor, forne√ßa mais informa√ß√µes.
[2025-06-02 13:42:53] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:42:53] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:42:54] debug: [extractByIA] Resultado IA: O texto n√£o menciona nenhuma forma de pagamento.
[2025-06-02 13:42:54] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:42:56] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:42:56] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üö´ Ainda n√£o posso encerrar seu atendimento.
Faltam os seguintes dados: address, schedule_time, confirmacao.
Vamos resolver isso antes de seguir para o fechamento. üòâ" Timestamp=1748882576063
[2025-06-02 13:42:56] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:42:56] debug: [whatsapp] Conte√∫do da mensagem: "üö´ Ainda n√£o posso encerrar seu atendimento.
Faltam os seguintes dados: address, schedule_time, confirmacao.
Vamos resolver isso antes de seguir para o fechamento. üòâ"
[2025-06-02 13:42:56] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üö´ Ainda n√£o posso encerrar seu atendimento.\nFaltam os seguintes dados: address, schedule_time, confirmacao.\nVamos resolver isso antes de seguir para o fechamento. üòâ"
  }
}
[2025-06-02 13:42:56] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:42:56] debug: [extractByIA] Resultado IA: Desculpe, mas eu n√£o posso confirmar que o cliente fechou com base nas informa√ß√µes fornecidas.
[2025-06-02 13:42:56] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:42:56] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:42:56] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkRGNDMzODk2MTFCNTREMjY5QwA="
    }
  ]
}
[2025-06-02 13:42:56] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:42:57] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:57] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882577808
[2025-06-02 13:42:57] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkRGNDMzODk2MTFCNTREMjY5QwA=",
                "status": "sent",
                "timestamp": "1748882600",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:57] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:42:58] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu nenhuma informa√ß√£o sobre uma pessoa ou contato. Por favor, pode fornecer mais detalhes?
[2025-06-02 13:42:58] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 36 mensagens.
[2025-06-02 13:42:58] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:42:58] info: [validadorMultiplos] [exec-1748882544885] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-06-02 13:42:58] info: [validadorMultiplos] [exec-1748882544885] üß© Validando metas da etapa: negociacao
[2025-06-02 13:42:58] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:42:58] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:42:58] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:42:58] debug: [validadorMultiplos] [exec-1748882544885] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-06-02 13:42:58] debug: [validadorMultiplos] [exec-1748882544885] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 3.62ms
[2025-06-02 13:42:58] info: [validadorMultiplos] [exec-1748882544885] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-06-02 13:42:58] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:42:58] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:42:58] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882578385
[2025-06-02 13:42:58] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkRGNDMzODk2MTFCNTREMjY5QwA=",
                "status": "delivered",
                "timestamp": "1748882600",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:42:58] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:43:01] debug: [extractByIA] Resultado IA: Desculpe, mas sem um contexto ou uma frase adequada, n√£o posso fornecer o n√∫mero de desconto solicitado.
[2025-06-02 13:43:01] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:43:01] debug: [validadorMultiplos] [exec-1748882544885] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-06-02 13:43:01] debug: [validadorMultiplos] [exec-1748882544885] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 2922.00ms
[2025-06-02 13:43:01] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:43:03] debug: [extractByIA] Resultado IA: Desculpe, mas a sua mensagem n√£o indica nenhuma forma de pagamento. Por favor, forne√ßa mais informa√ß√µes.
[2025-06-02 13:43:03] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-06-02 13:43:03] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-06-02 13:43:03] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas a sua mensagem n√£o indica nenhuma forma de pagamento. Por favor, forne√ßa mais informa√ß√µes."
[2025-06-02 13:43:03] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Que mist√©rio √© esse?"
[2025-06-02 13:43:03] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-06-02 13:43:03] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-06-02 13:43:03] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 667ms
[2025-06-02 13:43:03] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "Desculpe, mas a sua mensagem n√£o indica nenhuma forma de pagamento. Por favor, forne√ßa mais informa√ß√µes.",
  "contexto": "Que mist√©rio √© esse?",
  "resposta": "n√£o.",
  "tempo_ms": 667,
  "validado": false
}
[2025-06-02 13:43:03] warn: [validadorMultiplos] [exec-1748882544885] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-06-02 13:43:03] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-06-02 13:43:03] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-06-02 13:43:03] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-06-02 13:43:03] debug: [validadorMultiplos] [exec-1748882544885] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 2635.54ms
[2025-06-02 13:43:03] info: [validadorMultiplos] [exec-1748882544885] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-06-02 13:43:03] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:43:03] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Que mist√©rio √© esse? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:43:04] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:43:04] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:43:04] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:43:04] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:43:04] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:43:04] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:43:04] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:43:04] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:43:04] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:43:04] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:43:04] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:43:04] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:43:04] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:43:04] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-06-02 13:43:04] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-06-02 13:43:04] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:43:04] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:43:04] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:43:04] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:43:04] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-06-02 13:43:07] info: [handleMessage] [exec-1748882544885] üîç Texto bruto da IA antes do filtro: A micropigmenta√ß√£o de barba oferece um visual cheio e sim√©trico, elevando sua autoestima e melhorando a imagem pessoal. O que exatamente est√° lhe deixando hesitante em rela√ß√£o ao procedimento?
[2025-06-02 13:43:07] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:43:07] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-06-02 13:43:07] info: [handleMessage] [exec-1748882544885] ‚úÖ Texto final p√≥s-processado: A micropigmenta√ß√£o de barba oferece um visual cheio e sim√©trico, elevando sua autoestima e melhorando a imagem pessoal. O que exatamente est√° lhe deixando hesitante em rela√ß√£o ao procedimento?
[2025-06-02 13:43:07] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:43:07] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:43:07] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:43:07] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6697ms
[2025-06-02 13:43:14] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:43:14] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "A micropigmenta√ß√£o de barba oferece um visual cheio e sim√©trico, elevando sua autoestima e melhorando a imagem pessoal. O que exatamente est√° lhe deixando hesitante em rela√ß√£o ao procedimento?" Timestamp=1748882594640
[2025-06-02 13:43:14] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:43:14] debug: [whatsapp] Conte√∫do da mensagem: "A micropigmenta√ß√£o de barba oferece um visual cheio e sim√©trico, elevando sua autoestima e melhorando a imagem pessoal. O que exatamente est√° lhe deixando hesitante em rela√ß√£o ao procedimento?"
[2025-06-02 13:43:14] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "A micropigmenta√ß√£o de barba oferece um visual cheio e sim√©trico, elevando sua autoestima e melhorando a imagem pessoal. O que exatamente est√° lhe deixando hesitante em rela√ß√£o ao procedimento?"
  }
}
[2025-06-02 13:43:14] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:43:15] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:43:15] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjk5NzkzQzY0NEFBNjMzREEwRAA="
    }
  ]
}
[2025-06-02 13:43:15] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:43:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:43:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882596365
[2025-06-02 13:43:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjk5NzkzQzY0NEFBNjMzREEwRAA=",
                "status": "sent",
                "timestamp": "1748882618",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:43:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:43:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:43:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882596553
[2025-06-02 13:43:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjk5NzkzQzY0NEFBNjMzREEwRAA=",
                "status": "delivered",
                "timestamp": "1748882618",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:43:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:44:39] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:44:39] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882679057
[2025-06-02 13:44:39] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCMDlDNjZFMDdGMkUwMkIwMDAyQUYwNTg1MkY3RkQ3AA==",
                "timestamp": "1748882701",
                "text": {
                  "body": "Condi√ß√µes de pagamento e descontos"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:44:39] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:44:39] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882679057
[2025-06-02 13:44:39] debug: [webhook] Texto recebido: Condi√ß√µes de pagamento e descontos
[2025-06-02 13:44:39] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Condi√ß√µes de pagamento e descontos"
[2025-06-02 13:44:39] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882679069) para 5512988256404
[2025-06-02 13:44:39] debug: [handleMessage] [exec-1748882679069] üì≤ Iniciando atendimento: phone=5512988256404, texto="Condi√ß√µes de pagamento e descontos", isAudio=false
[2025-06-02 13:44:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:44:39] info: [handleMessage] [exec-1748882679069] Estado atual do cliente: negociacao
[2025-06-02 13:44:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:44:39] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:44:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:44:39] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:44:39] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:44:39] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:44:39] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:44:39] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Condi√ß√µes de pagamento e descontos"
}
[2025-06-02 13:44:39] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Condi√ß√µes de pa"
    }
  ]
}
[2025-06-02 13:44:39] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "proposta"
}
[2025-06-02 13:44:39] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 428,
    "completion_tokens": 2,
    "total_tokens": 430,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:44:39] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: proposta
[2025-06-02 13:44:39] info: [handleMessage] [exec-1748882679069] Estado sugerido pela IA: proposta
[2025-06-02 13:44:39] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí proposta
[2025-06-02 13:44:39] debug: [ClientRepository] current_state atualizado para 'proposta' e retries resetado
[2025-06-02 13:44:39] info: [handleMessage] [exec-1748882679069] Estado atualizado: negociacao ‚Üí proposta
[2025-06-02 13:44:39] debug: [handleMessage] [exec-1748882679069] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:44:39] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:44:39] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:44:40] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:44:40] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:44:40] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:44:40] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:44:40] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:44:40] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:44:40] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:44:40] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:44:40] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:44:43] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o detalha quais solu√ß√µes o cliente tentou anteriormente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:44:43] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:44:49] debug: [extractByIA] Resultado IA: O cliente provavelmente est√° buscando um servi√ßo que possa oferecer a ele um bom custo-benef√≠cio. Ele gostaria de ter diversas op√ß√µes para realizar o pagamento, tais como pagamento √† vista, cart√£o de cr√©dito, boleto banc√°rio, parcelamento, entre outros. Al√©m disso, ele estaria interessado em obter descontos sempre que poss√≠vel, seja por meio de um programa de fidelidade, atrav√©s de uma compra em grande quantidade ou como um benef√≠cio de uma promo√ß√£o especial. O cliente estaria tamb√©m buscando transpar√™ncia na comunica√ß√£o sobre todos os custos envolvidos para que ele possa planejar adequadamente suas finan√ßas.
[2025-06-02 13:44:49] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:44:51] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi mencionado nesse contexto.
[2025-06-02 13:44:51] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:44:52] debug: [extractByIA] Resultado IA: O cliente est√° no est√°gio de decis√£o.
[2025-06-02 13:44:52] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:44:53] debug: [extractByIA] Resultado IA: Pre√ßo
[2025-06-02 13:44:53] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:44:54] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:44:54] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:44:56] debug: [extractByIA] Resultado IA: Desculpe, mas sua solicita√ß√£o n√£o parece indicar uma prefer√™ncia de agendamento. Por favor forne√ßa mais detalhes.
[2025-06-02 13:44:56] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:44:59] debug: [extractByIA] Resultado IA: Desculpe, a informa√ß√£o providenciada n√£o inclui a disponibilidade de hor√°rio do cliente. Por favor, forne√ßa um hor√°rio de disposi√ß√£o.
[2025-06-02 13:44:59] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:45:00] debug: [extractByIA] Resultado IA: O cliente est√° insatisfeito com as condi√ß√µes de pagamento e descontos oferecidos.
[2025-06-02 13:45:00] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:45:03] debug: [extractByIA] Resultado IA: Desculpe, mas eu preciso que voc√™ forne√ßa um exemplo completo de conversa ou situa√ß√£o para extrair a alternativa proposta pelo cliente.
[2025-06-02 13:45:03] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:45:04] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:45:04] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882704329
[2025-06-02 13:45:04] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCMDlDNjZFMDdGMkUwMkIwMDAyQUYwNTg1MkY3RkQ3AA==",
                "timestamp": "1748882701",
                "text": {
                  "body": "Condi√ß√µes de pagamento e descontos"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:45:04] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:45:04] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882704329
[2025-06-02 13:45:04] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdCMDlDNjZFMDdGMkUwMkIwMDAyQUYwNTg1MkY3RkQ3AA==
[2025-06-02 13:45:06] debug: [extractByIA] Resultado IA: Desculpe, n√£o consigo extrair um valor percentual de desconto da frase que voc√™ forneceu. Por favor, forne√ßa uma frase que indica claramente um desconto espec√≠fico. Por exemplo, "Desconto de 50% na sua pr√≥xima compra".
[2025-06-02 13:45:06] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:45:06] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:45:07] debug: [extractByIA] Resultado IA: O texto n√£o espec√≠fica uma forma de pagamento.
[2025-06-02 13:45:07] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:45:09] debug: [extractByIA] Resultado IA: Desculpe, mas essa informa√ß√£o n√£o indica se o cliente confirmou o fechamento ou n√£o. Por favor, forne√ßa uma resposta mais precisa.
[2025-06-02 13:45:09] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:45:11] debug: [extractByIA] Resultado IA: Desculpe, parece que voc√™ n√£o forneceu o nome ou contato de qualquer pessoa.
[2025-06-02 13:45:11] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 37 mensagens.
[2025-06-02 13:45:11] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:45:11] info: [validadorMultiplos] [exec-1748882679069] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'proposta'
[2025-06-02 13:45:11] info: [validadorMultiplos] [exec-1748882679069] üß© Validando metas da etapa: proposta
[2025-06-02 13:45:11] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:45:11] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:45:11] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:45:11] debug: [validadorMultiplos] [exec-1748882679069] ‚ö†Ô∏è Campo 'budget' n√£o identificado no texto.
[2025-06-02 13:45:11] debug: [validadorMultiplos] [exec-1748882679069] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'budget': 3.10ms
[2025-06-02 13:45:11] info: [validadorMultiplos] [exec-1748882679069] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'proposta'
[2025-06-02 13:45:11] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:45:11] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Condi√ß√µes de pagamento e descontos {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:45:12] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "negociacao"
}
[2025-06-02 13:45:12] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "negociacao"
[2025-06-02 13:45:12] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:45:12] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:45:12] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:45:12] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:45:12] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:45:12] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:45:12] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:45:12] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:45:12] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:45:12] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:45:12] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:45:12] info: [temperatura] üîç Calculando temperatura com base na etapa "proposta" e perfil do cliente
[2025-06-02 13:45:12] debug: [temperatura] Etapa reconhecida: "proposta" ‚Üí base inicial: 0.75
[2025-06-02 13:45:12] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:45:12] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:45:12] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:45:12] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:45:12] info: [temperatura] ‚úÖ Temperatura final calculada: 0.8
[2025-06-02 13:45:14] info: [handleMessage] [exec-1748882679069] üîç Texto bruto da IA antes do filtro: O procedimento pode ser parcelado em at√© 12x de R$ 43 sem juros ou R$ 497 √† vista via PIX.
[2025-06-02 13:45:14] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:45:14] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa proposta, phone=5512988256404
[2025-06-02 13:45:14] info: [handleMessage] [exec-1748882679069] ‚úÖ Texto final p√≥s-processado: O procedimento pode ser parcelado em at√© 12x de R$ 43 sem juros ou R$ 497 √† vista via PIX.
[2025-06-02 13:45:14] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:45:14] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:45:14] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:45:14] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5126ms
[2025-06-02 13:45:19] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:45:19] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "O procedimento pode ser parcelado em at√© 12x de R$ 43 sem juros ou R$ 497 √† vista via PIX." Timestamp=1748882719602
[2025-06-02 13:45:19] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:45:19] debug: [whatsapp] Conte√∫do da mensagem: "O procedimento pode ser parcelado em at√© 12x de R$ 43 sem juros ou R$ 497 √† vista via PIX."
[2025-06-02 13:45:19] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "O procedimento pode ser parcelado em at√© 12x de R$ 43 sem juros ou R$ 497 √† vista via PIX."
  }
}
[2025-06-02 13:45:19] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:45:20] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:45:20] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjg5NTdFNzZFQTIwNTE5QTNFMwA="
    }
  ]
}
[2025-06-02 13:45:20] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:45:21] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:45:21] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882721345
[2025-06-02 13:45:21] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjg5NTdFNzZFQTIwNTE5QTNFMwA=",
                "status": "sent",
                "timestamp": "1748882743",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:45:21] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:45:21] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:45:21] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882721641
[2025-06-02 13:45:21] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjg5NTdFNzZFQTIwNTE5QTNFMwA=",
                "status": "delivered",
                "timestamp": "1748882743",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:45:21] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:45:36] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:45:36] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882736939
[2025-06-02 13:45:36] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEU3NTJDQzgyMDE4NDkyNkFENzkxOEE0MDkwNjBEM0NBAA==",
                "timestamp": "1748882758",
                "text": {
                  "body": "Boa, vou fazer"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:45:36] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:45:36] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882736939
[2025-06-02 13:45:36] debug: [webhook] Texto recebido: Boa, vou fazer
[2025-06-02 13:45:36] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Boa, vou fazer"
[2025-06-02 13:45:36] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882736953) para 5512988256404
[2025-06-02 13:45:36] debug: [handleMessage] [exec-1748882736953] üì≤ Iniciando atendimento: phone=5512988256404, texto="Boa, vou fazer", isAudio=false
[2025-06-02 13:45:36] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:45:36] info: [handleMessage] [exec-1748882736953] Estado atual do cliente: proposta
[2025-06-02 13:45:36] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:45:36] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:45:36] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:45:36] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:45:36] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:45:36] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:45:36] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:45:36] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "proposta",
  "userMessage": "Boa, vou fazer"
}
[2025-06-02 13:45:36] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: proposta\nMensagem do cliente: Boa, vou fazer\nüìå"
    }
  ]
}
[2025-06-02 13:45:37] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-06-02 13:45:37] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 424,
    "completion_tokens": 3,
    "total_tokens": 427,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:45:37] info: [aiStateDecider] üß≠ Etapa atual: proposta ‚Äî IA sugeriu: fechamento
[2025-06-02 13:45:37] info: [handleMessage] [exec-1748882736953] Estado sugerido pela IA: fechamento
[2025-06-02 13:45:37] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-06-02 13:45:37] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-06-02 13:45:37] info: [handleMessage] [exec-1748882736953] Estado atualizado: proposta ‚Üí fechamento
[2025-06-02 13:45:37] debug: [handleMessage] [exec-1748882736953] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:45:37] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:45:37] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:45:38] debug: [extractName] Nome extra√≠do via IA: Boa
[2025-06-02 13:45:38] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:45:38] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:45:38] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:45:38] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:45:38] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:45:38] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:45:38] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:45:38] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:45:40] debug: [extractByIA] Resultado IA: Desculpe, n√£o h√° informa√ß√µes suficientes fornecidas para identificar as solu√ß√µes que o cliente tentou anteriormente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:45:40] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:45:44] debug: [extractByIA] Resultado IA: Essa pergunta √© um pouco vaga. Como assistente de IA, necessito de mais informa√ß√µes para fornecer uma resposta apropriada. Podemos ser mais espec√≠ficos? Por exemplo, podemos falar sobre o que um cliente deseja alcan√ßar ao contratar um servi√ßo de consultoria financeira ou um servi√ßo de reparo de autom√≥veis, entre muitos outros.
[2025-06-02 13:45:44] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:45:45] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° nenhuma informa√ß√£o fornecida na frase dada para determinar o n√≠vel de urg√™ncia do cliente.
[2025-06-02 13:45:45] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:45:46] debug: [extractByIA] Resultado IA: Decis√£o
[2025-06-02 13:45:46] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:45:49] debug: [extractByIA] Resultado IA: A pergunta n√£o fornece uma situa√ß√£o ou di√°logo para determinar qual tipo de obje√ß√£o um cliente apresentou. Por favor, fornecer mais detalhes.
[2025-06-02 13:45:49] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:45:50] debug: [extractByIA] Resultado IA: Sim
[2025-06-02 13:45:50] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:45:51] debug: [extractByIA] Resultado IA: A prefer√™ncia de agendamento do cliente n√£o foi mencionada no texto apresentado.
[2025-06-02 13:45:51] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:45:53] debug: [extractByIA] Resultado IA: A informa√ß√£o sobre a disponibilidade de hor√°rio do cliente n√£o foi fornecida no texto.
[2025-06-02 13:45:53] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:45:55] debug: [extractByIA] Resultado IA: O assistente n√£o forneceu um cen√°rio ou um di√°logo de um cliente. Por favor, forne√ßa um cen√°rio para que eu possa extrair o motivo da obje√ß√£o do cliente.
[2025-06-02 13:45:55] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:45:57] debug: [extractByIA] Resultado IA: Desculpe, voc√™ precisa fornecer um cen√°rio ou uma conversa para que possamos analisar e identificar a alternativa proposta pelo cliente.
[2025-06-02 13:45:57] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:46:00] debug: [extractByIA] Resultado IA: Desculpe, voc√™ n√£o forneceu qualquer informa√ß√£o sobre um desconto para que eu possa extrair um valor percentual.
[2025-06-02 13:46:00] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:46:00] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:46:01] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou uma forma de pagamento.
[2025-06-02 13:46:01] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:46:02] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:46:02] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882762028
[2025-06-02 13:46:02] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEU3NTJDQzgyMDE4NDkyNkFENzkxOEE0MDkwNjBEM0NBAA==",
                "timestamp": "1748882758",
                "text": {
                  "body": "Boa, vou fazer"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:46:02] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:46:02] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882762028
[2025-06-02 13:46:02] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEU3NTJDQzgyMDE4NDkyNkFENzkxOEE0MDkwNjBEM0NBAA==
[2025-06-02 13:46:03] debug: [extractByIA] Resultado IA: N√£o, o cliente n√£o confirmou o fechamento.
[2025-06-02 13:46:03] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:46:05] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu o nome ou contato de nenhuma pessoa. Por favor, forne√ßa mais informa√ß√µes.
[2025-06-02 13:46:05] warn: [conversationManager] [exec-1748882736953] Detec√ß√£o de mudan√ßa no campo sens√≠vel "name" ‚Äî pendente confirma√ß√£o do cliente.
[2025-06-02 13:46:05] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5166ms
[2025-06-02 13:46:10] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:46:10] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Boa" mesmo?" Timestamp=1748882770820
[2025-06-02 13:46:10] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:46:10] debug: [whatsapp] Conte√∫do da mensagem: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Boa" mesmo?"
[2025-06-02 13:46:10] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© \"Boa\" mesmo?"
  }
}
[2025-06-02 13:46:10] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:46:11] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:46:11] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkJGNERBRDcyQTBCNTgxMTgxQQA="
    }
  ]
}
[2025-06-02 13:46:11] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:46:12] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:46:12] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882772504
[2025-06-02 13:46:12] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkJGNERBRDcyQTBCNTgxMTgxQQA=",
                "status": "sent",
                "timestamp": "1748882794",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:46:12] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:46:12] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:46:12] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882772873
[2025-06-02 13:46:12] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkJGNERBRDcyQTBCNTgxMTgxQQA=",
                "status": "delivered",
                "timestamp": "1748882795",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:46:12] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:48:29] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:48:29] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882909900
[2025-06-02 13:48:29] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEE4MTQxOUUwODJCMUNFOUQzRTkzRjE4MjM0RDQzMzQ0AA==",
                "timestamp": "1748882932",
                "text": {
                  "body": "Disse que quero fazer o procedimento"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:48:29] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:48:29] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882909900
[2025-06-02 13:48:29] debug: [webhook] Texto recebido: Disse que quero fazer o procedimento
[2025-06-02 13:48:29] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Disse que quero fazer o procedimento"
[2025-06-02 13:48:29] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748882909916) para 5512988256404
[2025-06-02 13:48:29] debug: [handleMessage] [exec-1748882909916] üì≤ Iniciando atendimento: phone=5512988256404, texto="Disse que quero fazer o procedimento", isAudio=false
[2025-06-02 13:48:29] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:48:29] info: [handleMessage] [exec-1748882909916] Estado atual do cliente: fechamento
[2025-06-02 13:48:29] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:48:29] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:48:29] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:48:29] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:48:29] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:48:29] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:48:29] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:48:29] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Disse que quero fazer o procedimento"
}
[2025-06-02 13:48:29] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Disse que quero"
    }
  ]
}
[2025-06-02 13:48:31] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "pos_venda"
}
[2025-06-02 13:48:31] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 429,
    "completion_tokens": 3,
    "total_tokens": 432,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:48:31] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: pos_venda
[2025-06-02 13:48:31] info: [handleMessage] [exec-1748882909916] Estado sugerido pela IA: pos_venda
[2025-06-02 13:48:31] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí pos_venda
[2025-06-02 13:48:31] debug: [ClientRepository] current_state atualizado para 'pos_venda' e retries resetado
[2025-06-02 13:48:31] info: [handleMessage] [exec-1748882909916] Estado atualizado: fechamento ‚Üí pos_venda
[2025-06-02 13:48:31] debug: [handleMessage] [exec-1748882909916] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:48:31] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:48:31] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:48:31] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:48:31] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:48:31] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:48:31] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:48:31] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:48:31] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:48:31] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:48:31] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:48:31] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:48:33] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o especifica quais solu√ß√µes o cliente j√° tentou anteriormente. Por favor, forne√ßa mais informa√ß√µes.
[2025-06-02 13:48:33] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:48:39] debug: [extractByIA] Resultado IA: Como assistente virtual, preciso de mais informa√ß√µes para poder ajudar de maneira eficaz. Por exemplo, que tipo de procedimento o cliente est√° se referindo - m√©dico, legal, financeiro, etc.? Dependendo do contexto, o cliente pode buscar resultados como melhoria na sa√∫de, resolu√ß√£o de uma disputa legal, aumento da efici√™ncia financeira ou qualquer n√∫mero de outras metas. O detalhamento das expectativas do cliente √© vital para fornecer o melhor servi√ßo poss√≠vel.
[2025-06-02 13:48:39] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:48:42] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o especifica o n√≠vel de urg√™ncia do cliente. Precisamos de mais detalhes para determinar se a urg√™ncia √© baixa, m√©dia, alta ou imediata.
[2025-06-02 13:48:42] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:48:43] debug: [extractByIA] Resultado IA: O cliente est√° no est√°gio de decis√£o.
[2025-06-02 13:48:43] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:48:45] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o indica uma obje√ß√£o espec√≠fica do cliente.
[2025-06-02 13:48:45] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:48:46] debug: [extractByIA] Resultado IA: Sim
[2025-06-02 13:48:46] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:48:47] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre a prefer√™ncia de agendamento do cliente.
[2025-06-02 13:48:47] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:48:48] debug: [extractByIA] Resultado IA: A informa√ß√£o sobre a disponibilidade de hor√°rio do cliente n√£o foi fornecida na mensagem.
[2025-06-02 13:48:48] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:48:50] debug: [extractByIA] Resultado IA: O cliente n√£o expressou nenhuma obje√ß√£o.
[2025-06-02 13:48:50] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:48:52] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida √© insuficiente para identificar qual √© a alternativa proposta pelo cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:48:52] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:48:54] debug: [extractByIA] Resultado IA: Desculpe, sua afirma√ß√£o n√£o especificou um valor percentual de desconto. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:48:54] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:48:54] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:48:55] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:48:55] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882935445
[2025-06-02 13:48:55] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEE4MTQxOUUwODJCMUNFOUQzRTkzRjE4MjM0RDQzMzQ0AA==",
                "timestamp": "1748882932",
                "text": {
                  "body": "Disse que quero fazer o procedimento"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:48:55] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:48:55] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748882935445
[2025-06-02 13:48:55] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEE4MTQxOUUwODJCMUNFOUQzRTkzRjE4MjM0RDQzMzQ0AA==
[2025-06-02 13:48:56] debug: [extractByIA] Resultado IA: O cliente n√£o especificou uma forma de pagamento em sua declara√ß√£o.
[2025-06-02 13:48:56] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:48:58] debug: [extractByIA] Resultado IA: N√£o √© uma confirma√ß√£o clara. Por favor, confirme explicitamente se deseja continuar com o procedimento.
[2025-06-02 13:48:58] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:49:00] debug: [extractByIA] Resultado IA: Desculpe, voc√™ n√£o forneceu informa√ß√µes suficientes sobre a pessoa ou contato que procura. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:49:00] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 38 mensagens.
[2025-06-02 13:49:00] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:49:00] info: [validadorMultiplos] [exec-1748882909916] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'pos_venda'
[2025-06-02 13:49:00] info: [validadorMultiplos] [exec-1748882909916] üß© Validando metas da etapa: pos_venda
[2025-06-02 13:49:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:49:00] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-06-02 13:49:00] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:49:00] debug: [validadorMultiplos] [exec-1748882909916] ‚ö†Ô∏è Campo 'feedback' n√£o identificado no texto.
[2025-06-02 13:49:00] debug: [validadorMultiplos] [exec-1748882909916] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'feedback': 4.10ms
[2025-06-02 13:49:00] info: [validadorMultiplos] [exec-1748882909916] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'pos_venda'
[2025-06-02 13:49:00] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-06-02 13:49:00] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Disse que quero fazer o procedimento {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-06-02 13:49:01] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-06-02 13:49:01] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-06-02 13:49:01] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-06-02 13:49:01] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:49:01] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:49:01] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:49:01] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:49:01] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:49:01] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:49:01] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-06-02 13:49:01] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-06-02 13:49:01] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-06-02 13:49:01] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:49:01] info: [temperatura] üîç Calculando temperatura com base na etapa "pos_venda" e perfil do cliente
[2025-06-02 13:49:01] debug: [temperatura] Etapa reconhecida: "pos_venda" ‚Üí base inicial: 0.5
[2025-06-02 13:49:01] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-06-02 13:49:01] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-06-02 13:49:01] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-06-02 13:49:01] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-06-02 13:49:01] info: [temperatura] ‚úÖ Temperatura final calculada: 0.55
[2025-06-02 13:49:04] info: [handleMessage] [exec-1748882909916] üîç Texto bruto da IA antes do filtro: Que √≥timo, Lamuriel! Estamos ansiosos para te receber e proporcionar uma experi√™ncia incr√≠vel com a micropigmenta√ß√£o de barba. üòäüßî
[2025-06-02 13:49:04] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-06-02 13:49:04] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa pos_venda, phone=5512988256404
[2025-06-02 13:49:04] info: [handleMessage] [exec-1748882909916] ‚úÖ Texto final p√≥s-processado: Que √≥timo, Lamuriel! Estamos ansiosos para te receber e proporcionar uma experi√™ncia incr√≠vel com a micropigmenta√ß√£o de barba. üòäüßî
[2025-06-02 13:49:04] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-06-02 13:49:04] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-06-02 13:49:04] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-06-02 13:49:04] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6254ms
[2025-06-02 13:49:10] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:49:10] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Que √≥timo, Lamuriel! Estamos ansiosos para te receber e proporcionar uma experi√™ncia incr√≠vel com a micropigmenta√ß√£o de barba. üòäüßî" Timestamp=1748882950649
[2025-06-02 13:49:10] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:49:10] debug: [whatsapp] Conte√∫do da mensagem: "Que √≥timo, Lamuriel! Estamos ansiosos para te receber e proporcionar uma experi√™ncia incr√≠vel com a micropigmenta√ß√£o de barba. üòäüßî"
[2025-06-02 13:49:10] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Que √≥timo, Lamuriel! Estamos ansiosos para te receber e proporcionar uma experi√™ncia incr√≠vel com a micropigmenta√ß√£o de barba. üòäüßî"
  }
}
[2025-06-02 13:49:10] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:49:11] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:49:11] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjM1MzlGQTFENkU0MkI5Mjg0RgA="
    }
  ]
}
[2025-06-02 13:49:11] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:49:12] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:49:12] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882952336
[2025-06-02 13:49:12] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjM1MzlGQTFENkU0MkI5Mjg0RgA=",
                "status": "sent",
                "timestamp": "1748882974",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:49:12] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:49:12] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:49:12] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748882952477
[2025-06-02 13:49:12] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjM1MzlGQTFENkU0MkI5Mjg0RgA=",
                "status": "delivered",
                "timestamp": "1748882974",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:49:12] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:50:00] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:50:00] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883000149
[2025-06-02 13:50:00] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNBMUQ3NzlDRUYwNjRFNDFDRTExQUY3NEY2MjNFNkIyAA==",
                "timestamp": "1748883022",
                "text": {
                  "body": "Meu nome √© Felipe"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:50:00] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:50:00] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883000149
[2025-06-02 13:50:00] debug: [webhook] Texto recebido: Meu nome √© Felipe
[2025-06-02 13:50:00] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Meu nome √© Felipe"
[2025-06-02 13:50:00] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748883000162) para 5512988256404
[2025-06-02 13:50:00] debug: [handleMessage] [exec-1748883000162] üì≤ Iniciando atendimento: phone=5512988256404, texto="Meu nome √© Felipe", isAudio=false
[2025-06-02 13:50:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:50:00] info: [handleMessage] [exec-1748883000162] Estado atual do cliente: pos_venda
[2025-06-02 13:50:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:50:00] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:50:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:50:00] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:50:00] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:50:00] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:50:00] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:50:00] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "pos_venda",
  "userMessage": "Meu nome √© Felipe"
}
[2025-06-02 13:50:00] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: pos_venda\nMensagem do cliente: Meu nome √© Felip"
    }
  ]
}
[2025-06-02 13:50:01] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "reativacao"
}
[2025-06-02 13:50:01] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 425,
    "completion_tokens": 3,
    "total_tokens": 428,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:50:01] info: [aiStateDecider] üß≠ Etapa atual: pos_venda ‚Äî IA sugeriu: reativacao
[2025-06-02 13:50:01] info: [handleMessage] [exec-1748883000162] Estado sugerido pela IA: reativacao
[2025-06-02 13:50:01] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí reativacao
[2025-06-02 13:50:01] debug: [ClientRepository] current_state atualizado para 'reativacao' e retries resetado
[2025-06-02 13:50:01] info: [handleMessage] [exec-1748883000162] Estado atualizado: pos_venda ‚Üí reativacao
[2025-06-02 13:50:01] debug: [handleMessage] [exec-1748883000162] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:50:01] debug: [extractNameSmart] Nome extra√≠do via regex: Felipe
[2025-06-02 13:50:01] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:50:01] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:50:01] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:50:01] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:50:01] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:50:01] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:50:01] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:50:01] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:50:03] debug: [extractByIA] Resultado IA: O texto fornecido n√£o apresenta nenhuma informa√ß√£o sobre solu√ß√µes que o cliente j√° tentou anteriormente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:50:03] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:50:06] debug: [extractByIA] Resultado IA: Desculpe, mas a pergunta n√£o falava sobre um servi√ßo espec√≠fico. Poderia especificar de qual servi√ßo voc√™ est√° se referindo para que eu possa te ajudar melhor?
[2025-06-02 13:50:06] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:50:08] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o menciona um n√≠vel de urg√™ncia.
[2025-06-02 13:50:08] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:50:10] debug: [extractByIA] Resultado IA: Como voc√™ apenas compartilhou o seu nome, n√£o consigo determinar em que est√°gio voc√™ est√° sem mais informa√ß√µes. Voc√™ est√° interessado em algum produto ou servi√ßo, ou possui alguma d√∫vida ou decis√£o a tomar?
[2025-06-02 13:50:10] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:50:11] debug: [extractByIA] Resultado IA: Nenhuma obje√ß√£o foi apresentada pelo cliente.
[2025-06-02 13:50:11] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:50:12] debug: [extractByIA] Resultado IA: N√£o
[2025-06-02 13:50:12] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:50:14] debug: [extractByIA] Resultado IA: O texto fornecido n√£o indica uma prefer√™ncia de agendamento.
[2025-06-02 13:50:14] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:50:15] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o inclui a disponibilidade de hor√°rio do cliente.
[2025-06-02 13:50:15] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:50:17] debug: [extractByIA] Resultado IA: O cliente n√£o apresentou uma obje√ß√£o nesta declara√ß√£o.
[2025-06-02 13:50:17] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:50:18] debug: [extractByIA] Resultado IA: Desculpe, mas essa frase n√£o apresenta uma oferta principal ou uma alternativa proposta pelo cliente.
[2025-06-02 13:50:18] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:50:20] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o cont√©m um valor percentual de desconto para extrair.
[2025-06-02 13:50:20] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:50:20] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:50:21] debug: [extractByIA] Resultado IA: O texto fornecido n√£o menciona uma forma de pagamento.
[2025-06-02 13:50:21] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:50:23] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o est√° relacionada com a confirma√ß√£o do fechamento.
[2025-06-02 13:50:23] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:50:24] debug: [extractByIA] Resultado IA: Felipe
[2025-06-02 13:50:24] warn: [conversationManager] [exec-1748883000162] Detec√ß√£o de mudan√ßa no campo sens√≠vel "name" ‚Äî pendente confirma√ß√£o do cliente.
[2025-06-02 13:50:24] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3376ms
[2025-06-02 13:50:25] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:50:25] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883025329
[2025-06-02 13:50:25] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNBMUQ3NzlDRUYwNjRFNDFDRTExQUY3NEY2MjNFNkIyAA==",
                "timestamp": "1748883022",
                "text": {
                  "body": "Meu nome √© Felipe"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:50:25] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:50:25] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883025329
[2025-06-02 13:50:25] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNBMUQ3NzlDRUYwNjRFNDFDRTExQUY3NEY2MjNFNkIyAA==
[2025-06-02 13:50:27] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:50:27] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Felipe" mesmo?" Timestamp=1748883027948
[2025-06-02 13:50:27] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:50:27] debug: [whatsapp] Conte√∫do da mensagem: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Felipe" mesmo?"
[2025-06-02 13:50:27] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© \"Felipe\" mesmo?"
  }
}
[2025-06-02 13:50:27] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:50:29] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:50:29] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJCRjg4OTAwN0YxN0U3NURBRAA="
    }
  ]
}
[2025-06-02 13:50:29] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:50:29] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:50:29] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883029909
[2025-06-02 13:50:29] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJCRjg4OTAwN0YxN0U3NURBRAA=",
                "status": "sent",
                "timestamp": "1748883052",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:50:29] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:50:30] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:50:30] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883030054
[2025-06-02 13:50:30] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJCRjg4OTAwN0YxN0U3NURBRAA=",
                "status": "delivered",
                "timestamp": "1748883052",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:50:30] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:51:39] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:51:39] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883099813
[2025-06-02 13:51:39] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDc4RENFNDc5M0JGNDIwOTUwNkYyMTc5RTNFQTM4OEE1AA==",
                "timestamp": "1748883122",
                "text": {
                  "body": "√â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:51:39] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:51:39] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883099813
[2025-06-02 13:51:39] debug: [webhook] Texto recebido: √â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o
[2025-06-02 13:51:39] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "√â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o"
[2025-06-02 13:51:39] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748883099827) para 5512988256404
[2025-06-02 13:51:39] debug: [handleMessage] [exec-1748883099827] üì≤ Iniciando atendimento: phone=5512988256404, texto="√â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o", isAudio=false
[2025-06-02 13:51:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:51:39] info: [handleMessage] [exec-1748883099827] Estado atual do cliente: reativacao
[2025-06-02 13:51:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:51:39] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:51:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:51:39] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:51:39] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:51:39] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:51:39] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:51:39] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "reativacao",
  "userMessage": "√â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o"
}
[2025-06-02 13:51:39] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: reativacao\nMensagem do cliente: √â Felipe Lamuri"
    }
  ]
}
[2025-06-02 13:51:41] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "leva\nntamento"
}
[2025-06-02 13:51:41] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 441,
    "completion_tokens": 5,
    "total_tokens": 446,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:51:41] warn: [aiStateDecider] üö´ Estado inv√°lido sugerido pela IA {
  "nextState": "leva\nntamento"
}
[2025-06-02 13:51:41] info: [handleMessage] [exec-1748883099827] Estado sugerido pela IA: reativacao
[2025-06-02 13:51:41] debug: [ClientRepository] Atualizando retries para 5512988256404: 1
[2025-06-02 13:51:41] info: [ClientRepository] retries atualizado para 1 no cliente 5512988256404
[2025-06-02 13:51:41] debug: [handleMessage] [exec-1748883099827] Repeti√ß√£o detectada. Retries incrementado para 1
[2025-06-02 13:51:41] debug: [handleMessage] [exec-1748883099827] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:51:41] debug: [extractNameSmart] Nome extra√≠do via regex: do signo
[2025-06-02 13:51:41] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:51:41] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:51:41] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:51:41] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:51:41] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:51:41] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:51:41] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:51:41] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:51:44] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o indica quaisquer solu√ß√µes que o cliente j√° possa ter tentado. Por favor, forne√ßa detalhes adicionais.
[2025-06-02 13:51:44] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:51:47] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu informa√ß√µes suficientes sobre um servi√ßo espec√≠fico. Para ajud√°-lo melhor, por favor, forne√ßa mais detalhes sobre o servi√ßo em quest√£o.
[2025-06-02 13:51:47] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:51:48] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes para determinar o n√≠vel de urg√™ncia do cliente.
[2025-06-02 13:51:48] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:51:51] debug: [extractByIA] Resultado IA: Como n√£o foram fornecidas informa√ß√µes espec√≠ficas sobre uma compra, produto ou servi√ßo, n√£o √© poss√≠vel determinar em que est√°gio da jornada do cliente Felipe Lamuriel se encontra.
[2025-06-02 13:51:51] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:51:53] debug: [extractByIA] Resultado IA: O cliente n√£o apresentou uma obje√ß√£o espec√≠fica.
[2025-06-02 13:51:53] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:51:54] debug: [extractByIA] Resultado IA: n√£o
[2025-06-02 13:51:54] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:51:56] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre a prefer√™ncia de agendamento do cliente.
[2025-06-02 13:51:56] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:51:59] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre a disponibilidade de hor√°rio do cliente.
[2025-06-02 13:51:59] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:52:01] debug: [extractByIA] Resultado IA: O cliente n√£o apresentou uma obje√ß√£o.
[2025-06-02 13:52:01] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:52:03] debug: [extractByIA] Resultado IA: Desculpe, mas sua frase n√£o cont√©m uma alternativa proposta por um cliente. Parece que voc√™ est√° se apresentando, n√£o recusando uma oferta e sugerindo outra.
[2025-06-02 13:52:03] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:52:05] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o menciona nenhum valor percentual de desconto.
[2025-06-02 13:52:05] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:52:05] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:52:05] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:52:05] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883125239
[2025-06-02 13:52:05] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDc4RENFNDc5M0JGNDIwOTUwNkYyMTc5RTNFQTM4OEE1AA==",
                "timestamp": "1748883122",
                "text": {
                  "body": "√â Felipe Lamuriel, sou do signo de libra, sou muito brincalh√£o"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:52:05] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:52:05] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883125239
[2025-06-02 13:52:05] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDc4RENFNDc5M0JGNDIwOTUwNkYyMTc5RTNFQTM4OEE1AA==
[2025-06-02 13:52:07] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou uma forma de pagamento.
[2025-06-02 13:52:07] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:52:09] debug: [extractByIA] Resultado IA: Seu texto n√£o confirma o fechamento.
[2025-06-02 13:52:09] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:52:11] debug: [extractByIA] Resultado IA: Felipe Lamuriel
[2025-06-02 13:52:11] warn: [conversationManager] [exec-1748883099827] Detec√ß√£o de mudan√ßa no campo sens√≠vel "name" ‚Äî pendente confirma√ß√£o do cliente.
[2025-06-02 13:52:11] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6286ms
[2025-06-02 13:52:17] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:52:17] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "do signo" mesmo?" Timestamp=1748883137530
[2025-06-02 13:52:17] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:52:17] debug: [whatsapp] Conte√∫do da mensagem: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "do signo" mesmo?"
[2025-06-02 13:52:17] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© \"do signo\" mesmo?"
  }
}
[2025-06-02 13:52:17] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:52:18] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:52:18] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkI4ODRCQzEyNjE2RjYzREJEQwA="
    }
  ]
}
[2025-06-02 13:52:18] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:52:19] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:52:19] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883139211
[2025-06-02 13:52:19] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkI4ODRCQzEyNjE2RjYzREJEQwA=",
                "status": "sent",
                "timestamp": "1748883161",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:52:19] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:52:19] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:52:19] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883139407
[2025-06-02 13:52:19] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkI4ODRCQzEyNjE2RjYzREJEQwA=",
                "status": "delivered",
                "timestamp": "1748883161",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:52:19] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:52:53] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:52:53] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883173235
[2025-06-02 13:52:53] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA1QzdBOUNFQzE3MEE4RDM1NDQ0MTU2MDRFMzE4MUZEAA==",
                "timestamp": "1748883195",
                "text": {
                  "body": "Ok."
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:52:53] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:52:53] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883173235
[2025-06-02 13:52:53] debug: [webhook] Texto recebido: Ok.
[2025-06-02 13:52:53] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ok."
[2025-06-02 13:52:53] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748883173248) para 5512988256404
[2025-06-02 13:52:53] debug: [handleMessage] [exec-1748883173248] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ok.", isAudio=false
[2025-06-02 13:52:53] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:52:53] info: [handleMessage] [exec-1748883173248] Estado atual do cliente: reativacao
[2025-06-02 13:52:53] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:52:53] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:52:53] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:52:53] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:52:53] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:52:53] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:52:53] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:52:53] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "reativacao",
  "userMessage": "Ok."
}
[2025-06-02 13:52:53] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: reativacao\nMensagem do cliente: Ok.\nüìå DADOS J√Å"
    }
  ]
}
[2025-06-02 13:52:54] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "proposta"
}
[2025-06-02 13:52:54] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 421,
    "completion_tokens": 2,
    "total_tokens": 423,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:52:54] info: [aiStateDecider] üß≠ Etapa atual: reativacao ‚Äî IA sugeriu: proposta
[2025-06-02 13:52:54] info: [handleMessage] [exec-1748883173248] Estado sugerido pela IA: proposta
[2025-06-02 13:52:54] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí proposta
[2025-06-02 13:52:54] debug: [ClientRepository] current_state atualizado para 'proposta' e retries resetado
[2025-06-02 13:52:54] info: [handleMessage] [exec-1748883173248] Estado atualizado: reativacao ‚Üí proposta
[2025-06-02 13:52:54] debug: [handleMessage] [exec-1748883173248] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:52:54] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:52:54] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:52:56] debug: [extractName] Nome extra√≠do via IA: Voc√™ precisa fornecer uma entrada para que eu possa determinar e extrair o primeiro nome.
[2025-06-02 13:52:56] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:52:56] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:52:56] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:52:56] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:52:56] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:52:56] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:52:56] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:52:56] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:52:58] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu nenhuma informa√ß√£o sobre as solu√ß√µes que o cliente j√° tentou anteriormente. Por favor, fornecer mais detalhes.
[2025-06-02 13:52:58] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:53:01] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ poderia fornecer mais detalhes? N√£o posso fornecer uma resposta precisa sem saber qual servi√ßo est√° sendo discutido.
[2025-06-02 13:53:01] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:53:03] debug: [extractByIA] Resultado IA: Desculpe, n√£o h√° nenhuma informa√ß√£o na solicita√ß√£o para determinar o n√≠vel de urg√™ncia do cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:53:03] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:53:05] debug: [extractByIA] Resultado IA: Como um assistente de IA, eu precisaria de mais informa√ß√µes e contexto para determinar com precis√£o o est√°gio em que o cliente est√° no processo de compra. Voc√™ pode fornecer mais detalhes?
[2025-06-02 13:53:05] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:53:06] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:06] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883186811
[2025-06-02 13:53:06] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDExOTVEOTU3OUYzM0U5NUVFNzY5M0JDNDFDRTA0NkEzAA==",
                "timestamp": "1748883209",
                "text": {
                  "body": "Meu nome √© Felipe Lamuriel"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:06] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:53:06] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883186811
[2025-06-02 13:53:06] debug: [webhook] Texto recebido: Meu nome √© Felipe Lamuriel
[2025-06-02 13:53:06] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Meu nome √© Felipe Lamuriel"
[2025-06-02 13:53:06] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748883186826) para 5512988256404
[2025-06-02 13:53:06] debug: [handleMessage] [exec-1748883186826] üì≤ Iniciando atendimento: phone=5512988256404, texto="Meu nome √© Felipe Lamuriel", isAudio=false
[2025-06-02 13:53:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:06] info: [handleMessage] [exec-1748883186826] Estado atual do cliente: proposta
[2025-06-02 13:53:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:06] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:53:06] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:06] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:53:06] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:53:06] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:53:06] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:53:06] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "proposta",
  "userMessage": "Meu nome √© Felipe Lamuriel"
}
[2025-06-02 13:53:06] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: proposta\nMensagem do cliente: Meu nome √© Felipe"
    }
  ]
}
[2025-06-02 13:53:07] debug: [extractByIA] Resultado IA: A pergunta n√£o fornece informa√ß√µes suficientes para identificar qual tipo de obje√ß√£o o cliente apresentou.
[2025-06-02 13:53:07] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:53:07] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-06-02 13:53:07] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 427,
    "completion_tokens": 3,
    "total_tokens": 430,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:53:07] info: [aiStateDecider] üß≠ Etapa atual: proposta ‚Äî IA sugeriu: negociacao
[2025-06-02 13:53:07] info: [handleMessage] [exec-1748883186826] Estado sugerido pela IA: negociacao
[2025-06-02 13:53:07] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-06-02 13:53:07] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-06-02 13:53:07] info: [handleMessage] [exec-1748883186826] Estado atualizado: proposta ‚Üí negociacao
[2025-06-02 13:53:07] debug: [handleMessage] [exec-1748883186826] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:53:07] debug: [extractNameSmart] Nome extra√≠do via regex: Felipe Lamuriel
[2025-06-02 13:53:07] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:53:07] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:53:07] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:53:07] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:53:07] debug: [extractPaymentMethod] Forma de pagamento encontrada: nenhuma
[2025-06-02 13:53:07] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:53:07] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:53:07] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:53:09] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu informa√ß√µes suficientes para que eu possa responder essa pergunta.
[2025-06-02 13:53:09] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:53:09] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:53:09] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:53:11] debug: [extractByIA] Resultado IA: Desculpe, n√£o consigo extrair o hor√°rio de prefer√™ncia se n√£o houver uma declara√ß√£o direta. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:53:11] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:53:13] debug: [extractByIA] Resultado IA: Desculpa Felipe, a pergunta foi mal formulada. Eu estava me referindo a um servi√ßo hipot√©tico. Na verdade, a pergunta seria melhor se fosse "Qual servi√ßo voc√™ est√° interessado e o que voc√™ espera ou deseja alcan√ßar com isso?"
[2025-06-02 13:53:13] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:53:13] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:13] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883193820
[2025-06-02 13:53:13] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZBNzYzRjVGMTg0NUFBNjE0REQ2MzQ5QUE0OENFNTUyAA==",
                "timestamp": "1748883215",
                "text": {
                  "body": "Vou oagar nonpix"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:13] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:53:13] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883193820
[2025-06-02 13:53:13] debug: [webhook] Texto recebido: Vou oagar nonpix
[2025-06-02 13:53:13] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Vou oagar nonpix"
[2025-06-02 13:53:13] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748883193834) para 5512988256404
[2025-06-02 13:53:13] debug: [handleMessage] [exec-1748883193834] üì≤ Iniciando atendimento: phone=5512988256404, texto="Vou oagar nonpix", isAudio=false
[2025-06-02 13:53:13] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:13] info: [handleMessage] [exec-1748883193834] Estado atual do cliente: negociacao
[2025-06-02 13:53:13] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:13] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-06-02 13:53:13] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-06-02 13:53:13] debug: [resumoDoHistorico] name: Lamuriel
[2025-06-02 13:53:13] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-06-02 13:53:13] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-06-02 13:53:13] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-06-02 13:53:13] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Vou oagar nonpix"
}
[2025-06-02 13:53:13] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Vou oagar nonpi"
    }
  ]
}
[2025-06-02 13:53:14] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi mencionado.
[2025-06-02 13:53:14] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:53:14] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-06-02 13:53:14] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 425,
    "completion_tokens": 3,
    "total_tokens": 428,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-06-02 13:53:14] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-06-02 13:53:14] info: [handleMessage] [exec-1748883193834] Estado sugerido pela IA: fechamento
[2025-06-02 13:53:14] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-06-02 13:53:14] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-06-02 13:53:14] info: [handleMessage] [exec-1748883193834] Estado atualizado: negociacao ‚Üí fechamento
[2025-06-02 13:53:14] debug: [handleMessage] [exec-1748883193834] Verificando campos sens√≠veis extra√≠dos...
[2025-06-02 13:53:14] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-06-02 13:53:14] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-06-02 13:53:15] debug: [extractByIA] Resultado IA: Desculpe, voc√™ n√£o forneceu um exemplo de coment√°rio de cliente do qual eu possa extrair a disponibilidade de hor√°rio.
[2025-06-02 13:53:15] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:53:15] debug: [extractName] IA respondeu null ou vazio
[2025-06-02 13:53:15] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-06-02 13:53:15] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:53:15] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-06-02 13:53:15] debug: [extractAddress] Nenhum endere√ßo reconhecido via regex
[2025-06-02 13:53:15] debug: [extractPaymentMethod] Forma de pagamento encontrada: pix
[2025-06-02 13:53:15] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-06-02 13:53:15] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-06-02 13:53:15] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-06-02 13:53:16] debug: [extractByIA] Resultado IA: Como assistente, n√£o posso identificar o est√°gio do cliente apenas com essa informa√ß√£o. Por favor, forne√ßa mais detalhes sobre a intera√ß√£o.
[2025-06-02 13:53:16] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:53:17] debug: [extractByIA] Resultado IA: Desculpe, mas eu preciso de mais contexto para fazer isso. Voc√™ poderia fornecer uma situa√ß√£o ou conversa espec√≠fica?
[2025-06-02 13:53:17] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:53:17] debug: [extractByIA] Resultado IA: Desculpe, mas suas informa√ß√µes n√£o s√£o claras o suficiente para entender quais solu√ß√µes voc√™ j√° tentou anteriormente. Poderia fornecer mais detalhes?
[2025-06-02 13:53:17] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-06-02 13:53:18] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:18] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883198499
[2025-06-02 13:53:18] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA1QzdBOUNFQzE3MEE4RDM1NDQ0MTU2MDRFMzE4MUZEAA==",
                "timestamp": "1748883195",
                "text": {
                  "body": "Ok."
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:18] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:53:18] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883198499
[2025-06-02 13:53:18] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA1QzdBOUNFQzE3MEE4RDM1NDQ0MTU2MDRFMzE4MUZEAA==
[2025-06-02 13:53:18] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o apresenta uma obje√ß√£o do cliente. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:53:18] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:53:20] debug: [extractByIA] Resultado IA: A informa√ß√£o fornecida n√£o indica uma inten√ß√£o de compra.
[2025-06-02 13:53:20] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:53:20] debug: [extractByIA] Resultado IA: Como assistente de IA, preciso de um cen√°rio espec√≠fico fornecido para fazer a extra√ß√£o. Por exemplo, fornecer uma situa√ß√£o em que um vendedor est√° oferecendo um produto ou servi√ßo, e o cliente ofere√ßa uma alternativa em resposta.
[2025-06-02 13:53:20] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:53:22] debug: [extractByIA] Resultado IA: O texto n√£o fornece informa√ß√µes sobre a prefer√™ncia de agendamento do cliente.
[2025-06-02 13:53:22] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:53:22] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu nenhuma informa√ß√£o para eu extrair o valor percentual de desconto.
[2025-06-02 13:53:22] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:53:22] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:53:22] debug: [extractByIA] Resultado IA: Como assistente virtual, minha infer√™ncia √© que o cliente deseja realizar uma transa√ß√£o financeira por meio de uma ferramenta de pagamento r√°pida e eficiente conhecida como Pix, que √© muito popular no Brasil. O Pix √© instant√¢neo e pode ser usado 24/7 para transferir dinheiro entre contas em diferentes institui√ß√µes financeiras. O objetivo do cliente seria realizar este pagamento de maneira r√°pida e sem complica√ß√µes.
[2025-06-02 13:53:22] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-06-02 13:53:24] debug: [extractByIA] Resultado IA: Imediata
[2025-06-02 13:53:24] debug: [extractByIA] Prompt: Em que est√°gio o cliente est√°? (interesse, d√∫vida, decis√£o, fechamento)
[2025-06-02 13:53:24] debug: [extractByIA] Resultado IA: A mensagem n√£o cont√©m informa√ß√µes sobre a disponibilidade de hor√°rio do cliente.
[2025-06-02 13:53:24] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:53:24] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu nenhuma informa√ß√£o sobre a forma de pagamento para eu extrair.
[2025-06-02 13:53:24] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:53:25] debug: [extractByIA] Resultado IA: O cliente est√° no est√°gio de fechamento.
[2025-06-02 13:53:25] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-06-02 13:53:25] debug: [extractByIA] Resultado IA: N√£o, a resposta n√£o confirma o fechamento.
[2025-06-02 13:53:25] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:53:25] debug: [extractByIA] Resultado IA: O texto fornecido n√£o apresenta uma obje√ß√£o de um cliente.
[2025-06-02 13:53:25] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:53:26] debug: [extractByIA] Resultado IA: O tipo de obje√ß√£o do cliente aqui parece estar relacionado ao m√©todo de pagamento - ele prefere usar o Pix.
[2025-06-02 13:53:26] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-06-02 13:53:27] debug: [extractByIA] Resultado IA: Sim
[2025-06-02 13:53:27] debug: [extractByIA] Prompt: Extraia a prefer√™ncia de agendamento do cliente. Ex: "pela manh√£", "ap√≥s as 18h".
[2025-06-02 13:53:27] debug: [extractByIA] Resultado IA: Desculpe, sua declara√ß√£o n√£o apresenta uma oferta principal nem uma alternativa proposta. Por favor, forne√ßa mais detalhes.
[2025-06-02 13:53:27] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:53:28] debug: [extractByIA] Resultado IA: A frase fornecida n√£o indica uma prefer√™ncia de agendamento do cliente.
[2025-06-02 13:53:28] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-06-02 13:53:29] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu informa√ß√µes suficientes para que eu possa lhe auxiliar. Por favor, forne√ßa os detalhes do nome ou contato que voc√™ gostaria que eu extra√≠sse.
[2025-06-02 13:53:29] warn: [conversationManager] [exec-1748883173248] Detec√ß√£o de mudan√ßa no campo sens√≠vel "name" ‚Äî pendente confirma√ß√£o do cliente.
[2025-06-02 13:53:29] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3616ms
[2025-06-02 13:53:29] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o tenho informa√ß√µes sobre um valor percentual de desconto nesta frase.
[2025-06-02 13:53:29] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:53:29] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:53:30] debug: [extractByIA] Resultado IA: A mensagem n√£o fornece informa√ß√µes sobre a disponibilidade de hor√°rio do cliente.
[2025-06-02 13:53:30] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-06-02 13:53:30] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou uma forma de pagamento.
[2025-06-02 13:53:30] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:53:31] debug: [extractByIA] Resultado IA: O cliente est√° resistindo a pagar atrav√©s do m√©todo PIX.
[2025-06-02 13:53:31] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-06-02 13:53:32] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:32] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883212004
[2025-06-02 13:53:32] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDExOTVEOTU3OUYzM0U5NUVFNzY5M0JDNDFDRTA0NkEzAA==",
                "timestamp": "1748883209",
                "text": {
                  "body": "Meu nome √© Felipe Lamuriel"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:32] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:53:32] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883212004
[2025-06-02 13:53:32] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDExOTVEOTU3OUYzM0U5NUVFNzY5M0JDNDFDRTA0NkEzAA==
[2025-06-02 13:53:32] debug: [extractByIA] Resultado IA: Sua resposta n√£o corresponde √† pergunta. Por favor, tente novamente. Precisamos saber se o cliente confirmou o fechamento.
[2025-06-02 13:53:32] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:53:32] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:53:32] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Voc√™ precisa fornecer uma entrada para que eu possa determinar e extrair o primeiro nome." mesmo?" Timestamp=1748883212807
[2025-06-02 13:53:32] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:53:32] debug: [whatsapp] Conte√∫do da mensagem: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Voc√™ precisa fornecer uma entrada para que eu possa determinar e extrair o primeiro nome." mesmo?"
[2025-06-02 13:53:32] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© \"Voc√™ precisa fornecer uma entrada para que eu possa determinar e extrair o primeiro nome.\" mesmo?"
  }
}
[2025-06-02 13:53:32] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:53:33] debug: [extractByIA] Resultado IA: O cliente prop√µe pagar via pix.
[2025-06-02 13:53:33] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-06-02 13:53:33] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:53:33] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhEODY2RkIyMTAwMTM3MDYyMQA="
    }
  ]
}
[2025-06-02 13:53:33] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:53:34] debug: [extractByIA] Resultado IA: Felipe Lamuriel
[2025-06-02 13:53:34] warn: [conversationManager] [exec-1748883186826] Detec√ß√£o de mudan√ßa no campo sens√≠vel "name" ‚Äî pendente confirma√ß√£o do cliente.
[2025-06-02 13:53:34] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5145ms
[2025-06-02 13:53:34] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:34] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883214531
[2025-06-02 13:53:34] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhEODY2RkIyMTAwMTM3MDYyMQA=",
                "status": "sent",
                "timestamp": "1748883236",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:34] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:53:34] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:34] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883214729
[2025-06-02 13:53:34] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjhEODY2RkIyMTAwMTM3MDYyMQA=",
                "status": "delivered",
                "timestamp": "1748883237",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:34] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:53:35] debug: [extractByIA] Resultado IA: Desculpe, n√£o foi mencionado nenhum desconto na sua declara√ß√£o.
[2025-06-02 13:53:35] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-06-02 13:53:35] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-06-02 13:53:35] debug: [extractByIA] Resultado IA: pix
[2025-06-02 13:53:35] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-06-02 13:53:37] debug: [extractByIA] Resultado IA: N√£o, o cliente n√£o confirmou o fechamento.
[2025-06-02 13:53:37] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-06-02 13:53:38] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o consigo ajudar com isso.
[2025-06-02 13:53:38] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 39 mensagens.
[2025-06-02 13:53:38] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-06-02 13:53:38] debug: [handleMessage] [exec-1748883193834] Validando checklist de fechamento...
[2025-06-02 13:53:38] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-06-02 13:53:38] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-06-02 13:53:38] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-06-02 13:53:38] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-06-02 13:53:38] warn: [conversationManager] [exec-1748883193834] ‚ùå Fechamento bloqueado ‚Äî campos ausentes ou contradit√≥rios: address, schedule_time, confirmacao
[2025-06-02 13:53:38] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4736ms
[2025-06-02 13:53:39] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:39] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883219094
[2025-06-02 13:53:39] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZBNzYzRjVGMTg0NUFBNjE0REQ2MzQ5QUE0OENFNTUyAA==",
                "timestamp": "1748883215",
                "text": {
                  "body": "Vou oagar nonpix"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:39] debug: üì• Mensagem recebida: [object Object]
[2025-06-02 13:53:39] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748883219094
[2025-06-02 13:53:39] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDZBNzYzRjVGMTg0NUFBNjE0REQ2MzQ5QUE0OENFNTUyAA==
[2025-06-02 13:53:39] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:53:39] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Felipe Lamuriel" mesmo?" Timestamp=1748883219558
[2025-06-02 13:53:39] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:53:39] debug: [whatsapp] Conte√∫do da mensagem: "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© "Felipe Lamuriel" mesmo?"
[2025-06-02 13:53:39] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üßê Voc√™ me disse outro nome antes... Posso confirmar que agora √© \"Felipe Lamuriel\" mesmo?"
  }
}
[2025-06-02 13:53:39] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:53:40] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:53:40] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJGQTRBRThFRTY5MTJCMUIzMgA="
    }
  ]
}
[2025-06-02 13:53:40] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:53:41] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:41] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883221285
[2025-06-02 13:53:41] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJGQTRBRThFRTY5MTJCMUIzMgA=",
                "status": "delivered",
                "timestamp": "1748883243",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:41] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:53:41] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:53:41] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883221390
[2025-06-02 13:53:41] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJGQTRBRThFRTY5MTJCMUIzMgA=",
                "status": "sent",
                "timestamp": "1748883243",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:53:41] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:53:43] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-06-02 13:53:43] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "üö´ Ainda n√£o posso encerrar seu atendimento.
Faltam os seguintes dados: address, schedule_time, confirmacao.
Vamos resolver isso antes de seguir para o fechamento. üòâ" Timestamp=1748883223209
[2025-06-02 13:53:43] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-06-02 13:53:43] debug: [whatsapp] Conte√∫do da mensagem: "üö´ Ainda n√£o posso encerrar seu atendimento.
Faltam os seguintes dados: address, schedule_time, confirmacao.
Vamos resolver isso antes de seguir para o fechamento. üòâ"
[2025-06-02 13:53:43] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "üö´ Ainda n√£o posso encerrar seu atendimento.\nFaltam os seguintes dados: address, schedule_time, confirmacao.\nVamos resolver isso antes de seguir para o fechamento. üòâ"
  }
}
[2025-06-02 13:53:43] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-06-02 13:53:43] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-06-02 13:53:43] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjREOEQ4QzUyODNBOEI3RjI0MgA="
    }
  ]
}
[2025-06-02 13:53:43] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-06-02 13:53:44] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:44] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:45] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:45] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:46] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:46] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:48] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:53:48] warn: [rateLimiter] Bloqueado por excesso de requisi√ß√µes IP=::1 {
  "method": "POST",
  "path": "/webhook"
}
[2025-06-02 13:54:11] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:54:11] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883251755
[2025-06-02 13:54:11] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjREOEQ4QzUyODNBOEI3RjI0MgA=",
                "status": "sent",
                "timestamp": "1748883247",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "expiration_timestamp": "1748968260",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:54:11] info: ‚ö° Evento de status recebido, ignorando.
[2025-06-02 13:54:15] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-06-02 13:54:15] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748883255409
[2025-06-02 13:54:15] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjREOEQ4QzUyODNBOEI3RjI0MgA=",
                "status": "delivered",
                "timestamp": "1748883247",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "00f54a0d7481f36c0af2363c920d62d0",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-06-02 13:54:15] info: ‚ö° Evento de status recebido, ignorando.
