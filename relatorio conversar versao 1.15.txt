Microsoft Windows [vers√£o 10.0.19045.5854]
(c) Microsoft Corporation. Todos os direitos reservados.

C:\Users\Usuario>cd C:\projetos\whatsapp-chatgpt-bot

C:\projetos\whatsapp-chatgpt-bot>npm run dev

> whatsapp-chatgpt-bot@1.1.0 dev
> ts-node-dev --respawn src/server.ts

[INFO] 17:45:15 ts-node-dev ver. 2.0.0 (using ts-node ver. 10.9.2, typescript ver. 5.8.3)
[2025-05-31 17:45:29] info: [env] ‚úÖ Vari√°veis de ambiente carregadas com sucesso
[2025-05-31 17:45:30] info: [db] Pool de conex√£o criado para banco: bot_whatsapp
[2025-05-31 17:45:31] info: [openai] Inicializando cliente OpenAI
[2025-05-31 17:45:39] info: [bootstrap] üåç Ambiente: development
[2025-05-31 17:45:39] info: [bootstrap] üì° Iniciando servidor na porta 3000...
[2025-05-31 17:45:39] debug: [bootstrap] üîÑ Criando pool do MySQL...
[2025-05-31 17:45:39] debug: [db] createDbPool() chamado
[2025-05-31 17:45:39] debug: [bootstrap] üîÑ Testando conex√£o MySQL...
[2025-05-31 17:45:39] info: [db] ‚úÖ Conex√£o com o banco de dados bem-sucedida: {
  "0": {
    "1": 1
  }
}
[2025-05-31 17:45:39] debug: [bootstrap] ‚úÖ MySQL conectado com sucesso
[2025-05-31 17:45:39] debug: [bootstrap] üîÑ Conectando ao MongoDB...
[2025-05-31 17:45:39] debug: [mongo] ‚è≥ Conectando ao MongoDB em: mongodb://localhost:27017/bot_whatsapp
[2025-05-31 17:45:39] info: [mongo] ‚úÖ Conectado com sucesso ao MongoDB: mongodb://localhost:27017/bot_whatsapp
[2025-05-31 17:45:39] debug: [bootstrap] ‚úÖ MongoDB conectado com sucesso
[2025-05-31 17:45:39] debug: [bootstrap] üöß Criando app Express...
[2025-05-31 17:45:39] info: [app] Inicializando aplica√ß√£o Express
[2025-05-31 17:45:39] debug: [app] Helmet aplicado
[2025-05-31 17:45:39] debug: [app] CORS habilitado
[2025-05-31 17:45:39] debug: [app] bodyParser JSON registrado
[2025-05-31 17:45:39] debug: [app] rateLimiterMiddleware aplicado
[2025-05-31 17:45:39] info: [app] Swagger UI dispon√≠vel em /api-docs
[2025-05-31 17:45:39] debug: [app] Rota /webhook registrada
[2025-05-31 17:45:39] debug: [app] errorMiddleware registrado
[2025-05-31 17:45:39] info: [app] Aplica√ß√£o configurada com sucesso
[2025-05-31 17:45:39] info: [bootstrap] üöÄ Servidor rodando em http://localhost:3000
[2025-05-31 17:45:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:45:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724345806
[2025-05-31 17:45:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjlGNjk1NDE5QTNERjY3M0ZENAA=",
                "status": "delivered",
                "timestamp": "1748724367",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:45:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:45:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:45:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724345828
[2025-05-31 17:45:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjlGNjk1NDE5QTNERjY3M0ZENAA=",
                "status": "sent",
                "timestamp": "1748724366",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:45:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:45:57] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:45:57] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724357847
[2025-05-31 17:45:57] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEM1MjE1RTEzOEEyNTFBNTE5RUY5ODEyMzQxRDAxQjEzAA==",
                "timestamp": "1748724379",
                "text": {
                  "body": "Ol√°"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:45:57] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:45:57] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724357847
[2025-05-31 17:45:57] debug: [webhook] Texto recebido: Ol√°
[2025-05-31 17:45:57] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ol√°"
[2025-05-31 17:45:57] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724357864) para 5512988256404
[2025-05-31 17:45:57] debug: [handleMessage] [exec-1748724357864] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ol√°", isAudio=false
[2025-05-31 17:45:57] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:45:57] debug: [ClientRepository] Ignorando nome padr√£o "Cliente" ‚Äî ser√° tratado como null
[2025-05-31 17:45:57] info: [handleMessage] [exec-1748724357864] Estado atual do cliente: fechamento
[2025-05-31 17:45:57] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:45:57] warn: [aiStateDecider] üöß Nome do cliente ainda n√£o identificado ‚Äî For√ßando etapa 'abordagem'
[2025-05-31 17:45:57] info: [handleMessage] [exec-1748724357864] Estado sugerido pela IA: abordagem
[2025-05-31 17:45:57] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí abordagem
[2025-05-31 17:45:57] debug: [ClientRepository] current_state atualizado para 'abordagem' e retries resetado
[2025-05-31 17:45:57] info: [handleMessage] [exec-1748724357864] Estado atualizado: fechamento ‚Üí abordagem
[2025-05-31 17:45:57] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 6 mensagens.
[2025-05-31 17:45:57] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:45:57] info: [validadorMultiplos] [exec-1748724357864] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'abordagem'
[2025-05-31 17:45:57] info: [validadorMultiplos] [exec-1748724357864] üß© Validando metas da etapa: abordagem
[2025-05-31 17:45:57] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:45:58] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:45:58] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-05-31 17:45:58] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-05-31 17:45:59] debug: [extractName] IA respondeu null ou vazio
[2025-05-31 17:45:59] debug: [validadorMultiplos] [exec-1748724357864] ‚ö†Ô∏è Campo 'name' n√£o identificado no texto.
[2025-05-31 17:45:59] debug: [validadorMultiplos] [exec-1748724357864] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'name': 1856.33ms
[2025-05-31 17:45:59] info: [validadorMultiplos] [exec-1748724357864] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'abordagem'
[2025-05-31 17:45:59] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:45:59] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ol√° {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:46:01] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:46:01] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:46:01] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:46:01] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:46:01] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:46:01] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:46:01] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:46:01] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:46:01] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:46:01] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:46:01] info: [temperatura] üîç Calculando temperatura com base na etapa "abordagem" e perfil do cliente
[2025-05-31 17:46:01] debug: [temperatura] Etapa reconhecida: "abordagem" ‚Üí base inicial: 0.9
[2025-05-31 17:46:01] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:46:01] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:46:01] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:46:01] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:46:01] info: [temperatura] ‚úÖ Temperatura final calculada: 0.95
[2025-05-31 17:46:02] info: [handleMessage] [exec-1748724357864] üîç Texto bruto da IA antes do filtro: Oi! Como posso chamar voc√™? üòä
[2025-05-31 17:46:02] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:46:02] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa abordagem, phone=5512988256404
[2025-05-31 17:46:02] info: [handleMessage] [exec-1748724357864] ‚úÖ Texto final p√≥s-processado: Oi! Como posso chamar voc√™? üòä
[2025-05-31 17:46:03] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:46:03] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:46:03] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:46:03] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4576ms
[2025-05-31 17:46:07] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:46:07] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Oi! Como posso chamar voc√™? üòä" Timestamp=1748724367615
[2025-05-31 17:46:07] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:46:07] debug: [whatsapp] Conte√∫do da mensagem: "Oi! Como posso chamar voc√™? üòä"
[2025-05-31 17:46:07] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Oi! Como posso chamar voc√™? üòä"
  }
}
[2025-05-31 17:46:07] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:46:08] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:46:08] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkEyOEZBMDJFQ0NCRTc5RkY0QQA="
    }
  ]
}
[2025-05-31 17:46:08] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:46:09] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:46:09] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724369350
[2025-05-31 17:46:09] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkEyOEZBMDJFQ0NCRTc5RkY0QQA=",
                "status": "sent",
                "timestamp": "1748724390",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:46:09] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:46:09] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:46:09] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724369586
[2025-05-31 17:46:09] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkEyOEZBMDJFQ0NCRTc5RkY0QQA=",
                "status": "delivered",
                "timestamp": "1748724391",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:46:09] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:46:48] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:46:48] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724408022
[2025-05-31 17:46:48] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDIxNEIxMjVGRDU2N0JCMjYxMUZCRTExODAzMDUyNTk3AA==",
                "timestamp": "1748724429",
                "text": {
                  "body": "Lamuriel"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:46:48] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:46:48] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724408022
[2025-05-31 17:46:48] debug: [webhook] Texto recebido: Lamuriel
[2025-05-31 17:46:48] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Lamuriel"
[2025-05-31 17:46:48] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724408037) para 5512988256404
[2025-05-31 17:46:48] debug: [handleMessage] [exec-1748724408037] üì≤ Iniciando atendimento: phone=5512988256404, texto="Lamuriel", isAudio=false
[2025-05-31 17:46:48] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:46:48] debug: [ClientRepository] Ignorando nome padr√£o "Cliente" ‚Äî ser√° tratado como null
[2025-05-31 17:46:48] info: [handleMessage] [exec-1748724408037] Estado atual do cliente: abordagem
[2025-05-31 17:46:48] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:46:48] warn: [aiStateDecider] üöß Nome do cliente ainda n√£o identificado ‚Äî For√ßando etapa 'abordagem'
[2025-05-31 17:46:48] info: [handleMessage] [exec-1748724408037] Estado sugerido pela IA: abordagem
[2025-05-31 17:46:48] debug: [ClientRepository] Atualizando retries para 5512988256404: 1
[2025-05-31 17:46:48] info: [ClientRepository] retries atualizado para 1 no cliente 5512988256404
[2025-05-31 17:46:48] debug: [handleMessage] [exec-1748724408037] Repeti√ß√£o detectada. Retries incrementado para 1
[2025-05-31 17:46:48] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 7 mensagens.
[2025-05-31 17:46:48] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:46:48] info: [validadorMultiplos] [exec-1748724408037] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'abordagem'
[2025-05-31 17:46:48] info: [validadorMultiplos] [exec-1748724408037] üß© Validando metas da etapa: abordagem
[2025-05-31 17:46:48] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:46:48] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:46:48] debug: [extractNameSmart] Nenhum padr√£o de nome reconhecido via regex
[2025-05-31 17:46:48] debug: [extractName] Tentando extra√ß√£o de nome via IA...
[2025-05-31 17:46:49] debug: [extractName] Nome extra√≠do via IA: Lamuriel
[2025-05-31 17:46:49] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:46:49] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "name"
[2025-05-31 17:46:49] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Lamuriel"
[2025-05-31 17:46:49] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Lamuriel"
[2025-05-31 17:46:49] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:46:50] debug: [validadorIA] üß† Resposta bruta da IA: "sim"
[2025-05-31 17:46:50] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 770ms
[2025-05-31 17:46:50] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "name",
  "valor": "Lamuriel",
  "contexto": "Lamuriel",
  "resposta": "sim",
  "tempo_ms": 770,
  "validado": true
}
[2025-05-31 17:46:50] info: [validadorMultiplos] [exec-1748724408037] ‚úÖ Campo 'name' validado: Lamuriel
[2025-05-31 17:46:50] info: [ClientRepository] Atualizando campo name para 5512988256404: Lamuriel
[2025-05-31 17:46:50] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 1  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 1
}
[2025-05-31 17:46:50] debug: [validadorMultiplos] [exec-1748724408037] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'name': 2186.80ms
[2025-05-31 17:46:50] info: [validadorMultiplos] [exec-1748724408037] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'abordagem'
[2025-05-31 17:46:50] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:46:50] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Lamuriel {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:46:51] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 17:46:51] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 17:46:51] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:46:51] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:46:51] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:46:51] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:46:51] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:46:51] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:46:51] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:46:51] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:46:51] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:46:51] info: [temperatura] üîç Calculando temperatura com base na etapa "abordagem" e perfil do cliente
[2025-05-31 17:46:51] debug: [temperatura] Etapa reconhecida: "abordagem" ‚Üí base inicial: 0.9
[2025-05-31 17:46:51] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:46:51] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:46:51] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:46:51] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:46:51] info: [temperatura] ‚úÖ Temperatura final calculada: 0.95
[2025-05-31 17:46:52] info: [handleMessage] [exec-1748724408037] üîç Texto bruto da IA antes do filtro: Oi, Lamuriel! Que nome √∫nico voc√™ tem. üòä Est√° pronto para conversar sobre a transforma√ß√£o da sua barba?
[2025-05-31 17:46:52] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:46:52] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa abordagem, phone=5512988256404
[2025-05-31 17:46:52] info: [handleMessage] [exec-1748724408037] ‚úÖ Texto final p√≥s-processado: Oi, Lamuriel! Que nome √∫nico voc√™ tem. üòä Est√° pronto para conversar sobre a transforma√ß√£o da sua barba?
[2025-05-31 17:46:52] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:46:52] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:46:53] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:46:53] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4358ms
[2025-05-31 17:46:57] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:46:57] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Oi, Lamuriel! Que nome √∫nico voc√™ tem. ÔøΩ  Est√° pronto para conversar sobre a transforma√ß√£o da sua barba?" Timestamp=1748724417371
[2025-05-31 17:46:57] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:46:57] debug: [whatsapp] Conte√∫do da mensagem: "Oi, Lamuriel! Que nome √∫nico voc√™ tem. üòä Est√° pronto para conversar sobre a transforma√ß√£o da sua barba?"
[2025-05-31 17:46:57] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Oi, Lamuriel! Que nome √∫nico voc√™ tem. üòä Est√° pronto para conversar sobre a transforma√ß√£o da sua barba?"
  }
}
[2025-05-31 17:46:57] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:46:58] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:46:58] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjQ2RUIwQ0RCNzIwNkVCOTUyRgA="
    }
  ]
}
[2025-05-31 17:46:58] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:46:58] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:46:58] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724418982
[2025-05-31 17:46:58] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjQ2RUIwQ0RCNzIwNkVCOTUyRgA=",
                "status": "sent",
                "timestamp": "1748724440",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:46:58] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:46:59] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:46:59] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724419284
[2025-05-31 17:46:59] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjQ2RUIwQ0RCNzIwNkVCOTUyRgA=",
                "status": "delivered",
                "timestamp": "1748724440",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:46:59] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:47:42] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:47:42] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724462911
[2025-05-31 17:47:42] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdEODkwNDg4NzM3NkNBMDZBODcwOUFFQkJDREQ2NzEzAA==",
                "timestamp": "1748724484",
                "text": {
                  "body": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:47:42] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:47:42] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724462911
[2025-05-31 17:47:42] debug: [webhook] Texto recebido: Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?
[2025-05-31 17:47:42] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
[2025-05-31 17:47:42] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724462927) para 5512988256404
[2025-05-31 17:47:42] debug: [handleMessage] [exec-1748724462927] üì≤ Iniciando atendimento: phone=5512988256404, texto="Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?", isAudio=false
[2025-05-31 17:47:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:47:42] info: [handleMessage] [exec-1748724462927] Estado atual do cliente: abordagem
[2025-05-31 17:47:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:47:42] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:47:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:47:42] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:47:42] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:47:42] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "abordagem",
  "userMessage": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
}
[2025-05-31 17:47:42] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: abordagem\nMensagem do cliente: Pois √©, vi o an√∫"
    }
  ]
}
[2025-05-31 17:47:44] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "levantamento"
}
[2025-05-31 17:47:44] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 340,
    "completion_tokens": 2,
    "total_tokens": 342,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:47:44] info: [aiStateDecider] üß≠ Etapa atual: abordagem ‚Äî IA sugeriu: levantamento
[2025-05-31 17:47:44] info: [handleMessage] [exec-1748724462927] Estado sugerido pela IA: levantamento
[2025-05-31 17:47:44] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí levantamento
[2025-05-31 17:47:44] debug: [ClientRepository] current_state atualizado para 'levantamento' e retries resetado
[2025-05-31 17:47:44] info: [handleMessage] [exec-1748724462927] Estado atualizado: abordagem ‚Üí levantamento
[2025-05-31 17:47:44] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 8 mensagens.
[2025-05-31 17:47:44] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:47:44] info: [validadorMultiplos] [exec-1748724462927] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'levantamento'
[2025-05-31 17:47:44] info: [validadorMultiplos] [exec-1748724462927] üß© Validando metas da etapa: levantamento
[2025-05-31 17:47:44] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:47:44] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:47:44] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-05-31 17:47:44] debug: [validadorMultiplos] [exec-1748724462927] ‚ö†Ô∏è Campo 'needs' n√£o identificado no texto.
[2025-05-31 17:47:44] debug: [validadorMultiplos] [exec-1748724462927] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'needs': 3.13ms
[2025-05-31 17:47:44] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-05-31 17:47:45] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou qualquer solu√ß√£o que tenha tentado anteriormente.
[2025-05-31 17:47:45] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:47:45] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "attempted_solutions"
[2025-05-31 17:47:45] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O cliente n√£o mencionou qualquer solu√ß√£o que tenha tentado anteriormente."
[2025-05-31 17:47:45] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
[2025-05-31 17:47:45] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:47:46] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:47:46] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 714ms
[2025-05-31 17:47:46] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "attempted_solutions",
  "valor": "O cliente n√£o mencionou qualquer solu√ß√£o que tenha tentado anteriormente.",
  "contexto": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?",
  "resposta": "n√£o.",
  "tempo_ms": 714,
  "validado": false
}
[2025-05-31 17:47:46] warn: [validadorMultiplos] [exec-1748724462927] ‚ùå Campo 'attempted_solutions' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:47:46] info: [ClientRepository] Atualizando campo attempted_solutions para 5512988256404: null
[2025-05-31 17:47:46] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:47:46] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | attempted_solutions
[2025-05-31 17:47:46] debug: [validadorMultiplos] [exec-1748724462927] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'attempted_solutions': 1989.03ms
[2025-05-31 17:47:46] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-05-31 17:47:47] debug: [extractByIA] Resultado IA: Ol√°! Para te auxiliar de maneira mais eficaz, eu preciso saber qual servi√ßo voc√™ est√° se referindo. Poderia me fornecer mais detalidades?
[2025-05-31 17:47:47] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:47:47] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "expectations"
[2025-05-31 17:47:47] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Ol√°! Para te auxiliar de maneira mais eficaz, eu preciso saber qual servi√ßo voc√™ est√° se referindo. Poderia me fornecer mais detalidades?"
[2025-05-31 17:47:47] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
[2025-05-31 17:47:47] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:47:49] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:47:49] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1152ms
[2025-05-31 17:47:49] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "expectations",
  "valor": "Ol√°! Para te auxiliar de maneira mais eficaz, eu preciso saber qual servi√ßo voc√™ est√° se referindo. Poderia me fornecer mais detalidades?",
  "contexto": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?",
  "resposta": "n√£o.",
  "tempo_ms": 1152,
  "validado": false
}
[2025-05-31 17:47:49] warn: [validadorMultiplos] [exec-1748724462927] ‚ùå Campo 'expectations' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:47:49] info: [ClientRepository] Atualizando campo expectations para 5512988256404: null
[2025-05-31 17:47:49] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:47:49] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | expectations
[2025-05-31 17:47:49] debug: [validadorMultiplos] [exec-1748724462927] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'expectations': 3053.25ms
[2025-05-31 17:47:49] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-05-31 17:47:50] debug: [extractByIA] Resultado IA: O n√≠vel de urg√™ncia do cliente n√£o foi especificado na mensagem.
[2025-05-31 17:47:50] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:47:50] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "urgency_level"
[2025-05-31 17:47:50] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O n√≠vel de urg√™ncia do cliente n√£o foi especificado na mensagem."
[2025-05-31 17:47:50] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
[2025-05-31 17:47:50] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:47:51] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-05-31 17:47:51] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 712ms
[2025-05-31 17:47:51] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "urgency_level",
  "valor": "O n√≠vel de urg√™ncia do cliente n√£o foi especificado na mensagem.",
  "contexto": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?",
  "resposta": "n√£o",
  "tempo_ms": 712,
  "validado": false
}
[2025-05-31 17:47:51] warn: [validadorMultiplos] [exec-1748724462927] ‚ùå Campo 'urgency_level' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:47:51] info: [ClientRepository] Atualizando campo urgency_level para 5512988256404: null
[2025-05-31 17:47:51] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:47:51] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | urgency_level
[2025-05-31 17:47:51] debug: [validadorMultiplos] [exec-1748724462927] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'urgency_level': 1934.61ms
[2025-05-31 17:47:51] info: [validadorMultiplos] [exec-1748724462927] Campo 'client_stage' j√° est√° preenchido: O cliente est√° no es. Pulando.
[2025-05-31 17:47:51] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-05-31 17:47:52] debug: [extractByIA] Resultado IA: A mensagem do cliente n√£o especifica uma disponibilidade de hor√°rio.
[2025-05-31 17:47:52] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:47:52] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "disponibilidade"
[2025-05-31 17:47:52] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A mensagem do cliente n√£o especifica uma disponibilidade de hor√°rio."
[2025-05-31 17:47:52] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?"
[2025-05-31 17:47:52] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:47:52] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:47:52] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 685ms
[2025-05-31 17:47:52] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "disponibilidade",
  "valor": "A mensagem do cliente n√£o especifica uma disponibilidade de hor√°rio.",
  "contexto": "Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui?",
  "resposta": "n√£o.",
  "tempo_ms": 685,
  "validado": false
}
[2025-05-31 17:47:52] warn: [validadorMultiplos] [exec-1748724462927] ‚ùå Campo 'disponibilidade' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:47:52] info: [ClientRepository] Atualizando campo disponibilidade para 5512988256404: null
[2025-05-31 17:47:52] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:47:52] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | disponibilidade
[2025-05-31 17:47:52] debug: [validadorMultiplos] [exec-1748724462927] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'disponibilidade': 1903.33ms
[2025-05-31 17:47:52] info: [validadorMultiplos] [exec-1748724462927] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'levantamento'
[2025-05-31 17:47:52] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:47:52] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Pois √©, vi o an√∫ncio. Sou de Taubate, tem por aqui? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:47:53] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:47:53] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:47:53] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:47:53] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:47:53] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:47:53] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:47:53] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:47:53] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:47:53] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:47:53] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:47:53] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:47:53] info: [temperatura] üîç Calculando temperatura com base na etapa "levantamento" e perfil do cliente
[2025-05-31 17:47:53] debug: [temperatura] Etapa reconhecida: "levantamento" ‚Üí base inicial: 0.85
[2025-05-31 17:47:53] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:47:53] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:47:53] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:47:53] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:47:53] info: [temperatura] ‚úÖ Temperatura final calculada: 0.9
[2025-05-31 17:47:55] info: [handleMessage] [exec-1748724462927] üîç Texto bruto da IA antes do filtro: Atualmente, o nosso servi√ßo de micropigmenta√ß√£o de barba √© oferecido exclusivamente em Jacare√≠/SP. Seria vi√°vel para voc√™ deslocar-se at√© l√° para realizar o procedimento?
[2025-05-31 17:47:55] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:47:55] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa levantamento, phone=5512988256404
[2025-05-31 17:47:55] info: [handleMessage] [exec-1748724462927] ‚úÖ Texto final p√≥s-processado: Atualmente, o nosso servi√ßo de micropigmenta√ß√£o de barba √© oferecido exclusivamente em Jacare√≠/SP. Seria vi√°vel para voc√™ deslocar-se at√© l√° para realizar o procedimento?
[2025-05-31 17:47:55] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:47:55] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:47:55] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:47:55] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5764ms
[2025-05-31 17:48:01] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:48:01] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Atualmente, o nosso servi√ßo de micropigmenta√ß√£o de barba √© oferecido exclusivamente em Jacare√≠/SP. Seria vi√°vel para voc√™ deslocar-se at√© l√° para realizar o procedimento?" Timestamp=1748724481468
[2025-05-31 17:48:01] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:48:01] debug: [whatsapp] Conte√∫do da mensagem: "Atualmente, o nosso servi√ßo de micropigmenta√ß√£o de barba √© oferecido exclusivamente em Jacare√≠/SP. Seria vi√°vel para voc√™ deslocar-se at√© l√° para realizar o procedimento?"
[2025-05-31 17:48:01] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Atualmente, o nosso servi√ßo de micropigmenta√ß√£o de barba √© oferecido exclusivamente em Jacare√≠/SP. Seria vi√°vel para voc√™ deslocar-se at√© l√° para realizar o procedimento?"
  }
}
[2025-05-31 17:48:01] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:48:02] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:48:02] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjMzMzI3NzQxMDUwRUMwMkJFMgA="
    }
  ]
}
[2025-05-31 17:48:02] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:48:03] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:48:03] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724483073
[2025-05-31 17:48:03] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjMzMzI3NzQxMDUwRUMwMkJFMgA=",
                "status": "sent",
                "timestamp": "1748724504",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:48:03] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:48:03] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:48:03] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724483319
[2025-05-31 17:48:03] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjMzMzI3NzQxMDUwRUMwMkJFMgA=",
                "status": "delivered",
                "timestamp": "1748724504",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:48:03] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:48:41] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:48:41] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724521959
[2025-05-31 17:48:41] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDVBMTBEMTRCOEJERTg2QTIzMzA0NkMzNjkxMEMzMzI4AA==",
                "timestamp": "1748724543",
                "text": {
                  "body": "Ah sim, consigo. Queria saber mais sobre"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:48:41] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:48:41] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724521959
[2025-05-31 17:48:41] debug: [webhook] Texto recebido: Ah sim, consigo. Queria saber mais sobre
[2025-05-31 17:48:41] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ah sim, consigo. Queria saber mais sobre"
[2025-05-31 17:48:41] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724521974) para 5512988256404
[2025-05-31 17:48:41] debug: [handleMessage] [exec-1748724521974] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ah sim, consigo. Queria saber mais sobre", isAudio=false
[2025-05-31 17:48:41] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:48:41] info: [handleMessage] [exec-1748724521974] Estado atual do cliente: levantamento
[2025-05-31 17:48:41] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:48:42] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:48:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:48:42] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:48:42] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:48:42] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "levantamento",
  "userMessage": "Ah sim, consigo. Queria saber mais sobre"
}
[2025-05-31 17:48:42] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: levantamento\nMensagem do cliente: Ah sim, consi"
    }
  ]
}
[2025-05-31 17:48:42] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "proposta"
}
[2025-05-31 17:48:42] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 331,
    "completion_tokens": 2,
    "total_tokens": 333,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:48:42] info: [aiStateDecider] üß≠ Etapa atual: levantamento ‚Äî IA sugeriu: proposta
[2025-05-31 17:48:42] info: [handleMessage] [exec-1748724521974] Estado sugerido pela IA: proposta
[2025-05-31 17:48:42] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí proposta
[2025-05-31 17:48:42] debug: [ClientRepository] current_state atualizado para 'proposta' e retries resetado
[2025-05-31 17:48:42] info: [handleMessage] [exec-1748724521974] Estado atualizado: levantamento ‚Üí proposta
[2025-05-31 17:48:42] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 9 mensagens.
[2025-05-31 17:48:42] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:48:42] info: [validadorMultiplos] [exec-1748724521974] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'proposta'
[2025-05-31 17:48:42] info: [validadorMultiplos] [exec-1748724521974] üß© Validando metas da etapa: proposta
[2025-05-31 17:48:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:48:42] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:48:42] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:48:42] debug: [validadorMultiplos] [exec-1748724521974] ‚ö†Ô∏è Campo 'budget' n√£o identificado no texto.
[2025-05-31 17:48:42] debug: [validadorMultiplos] [exec-1748724521974] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'budget': 3.42ms
[2025-05-31 17:48:42] info: [validadorMultiplos] [exec-1748724521974] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'proposta'
[2025-05-31 17:48:42] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:48:42] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ah sim, consigo. Queria saber mais sobre {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:48:43] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:48:43] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:48:43] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:48:43] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:48:43] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:48:43] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:48:43] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:48:43] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:48:43] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:48:43] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:48:43] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:48:43] info: [temperatura] üîç Calculando temperatura com base na etapa "proposta" e perfil do cliente
[2025-05-31 17:48:43] debug: [temperatura] Etapa reconhecida: "proposta" ‚Üí base inicial: 0.75
[2025-05-31 17:48:43] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:48:43] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:48:43] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:48:43] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:48:43] info: [temperatura] ‚úÖ Temperatura final calculada: 0.8
[2025-05-31 17:48:46] info: [handleMessage] [exec-1748724521974] üîç Texto bruto da IA antes do filtro: Perfeito, Lamuriel. A micropigmenta√ß√£o vai preencher as falhas na sua barba, garantindo um look mais harm√¥nico todo dia, al√©m de aumentar sua confian√ßa.
[2025-05-31 17:48:46] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:48:46] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa proposta, phone=5512988256404
[2025-05-31 17:48:46] info: [handleMessage] [exec-1748724521974] ‚úÖ Texto final p√≥s-processado: Perfeito, Lamuriel. A micropigmenta√ß√£o vai preencher as falhas na sua barba, garantindo um look mais harm√¥nico todo dia, al√©m de aumentar sua confian√ßa.
[2025-05-31 17:48:46] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:48:46] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:48:46] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:48:46] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5948ms
[2025-05-31 17:48:52] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:48:52] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Perfeito, Lamuriel. A micropigmenta√ß√£o vai preencher as falhas na sua barba, garantindo um look mais harm√¥nico todo dia, al√©m de aumentar sua confian√ßa." Timestamp=1748724532071
[2025-05-31 17:48:52] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:48:52] debug: [whatsapp] Conte√∫do da mensagem: "Perfeito, Lamuriel. A micropigmenta√ß√£o vai preencher as falhas na sua barba, garantindo um look mais harm√¥nico todo dia, al√©m de aumentar sua confian√ßa."
[2025-05-31 17:48:52] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Perfeito, Lamuriel. A micropigmenta√ß√£o vai preencher as falhas na sua barba, garantindo um look mais harm√¥nico todo dia, al√©m de aumentar sua confian√ßa."
  }
}
[2025-05-31 17:48:52] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:48:52] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:48:52] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjNBNEVBOUU3N0ZFQ0JEMzQyNwA="
    }
  ]
}
[2025-05-31 17:48:52] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:48:53] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:48:53] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724533704
[2025-05-31 17:48:53] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjNBNEVBOUU3N0ZFQ0JEMzQyNwA=",
                "status": "sent",
                "timestamp": "1748724555",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:48:53] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:48:54] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:48:54] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724534265
[2025-05-31 17:48:54] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjNBNEVBOUU3N0ZFQ0JEMzQyNwA=",
                "status": "delivered",
                "timestamp": "1748724555",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:48:54] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:49:26] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:49:26] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724566304
[2025-05-31 17:49:26] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEMwRjJEMkNCN0M4MThEREEyMzNFMTk5Rjk1MEJGODlFAA==",
                "timestamp": "1748724587",
                "text": {
                  "body": "E quanto custa o procedimento?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:49:26] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:49:26] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724566304
[2025-05-31 17:49:26] debug: [webhook] Texto recebido: E quanto custa o procedimento?
[2025-05-31 17:49:26] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "E quanto custa o procedimento?"
[2025-05-31 17:49:26] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724566321) para 5512988256404
[2025-05-31 17:49:26] debug: [handleMessage] [exec-1748724566321] üì≤ Iniciando atendimento: phone=5512988256404, texto="E quanto custa o procedimento?", isAudio=false
[2025-05-31 17:49:26] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:49:26] info: [handleMessage] [exec-1748724566321] Estado atual do cliente: proposta
[2025-05-31 17:49:26] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:49:26] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:49:26] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:49:26] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:49:26] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:49:26] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "proposta",
  "userMessage": "E quanto custa o procedimento?"
}
[2025-05-31 17:49:26] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: proposta\nMensagem do cliente: E quanto custa o "
    }
  ]
}
[2025-05-31 17:49:27] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "objecoes"
}
[2025-05-31 17:49:27] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 326,
    "completion_tokens": 3,
    "total_tokens": 329,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:49:27] info: [aiStateDecider] üß≠ Etapa atual: proposta ‚Äî IA sugeriu: objecoes
[2025-05-31 17:49:27] info: [handleMessage] [exec-1748724566321] Estado sugerido pela IA: objecoes
[2025-05-31 17:49:27] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí objecoes
[2025-05-31 17:49:27] debug: [ClientRepository] current_state atualizado para 'objecoes' e retries resetado
[2025-05-31 17:49:27] info: [handleMessage] [exec-1748724566321] Estado atualizado: proposta ‚Üí objecoes
[2025-05-31 17:49:27] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 10 mensagens.
[2025-05-31 17:49:27] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:49:27] info: [validadorMultiplos] [exec-1748724566321] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'objecoes'
[2025-05-31 17:49:27] info: [validadorMultiplos] [exec-1748724566321] üß© Validando metas da etapa: objecoes
[2025-05-31 17:49:27] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:49:27] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:49:27] debug: [extractByIA] Prompt: Qual o tipo de obje√ß√£o apresentada pelo cliente? (pre√ßo, tempo, confian√ßa, etc.)
[2025-05-31 17:49:28] debug: [extractByIA] Resultado IA: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:49:28] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:49:28] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "objection_type"
[2025-05-31 17:49:29] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A obje√ß√£o apresentada pelo cliente √© o pre√ßo."
[2025-05-31 17:49:29] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "E quanto custa o procedimento?"
[2025-05-31 17:49:29] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:49:30] debug: [validadorIA] üß† Resposta bruta da IA: "sim."
[2025-05-31 17:49:30] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1232ms
[2025-05-31 17:49:30] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "objection_type",
  "valor": "A obje√ß√£o apresentada pelo cliente √© o pre√ßo.",
  "contexto": "E quanto custa o procedimento?",
  "resposta": "sim.",
  "tempo_ms": 1232,
  "validado": true
}
[2025-05-31 17:49:30] info: [validadorMultiplos] [exec-1748724566321] ‚úÖ Campo 'objection_type' validado: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:49:30] info: [ClientRepository] Atualizando campo objection_type para 5512988256404: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:49:30] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 1  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 1
}
[2025-05-31 17:49:30] debug: [validadorMultiplos] [exec-1748724566321] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'objection_type': 2459.49ms
[2025-05-31 17:49:30] debug: [extractByIA] Prompt: Extraia o motivo da obje√ß√£o do cliente, de forma direta e resumida.
[2025-05-31 17:49:31] debug: [extractByIA] Resultado IA: O cliente est√° preocupado com o custo do procedimento.
[2025-05-31 17:49:31] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:49:31] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "motivo_obje√ß√£o"
[2025-05-31 17:49:31] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O cliente est√° preocupado com o custo do procedimento."
[2025-05-31 17:49:31] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "E quanto custa o procedimento?"
[2025-05-31 17:49:31] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:49:32] debug: [validadorIA] üß† Resposta bruta da IA: "sim."
[2025-05-31 17:49:32] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 775ms
[2025-05-31 17:49:32] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "motivo_obje√ß√£o",
  "valor": "O cliente est√° preocupado com o custo do procedimento.",
  "contexto": "E quanto custa o procedimento?",
  "resposta": "sim.",
  "tempo_ms": 775,
  "validado": true
}
[2025-05-31 17:49:32] info: [validadorMultiplos] [exec-1748724566321] ‚úÖ Campo 'motivo_obje√ß√£o' validado: O cliente est√° preocupado com o custo do procedimento.
[2025-05-31 17:49:32] info: [ClientRepository] Atualizando campo motivo_obje√ß√£o para 5512988256404: O cliente est√° preocupado com o custo do procedimento.
[2025-05-31 17:49:32] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 1  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 1
}
[2025-05-31 17:49:32] debug: [validadorMultiplos] [exec-1748724566321] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'motivo_obje√ß√£o': 1866.28ms
[2025-05-31 17:49:32] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-05-31 17:49:33] debug: [extractByIA] Resultado IA: A alternativa proposta pelo cliente n√£o foi mencionada no contexto fornecido.
[2025-05-31 17:49:33] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:49:33] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "alternativa"
[2025-05-31 17:49:33] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A alternativa proposta pelo cliente n√£o foi mencionada no contexto fornecido."
[2025-05-31 17:49:33] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "E quanto custa o procedimento?"
[2025-05-31 17:49:33] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:49:34] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-05-31 17:49:34] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1260ms
[2025-05-31 17:49:34] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "alternativa",
  "valor": "A alternativa proposta pelo cliente n√£o foi mencionada no contexto fornecido.",
  "contexto": "E quanto custa o procedimento?",
  "resposta": "n√£o",
  "tempo_ms": 1260,
  "validado": false
}
[2025-05-31 17:49:34] warn: [validadorMultiplos] [exec-1748724566321] ‚ùå Campo 'alternativa' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:49:34] info: [ClientRepository] Atualizando campo alternativa para 5512988256404: null
[2025-05-31 17:49:34] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:49:34] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | alternativa
[2025-05-31 17:49:34] debug: [validadorMultiplos] [exec-1748724566321] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'alternativa': 2409.78ms
[2025-05-31 17:49:34] info: [validadorMultiplos] [exec-1748724566321] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'objecoes'
[2025-05-31 17:49:34] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:49:34] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados E quanto custa o procedimento? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:49:35] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:49:35] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:49:35] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:49:35] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:49:35] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:49:35] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:49:35] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:49:35] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:49:35] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:49:35] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:49:35] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:49:35] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:49:35] info: [temperatura] üîç Calculando temperatura com base na etapa "objecoes" e perfil do cliente
[2025-05-31 17:49:35] warn: [temperatura] Etapa desconhecida: "objecoes". Usando base padr√£o: 0.7
[2025-05-31 17:49:35] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:49:35] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:49:35] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:49:35] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:49:35] info: [temperatura] ‚úÖ Temperatura final calculada: 0.75
[2025-05-31 17:49:37] info: [handleMessage] [exec-1748724566321] üîç Texto bruto da IA antes do filtro: O procedimento de micropigmenta√ß√£o de barba est√° por R$ 497 √† vista ou parcelado em at√© 12x de R$ 43 sem juros.

Posso ajudar com mais alguma informa√ß√£o sobre o processo ou agendar uma avalia√ß√£o gratuita para voc√™?
[2025-05-31 17:49:37] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:49:37] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa objecoes, phone=5512988256404
[2025-05-31 17:49:37] info: [handleMessage] [exec-1748724566321] ‚úÖ Texto final p√≥s-processado: O procedimento de micropigmenta√ß√£o de barba est√° por R$ 497 √† vista ou parcelado em at√© 12x de R$ 43 sem juros. Posso ajudar com mais alguma informa√ß√£o sobre o processo ou agendar uma avalia√ß√£o gratuita para voc√™?
[2025-05-31 17:49:37] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:49:37] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:49:37] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:49:37] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3228ms
[2025-05-31 17:49:40] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:49:40] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "O procedimento de micropigmenta√ß√£o de barba est√° por R$ 497 √† vista ou parcelado em at√© 12x de R$ 43 sem juros. Posso ajudar com mais alguma informa√ß√£o sobre o processo ou agendar uma avalia√ß√£o gratuita para voc√™?" Timestamp=1748724580714
[2025-05-31 17:49:40] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:49:40] debug: [whatsapp] Conte√∫do da mensagem: "O procedimento de micropigmenta√ß√£o de barba est√° por R$ 497 √† vista ou parcelado em at√© 12x de R$ 43 sem juros. Posso ajudar com mais alguma informa√ß√£o sobre o processo ou agendar uma avalia√ß√£o gratuita para voc√™?"
[2025-05-31 17:49:40] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "O procedimento de micropigmenta√ß√£o de barba est√° por R$ 497 √† vista ou parcelado em at√© 12x de R$ 43 sem juros. Posso ajudar com mais alguma informa√ß√£o sobre o processo ou agendar uma avalia√ß√£o gratuita para voc√™?"
  }
}
[2025-05-31 17:49:40] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:49:41] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:49:41] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkNCMjc4NEE2MDZENkVFQTU5RQA="
    }
  ]
}
[2025-05-31 17:49:41] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:49:42] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:49:42] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724582340
[2025-05-31 17:49:42] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkNCMjc4NEE2MDZENkVFQTU5RQA=",
                "status": "sent",
                "timestamp": "1748724603",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:49:42] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:49:42] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:49:42] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724582491
[2025-05-31 17:49:42] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkNCMjc4NEE2MDZENkVFQTU5RQA=",
                "status": "delivered",
                "timestamp": "1748724603",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:49:42] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:50:40] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:40] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724640960
[2025-05-31 17:50:40] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDdFMkUxRkI2RkQ0NzdDMkNGQ0M5NUU5QkQwMUU0OTQxAA==",
                "timestamp": "1748724662",
                "text": {
                  "body": "Hummmm"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:40] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:50:40] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724640960
[2025-05-31 17:50:40] debug: [webhook] Texto recebido: Hummmm
[2025-05-31 17:50:40] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Hummmm"
[2025-05-31 17:50:40] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724640977) para 5512988256404
[2025-05-31 17:50:40] debug: [handleMessage] [exec-1748724640977] üì≤ Iniciando atendimento: phone=5512988256404, texto="Hummmm", isAudio=false
[2025-05-31 17:50:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:40] info: [handleMessage] [exec-1748724640977] Estado atual do cliente: objecoes
[2025-05-31 17:50:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:41] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:50:41] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:41] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:50:41] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:50:41] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:50:41] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "objecoes",
  "userMessage": "Hummmm"
}
[2025-05-31 17:50:41] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: objecoes\nMensagem do cliente: Hummmm\nüìå DADOS J"
    }
  ]
}
[2025-05-31 17:50:42] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 17:50:42] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 343,
    "completion_tokens": 3,
    "total_tokens": 346,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:50:42] info: [aiStateDecider] üß≠ Etapa atual: objecoes ‚Äî IA sugeriu: negociacao
[2025-05-31 17:50:42] info: [handleMessage] [exec-1748724640977] Estado sugerido pela IA: negociacao
[2025-05-31 17:50:42] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-05-31 17:50:42] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-05-31 17:50:42] info: [handleMessage] [exec-1748724640977] Estado atualizado: objecoes ‚Üí negociacao
[2025-05-31 17:50:42] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 11 mensagens.
[2025-05-31 17:50:42] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:50:42] info: [validadorMultiplos] [exec-1748724640977] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 17:50:42] info: [validadorMultiplos] [exec-1748724640977] üß© Validando metas da etapa: negociacao
[2025-05-31 17:50:42] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:42] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:50:42] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:50:42] debug: [validadorMultiplos] [exec-1748724640977] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 17:50:42] debug: [validadorMultiplos] [exec-1748724640977] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 3.32ms
[2025-05-31 17:50:42] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-05-31 17:50:43] debug: [extractByIA] Resultado IA: A resposta n√£o est√° clara. Poderia ser interpretado como um "talvez".
[2025-05-31 17:50:43] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:50:43] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "purchase_intent"
[2025-05-31 17:50:43] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A resposta n√£o est√° clara. Poderia ser interpretado como um "talvez"."
[2025-05-31 17:50:43] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Hummmm"
[2025-05-31 17:50:43] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:50:44] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:50:44] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1288ms
[2025-05-31 17:50:44] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "purchase_intent",
  "valor": "A resposta n√£o est√° clara. Poderia ser interpretado como um \"talvez\".",
  "contexto": "Hummmm",
  "resposta": "n√£o.",
  "tempo_ms": 1288,
  "validado": false
}
[2025-05-31 17:50:44] warn: [validadorMultiplos] [exec-1748724640977] ‚ùå Campo 'purchase_intent' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:50:44] info: [ClientRepository] Atualizando campo purchase_intent para 5512988256404: null
[2025-05-31 17:50:44] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:50:44] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | purchase_intent
[2025-05-31 17:50:44] debug: [validadorMultiplos] [exec-1748724640977] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'purchase_intent': 2422.31ms
[2025-05-31 17:50:44] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 17:50:46] debug: [extractByIA] Resultado IA: Voc√™ n√£o forneceu nenhuma informa√ß√£o para eu extrair um valor percentual de desconto. Por favor, forne√ßa mais detalhes.
[2025-05-31 17:50:46] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 17:50:46] debug: [validadorMultiplos] [exec-1748724640977] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 17:50:46] debug: [validadorMultiplos] [exec-1748724640977] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1709.62ms
[2025-05-31 17:50:46] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 17:50:47] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:47] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724647198
[2025-05-31 17:50:47] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIERBOEFCRDg4N0Q4QjQ5QjRGRkQ5MjM3QzU4RkJFRUYzAA==",
                "timestamp": "1748724668",
                "text": {
                  "body": "Tem desconto no pix?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:47] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:50:47] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724647198
[2025-05-31 17:50:47] debug: [webhook] Texto recebido: Tem desconto no pix?
[2025-05-31 17:50:47] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Tem desconto no pix?"
[2025-05-31 17:50:47] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724647213) para 5512988256404
[2025-05-31 17:50:47] debug: [handleMessage] [exec-1748724647213] üì≤ Iniciando atendimento: phone=5512988256404, texto="Tem desconto no pix?", isAudio=false
[2025-05-31 17:50:47] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:47] info: [handleMessage] [exec-1748724647213] Estado atual do cliente: negociacao
[2025-05-31 17:50:47] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:47] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:50:47] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:47] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:50:47] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:50:47] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:50:47] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Tem desconto no pix?"
}
[2025-05-31 17:50:47] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Tem desconto no"
    }
  ]
}
[2025-05-31 17:50:47] debug: [extractByIA] Resultado IA: N√£o foi mencionada nenhuma forma de pagamento no texto fornecido.
[2025-05-31 17:50:47] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:50:47] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 17:50:47] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "N√£o foi mencionada nenhuma forma de pagamento no texto fornecido."
[2025-05-31 17:50:47] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Hummmm"
[2025-05-31 17:50:47] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:50:48] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-05-31 17:50:48] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 345,
    "completion_tokens": 3,
    "total_tokens": 348,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:50:48] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-05-31 17:50:48] info: [handleMessage] [exec-1748724647213] Estado sugerido pela IA: fechamento
[2025-05-31 17:50:48] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-05-31 17:50:48] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-05-31 17:50:48] info: [handleMessage] [exec-1748724647213] Estado atualizado: negociacao ‚Üí fechamento
[2025-05-31 17:50:48] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 11 mensagens.
[2025-05-31 17:50:48] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:50:48] info: [validadorMultiplos] [exec-1748724647213] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'fechamento'
[2025-05-31 17:50:48] info: [validadorMultiplos] [exec-1748724647213] üß© Validando metas da etapa: fechamento
[2025-05-31 17:50:48] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:48] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:50:48] info: [validadorMultiplos] [exec-1748724647213] Campo 'address' n√£o se aplica ao produto 'produto1'. Salvando null.
[2025-05-31 17:50:48] info: [ClientRepository] Atualizando campo address para 5512988256404: null
[2025-05-31 17:50:48] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:50:48] error: [mongo] ‚ùå Erro ao salvar campo rejeitado {
  "error": {
    "errors": {
      "valor": {
        "name": "ValidatorError",
        "message": "Path `valor` is required.",
        "properties": {
          "message": "Path `valor` is required.",
          "type": "required",
          "path": "valor",
          "value": null
        },
        "kind": "required",
        "path": "valor",
        "value": null
      }
    },
    "_message": "Rejection validation failed",
    "name": "ValidationError",
    "message": "Rejection validation failed: valor: Path `valor` is required."
  },
  "data": {
    "phone": "5512988256404",
    "clientId": 4,
    "campo": "address",
    "valor": null,
    "motivo": "Campo n√£o aplic√°vel ao produto",
    "messageIn": "Tem desconto no pix?",
    "createdAt": "2025-05-31T20:50:48.310Z"
  }
}
[2025-05-31 17:50:48] debug: [extractPaymentMethod] Forma de pagamento encontrada: pix
[2025-05-31 17:50:48] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:50:48] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "payment_method"
[2025-05-31 17:50:48] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "pix"
[2025-05-31 17:50:48] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Tem desconto no pix?"
[2025-05-31 17:50:48] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:50:48] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-05-31 17:50:48] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 757ms
[2025-05-31 17:50:48] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "N√£o foi mencionada nenhuma forma de pagamento no texto fornecido.",
  "contexto": "Hummmm",
  "resposta": "n√£o",
  "tempo_ms": 757,
  "validado": false
}
[2025-05-31 17:50:48] warn: [validadorMultiplos] [exec-1748724640977] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:50:48] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 17:50:48] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:50:48] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 17:50:48] debug: [validadorMultiplos] [exec-1748724640977] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 2357.35ms
[2025-05-31 17:50:48] info: [validadorMultiplos] [exec-1748724640977] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 17:50:48] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:50:48] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Hummmm {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:50:49] debug: [validadorIA] üß† Resposta bruta da IA: "sim"
[2025-05-31 17:50:49] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 768ms
[2025-05-31 17:50:49] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "payment_method",
  "valor": "pix",
  "contexto": "Tem desconto no pix?",
  "resposta": "sim",
  "tempo_ms": 768,
  "validado": true
}
[2025-05-31 17:50:49] info: [validadorMultiplos] [exec-1748724647213] ‚úÖ Campo 'payment_method' validado: pix
[2025-05-31 17:50:49] info: [ClientRepository] Atualizando campo payment_method para 5512988256404: pix
[2025-05-31 17:50:49] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 1  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 1
}
[2025-05-31 17:50:49] debug: [validadorMultiplos] [exec-1748724647213] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'payment_method': 791.67ms
[2025-05-31 17:50:49] debug: [validadorMultiplos] [exec-1748724647213] ‚ö†Ô∏è Campo 'schedule_time' n√£o identificado no texto.
[2025-05-31 17:50:49] debug: [validadorMultiplos] [exec-1748724647213] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'schedule_time': 1.81ms
[2025-05-31 17:50:49] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 17:50:49] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:50:49] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:50:49] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:50:49] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:50:49] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:49] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:50:49] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:50:49] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:50:49] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:50:49] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:50:49] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:50:49] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:50:49] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 17:50:49] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 17:50:49] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:50:49] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:50:49] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:50:49] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:50:49] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 17:50:50] debug: [extractByIA] Resultado IA: Desculpe, mas isso n√£o responde a minha pergunta. O cliente confirmou o fechamento?
[2025-05-31 17:50:50] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:50:50] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "confirmacao"
[2025-05-31 17:50:50] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas isso n√£o responde a minha pergunta. O cliente confirmou o fechamento?"
[2025-05-31 17:50:50] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Tem desconto no pix?"
[2025-05-31 17:50:50] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:50:51] info: [handleMessage] [exec-1748724640977] üîç Texto bruto da IA antes do filtro: Lamuriel, parece que voc√™ ainda est√° ponderando sobre a micropigmenta√ß√£o de barba. O que especificamente est√° te fazendo hesitar?
[2025-05-31 17:50:51] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:50:51] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 17:50:51] info: [handleMessage] [exec-1748724640977] ‚úÖ Texto final p√≥s-processado: Lamuriel, parece que voc√™ ainda est√° ponderando sobre a micropigmenta√ß√£o de barba. O que especificamente est√° te fazendo hesitar?
[2025-05-31 17:50:51] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:50:51] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:50:51] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:50:51] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5849ms
[2025-05-31 17:50:51] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:50:51] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1299ms
[2025-05-31 17:50:51] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "confirmacao",
  "valor": "Desculpe, mas isso n√£o responde a minha pergunta. O cliente confirmou o fechamento?",
  "contexto": "Tem desconto no pix?",
  "resposta": "n√£o.",
  "tempo_ms": 1299,
  "validado": false
}
[2025-05-31 17:50:51] warn: [validadorMultiplos] [exec-1748724647213] ‚ùå Campo 'confirmacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:50:51] info: [ClientRepository] Atualizando campo confirmacao para 5512988256404: null
[2025-05-31 17:50:51] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:50:51] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | confirmacao
[2025-05-31 17:50:51] debug: [validadorMultiplos] [exec-1748724647213] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'confirmacao': 2617.04ms
[2025-05-31 17:50:51] info: [validadorMultiplos] [exec-1748724647213] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'fechamento'
[2025-05-31 17:50:51] debug: [metaPorEtapa] üîç Metas esperadas para etapa "negociacao": negotiated_price, purchase_intent, desconto, forma_pagamento
[2025-05-31 17:50:51] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: negociacao
[2025-05-31 17:50:51] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:50:51] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:50:51] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:50:51] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-05-31 17:50:51] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:50:51] info: [handleMessage] [exec-1748724647213] üìã Checklist fechamento: {
  "aprovado": false,
  "faltando": [
    "address",
    "payment_method",
    "schedule_time",
    "confirmacao"
  ],
  "contradicoes": []
}
[2025-05-31 17:50:51] info: [handleMessage] [exec-1748724647213] ‚ö†Ô∏è Contradi√ß√µes encontradas:
[2025-05-31 17:50:51] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:50:51] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Tem desconto no pix? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:50:52] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "negociacao"
}
[2025-05-31 17:50:52] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "negociacao"
[2025-05-31 17:50:52] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:50:52] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: fechamentoPrompt
[2025-05-31 17:50:52] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:50:52] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:50:52] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:50:52] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:50:52] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:50:52] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:50:52] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:50:52] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:50:52] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:50:52] info: [temperatura] üîç Calculando temperatura com base na etapa "fechamento" e perfil do cliente
[2025-05-31 17:50:52] debug: [temperatura] Etapa reconhecida: "fechamento" ‚Üí base inicial: 0.4
[2025-05-31 17:50:52] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:50:52] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:50:52] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:50:52] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:50:52] info: [temperatura] ‚úÖ Temperatura final calculada: 0.45
[2025-05-31 17:50:54] info: [handleMessage] [exec-1748724647213] üîç Texto bruto da IA antes do filtro: O valor √† vista via PIX j√° est√° com o melhor pre√ßo que podemos oferecer, R$ 497. Posso confirmar seu agendamento para a micropigmenta√ß√£o de barba?
[2025-05-31 17:50:54] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:50:54] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa fechamento, phone=5512988256404
[2025-05-31 17:50:54] info: [handleMessage] [exec-1748724647213] ‚úÖ Texto final p√≥s-processado: O valor √† vista via PIX j√° est√° com o melhor pre√ßo que podemos oferecer, R$ 497. Posso confirmar seu agendamento para a micropigmenta√ß√£o de barba?
[2025-05-31 17:50:54] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:50:54] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:50:54] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:50:54] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3842ms
[2025-05-31 17:50:57] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:50:57] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Lamuriel, parece que voc√™ ainda est√° ponderando sobre a micropigmenta√ß√£o de barba. O que especificamente est√° te fazendo hesitar?" Timestamp=1748724657237
[2025-05-31 17:50:57] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:50:57] debug: [whatsapp] Conte√∫do da mensagem: "Lamuriel, parece que voc√™ ainda est√° ponderando sobre a micropigmenta√ß√£o de barba. O que especificamente est√° te fazendo hesitar?"
[2025-05-31 17:50:57] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Lamuriel, parece que voc√™ ainda est√° ponderando sobre a micropigmenta√ß√£o de barba. O que especificamente est√° te fazendo hesitar?"
  }
}
[2025-05-31 17:50:57] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:50:57] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:50:57] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjZENDRFOUVCNjA2OUFFQUFDNAA="
    }
  ]
}
[2025-05-31 17:50:58] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:50:58] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:50:58] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "O valor √† vista via PIX j√° est√° com o melhor pre√ßo que podemos oferecer, R$ 497. Posso confirmar seu agendamento para a micropigmenta√ß√£o de barba?" Timestamp=1748724658160
[2025-05-31 17:50:58] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:50:58] debug: [whatsapp] Conte√∫do da mensagem: "O valor √† vista via PIX j√° est√° com o melhor pre√ßo que podemos oferecer, R$ 497. Posso confirmar seu agendamento para a micropigmenta√ß√£o de barba?"
[2025-05-31 17:50:58] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "O valor √† vista via PIX j√° est√° com o melhor pre√ßo que podemos oferecer, R$ 497. Posso confirmar seu agendamento para a micropigmenta√ß√£o de barba?"
  }
}
[2025-05-31 17:50:58] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:50:58] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:58] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724658803
[2025-05-31 17:50:58] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjZENDRFOUVCNjA2OUFFQUFDNAA=",
                "status": "sent",
                "timestamp": "1748724680",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:58] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:50:58] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:50:58] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjU1NTc0QUU4NkU5NTE2M0Q3NAA="
    }
  ]
}
[2025-05-31 17:50:58] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:50:58] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:58] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724658947
[2025-05-31 17:50:58] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjZENDRFOUVCNjA2OUFFQUFDNAA=",
                "status": "delivered",
                "timestamp": "1748724680",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:58] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:50:59] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:59] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724659669
[2025-05-31 17:50:59] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjU1NTc0QUU4NkU5NTE2M0Q3NAA=",
                "status": "sent",
                "timestamp": "1748724681",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:59] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:50:59] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:50:59] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724659886
[2025-05-31 17:50:59] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjU1NTc0QUU4NkU5NTE2M0Q3NAA=",
                "status": "delivered",
                "timestamp": "1748724681",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:50:59] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:51:38] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:51:38] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724698753
[2025-05-31 17:51:38] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEFDRjkzODUxNjY3M0Y3MEEzMEJCMERCRTFEMjkzQkM4AA==",
                "timestamp": "1748724720",
                "text": {
                  "body": "N√£o sei, t√¥ meio indeciso"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:51:38] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:51:38] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724698753
[2025-05-31 17:51:38] debug: [webhook] Texto recebido: N√£o sei, t√¥ meio indeciso
[2025-05-31 17:51:38] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "N√£o sei, t√¥ meio indeciso"
[2025-05-31 17:51:38] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724698794) para 5512988256404
[2025-05-31 17:51:38] debug: [handleMessage] [exec-1748724698794] üì≤ Iniciando atendimento: phone=5512988256404, texto="N√£o sei, t√¥ meio indeciso", isAudio=false
[2025-05-31 17:51:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:51:38] info: [handleMessage] [exec-1748724698794] Estado atual do cliente: fechamento
[2025-05-31 17:51:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:51:38] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:51:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:51:38] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:51:38] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:51:38] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:51:38] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "N√£o sei, t√¥ meio indeciso"
}
[2025-05-31 17:51:38] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: N√£o sei, t√¥ mei"
    }
  ]
}
[2025-05-31 17:51:40] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 17:51:40] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 350,
    "completion_tokens": 3,
    "total_tokens": 353,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:51:40] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: negociacao
[2025-05-31 17:51:40] info: [handleMessage] [exec-1748724698794] Estado sugerido pela IA: negociacao
[2025-05-31 17:51:40] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-05-31 17:51:40] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-05-31 17:51:40] info: [handleMessage] [exec-1748724698794] Estado atualizado: fechamento ‚Üí negociacao
[2025-05-31 17:51:40] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 13 mensagens.
[2025-05-31 17:51:40] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:51:40] info: [validadorMultiplos] [exec-1748724698794] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 17:51:40] info: [validadorMultiplos] [exec-1748724698794] üß© Validando metas da etapa: negociacao
[2025-05-31 17:51:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:51:40] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:51:40] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:51:40] debug: [validadorMultiplos] [exec-1748724698794] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 17:51:40] debug: [validadorMultiplos] [exec-1748724698794] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 4.49ms
[2025-05-31 17:51:40] debug: [extractByIA] Prompt: Existe inten√ß√£o de compra? Responda com: "sim", "talvez", ou "n√£o".
[2025-05-31 17:51:41] debug: [extractByIA] Resultado IA: Talvez
[2025-05-31 17:51:41] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:51:41] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "purchase_intent"
[2025-05-31 17:51:41] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Talvez"
[2025-05-31 17:51:41] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "N√£o sei, t√¥ meio indeciso"
[2025-05-31 17:51:41] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:51:42] debug: [validadorIA] üß† Resposta bruta da IA: "sim"
[2025-05-31 17:51:42] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1245ms
[2025-05-31 17:51:42] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "purchase_intent",
  "valor": "Talvez",
  "contexto": "N√£o sei, t√¥ meio indeciso",
  "resposta": "sim",
  "tempo_ms": 1245,
  "validado": true
}
[2025-05-31 17:51:42] info: [validadorMultiplos] [exec-1748724698794] ‚úÖ Campo 'purchase_intent' validado: Talvez
[2025-05-31 17:51:42] info: [ClientRepository] Atualizando campo purchase_intent para 5512988256404: Talvez
[2025-05-31 17:51:42] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 1  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 1
}
[2025-05-31 17:51:42] debug: [validadorMultiplos] [exec-1748724698794] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'purchase_intent': 2602.06ms
[2025-05-31 17:51:42] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 17:51:44] debug: [extractByIA] Resultado IA: Desculpe, mas essa frase n√£o mencionou qualquer percentual de desconto para eu extrair.
[2025-05-31 17:51:44] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 17:51:44] debug: [validadorMultiplos] [exec-1748724698794] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 17:51:44] debug: [validadorMultiplos] [exec-1748724698794] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1457.22ms
[2025-05-31 17:51:44] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 17:51:45] debug: [extractByIA] Resultado IA: O cliente n√£o especificou uma forma de pagamento.
[2025-05-31 17:51:45] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:51:45] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 17:51:45] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O cliente n√£o especificou uma forma de pagamento."
[2025-05-31 17:51:45] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "N√£o sei, t√¥ meio indeciso"
[2025-05-31 17:51:45] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:51:46] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:51:46] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 969ms
[2025-05-31 17:51:46] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O cliente n√£o especificou uma forma de pagamento.",
  "contexto": "N√£o sei, t√¥ meio indeciso",
  "resposta": "n√£o.",
  "tempo_ms": 969,
  "validado": false
}
[2025-05-31 17:51:46] warn: [validadorMultiplos] [exec-1748724698794] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:51:46] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 17:51:46] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:51:46] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 17:51:46] debug: [validadorMultiplos] [exec-1748724698794] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 1913.13ms
[2025-05-31 17:51:46] info: [validadorMultiplos] [exec-1748724698794] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 17:51:46] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:51:46] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados N√£o sei, t√¥ meio indeciso {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:51:47] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:51:47] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:51:47] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:51:47] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:51:47] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:51:47] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:51:47] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:51:47] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:51:47] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:51:47] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:51:47] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:51:47] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:51:47] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:51:47] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 17:51:47] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 17:51:47] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:51:47] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:51:47] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:51:47] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:51:47] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 17:51:47] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:51:47] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724707813
[2025-05-31 17:51:47] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjQ3NEQ4QjE3NkZBQUJGQzBFMwA=",
                "status": "delivered",
                "timestamp": "1748724295",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:51:47] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:51:48] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:51:48] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724708340
[2025-05-31 17:51:48] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjQ3NEQ4QjE3NkZBQUJGQzBFMwA=",
                "status": "sent",
                "timestamp": "1748724295",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:51:48] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:51:48] info: [handleMessage] [exec-1748724698794] üîç Texto bruto da IA antes do filtro: Voc√™ poderia compartilhar o que especificamente est√° causando essa indecis√£o?
[2025-05-31 17:51:48] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:51:48] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 17:51:48] warn: [verificadorPropostaNegociacao] ‚ö†Ô∏è Resposta fraca detectada na etapa de negocia√ß√£o:
Telefone: 5512988256404
Temperatura anterior: 0.65
Temperatura ajustada: 0.8500000000000001
Texto gerado: "Voc√™ poderia compartilhar o que especificamente est√° causando essa indecis√£o?"
[2025-05-31 17:51:48] info: [mongo] üß† Log de negocia√ß√£o salvo com sucesso para 5512988256404
[2025-05-31 17:51:48] warn: [handleMessage] [exec-1748724698794] ‚ôªÔ∏è Regenerando resposta com temperatura 0.8500000000000001
[2025-05-31 17:51:50] info: [handleMessage] [exec-1748724698794] üîÅ Nova resposta p√≥s-ajuste: Qual seria o principal motivo da sua indecis√£o, Lamuriel?
[2025-05-31 17:51:50] info: [mongo] üß† Log de negocia√ß√£o salvo com sucesso para 5512988256404
[2025-05-31 17:51:50] info: [handleMessage] [exec-1748724698794] ‚úÖ Texto final p√≥s-processado: Qual seria o principal motivo da sua indecis√£o, Lamuriel?
[2025-05-31 17:51:50] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:51:50] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:51:50] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:51:50] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6037ms
[2025-05-31 17:51:56] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:51:56] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Qual seria o principal motivo da sua indecis√£o, Lamuriel?" Timestamp=1748724716180
[2025-05-31 17:51:56] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:51:56] debug: [whatsapp] Conte√∫do da mensagem: "Qual seria o principal motivo da sua indecis√£o, Lamuriel?"
[2025-05-31 17:51:56] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Qual seria o principal motivo da sua indecis√£o, Lamuriel?"
  }
}
[2025-05-31 17:51:56] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:51:56] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:51:56] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxRDY4QzE1QzI0QzgyODI2RgA="
    }
  ]
}
[2025-05-31 17:51:56] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:51:57] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:51:57] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724717624
[2025-05-31 17:51:57] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxRDY4QzE1QzI0QzgyODI2RgA=",
                "status": "sent",
                "timestamp": "1748724739",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:51:57] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:51:57] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:51:57] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724717957
[2025-05-31 17:51:57] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxRDY4QzE1QzI0QzgyODI2RgA=",
                "status": "delivered",
                "timestamp": "1748724739",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:51:57] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:52:34] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:52:34] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724754100
[2025-05-31 17:52:34] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDBCM0U2RUUxMjVDNURFNjBFQkM3OTZEN0UyRTg1RkE3AA==",
                "timestamp": "1748724775",
                "text": {
                  "body": "Se seria um bom investimento, t√¥ com a grana curta"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:52:34] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:52:34] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724754100
[2025-05-31 17:52:34] debug: [webhook] Texto recebido: Se seria um bom investimento, t√¥ com a grana curta
[2025-05-31 17:52:34] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Se seria um bom investimento, t√¥ com a grana curta"
[2025-05-31 17:52:34] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724754116) para 5512988256404
[2025-05-31 17:52:34] debug: [handleMessage] [exec-1748724754116] üì≤ Iniciando atendimento: phone=5512988256404, texto="Se seria um bom investimento, t√¥ com a grana curta", isAudio=false
[2025-05-31 17:52:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:52:34] info: [handleMessage] [exec-1748724754116] Estado atual do cliente: negociacao
[2025-05-31 17:52:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:52:34] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:52:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:52:34] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:52:34] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:52:34] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:52:34] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:52:34] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Se seria um bom investimento, t√¥ com a grana curta"
}
[2025-05-31 17:52:34] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Se seria um bom"
    }
  ]
}
[2025-05-31 17:52:35] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-05-31 17:52:35] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 367,
    "completion_tokens": 3,
    "total_tokens": 370,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:52:35] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-05-31 17:52:35] info: [handleMessage] [exec-1748724754116] Estado sugerido pela IA: fechamento
[2025-05-31 17:52:35] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-05-31 17:52:35] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-05-31 17:52:35] info: [handleMessage] [exec-1748724754116] Estado atualizado: negociacao ‚Üí fechamento
[2025-05-31 17:52:35] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 14 mensagens.
[2025-05-31 17:52:35] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:52:35] info: [validadorMultiplos] [exec-1748724754116] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'fechamento'
[2025-05-31 17:52:35] info: [validadorMultiplos] [exec-1748724754116] üß© Validando metas da etapa: fechamento
[2025-05-31 17:52:35] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:52:35] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:52:35] info: [validadorMultiplos] [exec-1748724754116] Campo 'address' n√£o se aplica ao produto 'produto1'. Salvando null.
[2025-05-31 17:52:35] info: [ClientRepository] Atualizando campo address para 5512988256404: null
[2025-05-31 17:52:35] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:52:35] error: [mongo] ‚ùå Erro ao salvar campo rejeitado {
  "error": {
    "errors": {
      "valor": {
        "name": "ValidatorError",
        "message": "Path `valor` is required.",
        "properties": {
          "message": "Path `valor` is required.",
          "type": "required",
          "path": "valor",
          "value": null
        },
        "kind": "required",
        "path": "valor",
        "value": null
      }
    },
    "_message": "Rejection validation failed",
    "name": "ValidationError",
    "message": "Rejection validation failed: valor: Path `valor` is required."
  },
  "data": {
    "phone": "5512988256404",
    "clientId": 4,
    "campo": "address",
    "valor": null,
    "motivo": "Campo n√£o aplic√°vel ao produto",
    "messageIn": "Se seria um bom investimento, t√¥ com a grana curta",
    "createdAt": "2025-05-31T20:52:35.428Z"
  }
}
[2025-05-31 17:52:35] info: [validadorMultiplos] [exec-1748724754116] Campo 'payment_method' j√° est√° preenchido: pix. Pulando.
[2025-05-31 17:52:35] debug: [validadorMultiplos] [exec-1748724754116] ‚ö†Ô∏è Campo 'schedule_time' n√£o identificado no texto.
[2025-05-31 17:52:35] debug: [validadorMultiplos] [exec-1748724754116] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'schedule_time': 1.43ms
[2025-05-31 17:52:35] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 17:52:36] debug: [extractByIA] Resultado IA: N√£o foi confirmado.
[2025-05-31 17:52:36] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:52:36] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "confirmacao"
[2025-05-31 17:52:36] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "N√£o foi confirmado."
[2025-05-31 17:52:36] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Se seria um bom investimento, t√¥ com a grana curta"
[2025-05-31 17:52:36] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:52:37] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-05-31 17:52:37] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1143ms
[2025-05-31 17:52:37] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "confirmacao",
  "valor": "N√£o foi confirmado.",
  "contexto": "Se seria um bom investimento, t√¥ com a grana curta",
  "resposta": "n√£o",
  "tempo_ms": 1143,
  "validado": false
}
[2025-05-31 17:52:37] warn: [validadorMultiplos] [exec-1748724754116] ‚ùå Campo 'confirmacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:52:37] info: [ClientRepository] Atualizando campo confirmacao para 5512988256404: null
[2025-05-31 17:52:37] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:52:37] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | confirmacao
[2025-05-31 17:52:37] debug: [validadorMultiplos] [exec-1748724754116] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'confirmacao': 2077.07ms
[2025-05-31 17:52:37] info: [validadorMultiplos] [exec-1748724754116] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'fechamento'
[2025-05-31 17:52:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "negociacao": negotiated_price, purchase_intent, desconto, forma_pagamento
[2025-05-31 17:52:37] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: negociacao
[2025-05-31 17:52:37] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:52:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:52:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:52:37] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-05-31 17:52:37] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:52:37] info: [handleMessage] [exec-1748724754116] üìã Checklist fechamento: {
  "aprovado": false,
  "faltando": [
    "address",
    "schedule_time",
    "confirmacao"
  ],
  "contradicoes": []
}
[2025-05-31 17:52:37] info: [handleMessage] [exec-1748724754116] ‚ö†Ô∏è Contradi√ß√µes encontradas:
[2025-05-31 17:52:37] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:52:37] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Se seria um bom investimento, t√¥ com a grana curta {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:52:38] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:52:38] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:52:38] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:52:38] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: fechamentoPrompt
[2025-05-31 17:52:38] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:52:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:52:38] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:52:38] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:52:38] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:52:38] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:52:38] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:52:38] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:52:38] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:52:38] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:52:38] info: [temperatura] üîç Calculando temperatura com base na etapa "fechamento" e perfil do cliente
[2025-05-31 17:52:38] debug: [temperatura] Etapa reconhecida: "fechamento" ‚Üí base inicial: 0.4
[2025-05-31 17:52:38] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:52:38] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:52:38] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:52:38] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:52:38] info: [temperatura] ‚úÖ Temperatura final calculada: 0.45
[2025-05-31 17:52:39] info: [handleMessage] [exec-1748724754116] üîç Texto bruto da IA antes do filtro: A micropigmenta√ß√£o √© um investimento na sua autoestima e imagem, com dura√ß√£o de at√© 1 ano e retoque incluso. Posso ajudar a escolher a melhor forma de pagamento para voc√™?
[2025-05-31 17:52:39] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:52:39] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa fechamento, phone=5512988256404
[2025-05-31 17:52:39] info: [handleMessage] [exec-1748724754116] ‚úÖ Texto final p√≥s-processado: A micropigmenta√ß√£o √© um investimento na sua autoestima e imagem, com dura√ß√£o de at√© 1 ano e retoque incluso. Posso ajudar a escolher a melhor forma de pagamento para voc√™?
[2025-05-31 17:52:39] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:52:39] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:52:39] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:52:39] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5257ms
[2025-05-31 17:52:45] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:52:45] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "A micropigmenta√ß√£o √© um investimento na sua autoestima e imagem, com dura√ß√£o de at√© 1 ano e retoque incluso. Posso ajudar a escolher a melhor forma de pagamento para voc√™?" Timestamp=1748724765150
[2025-05-31 17:52:45] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:52:45] debug: [whatsapp] Conte√∫do da mensagem: "A micropigmenta√ß√£o √© um investimento na sua autoestima e imagem, com dura√ß√£o de at√© 1 ano e retoque incluso. Posso ajudar a escolher a melhor forma de pagamento para voc√™?"
[2025-05-31 17:52:45] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "A micropigmenta√ß√£o √© um investimento na sua autoestima e imagem, com dura√ß√£o de at√© 1 ano e retoque incluso. Posso ajudar a escolher a melhor forma de pagamento para voc√™?"
  }
}
[2025-05-31 17:52:45] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:52:45] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:52:45] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIwNUI1MUY0MkNDNzE5NzdCQgA="
    }
  ]
}
[2025-05-31 17:52:45] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:52:46] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:52:46] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724766659
[2025-05-31 17:52:46] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIwNUI1MUY0MkNDNzE5NzdCQgA=",
                "status": "sent",
                "timestamp": "1748724788",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:52:46] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:52:47] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:52:47] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724767077
[2025-05-31 17:52:47] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIwNUI1MUY0MkNDNzE5NzdCQgA=",
                "status": "delivered",
                "timestamp": "1748724788",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:52:47] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:54:08] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:54:08] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724848348
[2025-05-31 17:54:08] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDhGNEVCMUY2RjEwNThCREM1QUZCRjA3QjZDNkRFQURBAA==",
                "timestamp": "1748724867",
                "type": "audio",
                "audio": {
                  "mime_type": "audio/ogg; codecs=opus",
                  "sha256": "2R22/nOpDgC3Aw4HeHuoutB1lMOXY2tEORq8O6RMnlk=",
                  "id": "1350635969559435",
                  "voice": true
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:54:08] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:54:08] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724848348
[2025-05-31 17:54:08] debug: [whatsapp] Iniciando download de m√≠dia: mediaId=1350635969559435
[2025-05-31 17:54:09] info: [whatsapp] M√≠dia baixada com sucesso: mediaId=1350635969559435
[2025-05-31 17:54:09] debug: [audioService] Iniciando transcri√ß√£o de √°udio
[2025-05-31 17:54:11] info: [audioService] Transcri√ß√£o conclu√≠da com sucesso
[2025-05-31 17:54:11] debug: [webhook] √Åudio transcrito: Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?
[2025-05-31 17:54:11] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?"
[2025-05-31 17:54:11] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724851085) para 5512988256404
[2025-05-31 17:54:11] debug: [handleMessage] [exec-1748724851085] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?", isAudio=true
[2025-05-31 17:54:11] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:54:11] info: [handleMessage] [exec-1748724851085] Estado atual do cliente: fechamento
[2025-05-31 17:54:11] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:54:11] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:54:11] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:54:11] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:54:11] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:54:11] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:54:11] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:54:11] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?"
}
[2025-05-31 17:54:11] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Ah t√°, saquei, "
    }
  ]
}
[2025-05-31 17:54:12] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 17:54:12] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 396,
    "completion_tokens": 3,
    "total_tokens": 399,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:54:12] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: negociacao
[2025-05-31 17:54:12] info: [handleMessage] [exec-1748724851085] Estado sugerido pela IA: negociacao
[2025-05-31 17:54:12] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-05-31 17:54:12] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-05-31 17:54:12] info: [handleMessage] [exec-1748724851085] Estado atualizado: fechamento ‚Üí negociacao
[2025-05-31 17:54:12] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 15 mensagens.
[2025-05-31 17:54:12] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:54:12] info: [validadorMultiplos] [exec-1748724851085] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 17:54:12] info: [validadorMultiplos] [exec-1748724851085] üß© Validando metas da etapa: negociacao
[2025-05-31 17:54:12] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:54:12] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:54:12] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:54:12] debug: [validadorMultiplos] [exec-1748724851085] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 17:54:12] debug: [validadorMultiplos] [exec-1748724851085] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 2.46ms
[2025-05-31 17:54:12] info: [validadorMultiplos] [exec-1748724851085] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-05-31 17:54:12] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 17:54:14] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° informa√ß√µes sobre um valor percentual de desconto em sua consulta. Voc√™ pode fornecer um pouco mais de contexto, por favor?
[2025-05-31 17:54:14] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 17:54:14] debug: [validadorMultiplos] [exec-1748724851085] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 17:54:14] debug: [validadorMultiplos] [exec-1748724851085] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1596.04ms
[2025-05-31 17:54:14] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 17:54:15] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou nenhuma forma de pagamento nesta passagem.
[2025-05-31 17:54:15] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:54:15] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 17:54:15] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O cliente n√£o mencionou nenhuma forma de pagamento nesta passagem."
[2025-05-31 17:54:15] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?"
[2025-05-31 17:54:15] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:54:16] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:54:16] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1158ms
[2025-05-31 17:54:16] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O cliente n√£o mencionou nenhuma forma de pagamento nesta passagem.",
  "contexto": "Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso?",
  "resposta": "n√£o.",
  "tempo_ms": 1158,
  "validado": false
}
[2025-05-31 17:54:16] warn: [validadorMultiplos] [exec-1748724851085] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:54:16] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 17:54:16] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:54:16] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 17:54:16] debug: [validadorMultiplos] [exec-1748724851085] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 2379.79ms
[2025-05-31 17:54:16] info: [validadorMultiplos] [exec-1748724851085] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 17:54:16] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:54:16] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ah t√°, saquei, saquei. Qual que √© o seu nome? Pra gente negociar melhor. Mas eu acho que eu entendi sim. E como que √© esse retoque incluso? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:54:17] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "negociacao"
}
[2025-05-31 17:54:17] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "negociacao"
[2025-05-31 17:54:17] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:54:17] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:54:17] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:54:17] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:54:17] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:54:17] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:54:17] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:54:17] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:54:17] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:54:17] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:54:17] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:54:17] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 17:54:17] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 17:54:17] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:54:17] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:54:17] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:54:17] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:54:17] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 17:54:19] info: [handleMessage] [exec-1748724851085] üîç Texto bruto da IA antes do filtro: Meu nome √© Lamuriel, e o retoque incluso √© uma sess√£o adicional gratuita em at√© 30 dias, para garantir a perfei√ß√£o do procedimento. Alguma outra d√∫vida que eu possa esclarecer?
[2025-05-31 17:54:19] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:54:19] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 17:54:19] info: [handleMessage] [exec-1748724851085] ‚úÖ Texto final p√≥s-processado: Meu nome √© Lamuriel, e o retoque incluso √© uma sess√£o adicional gratuita em at√© 30 dias, para garantir a perfei√ß√£o do procedimento. Alguma outra d√∫vida que eu possa esclarecer?
[2025-05-31 17:54:19] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:54:19] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:54:19] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:54:19] debug: [audioService] Iniciando s√≠ntese de voz: "Meu nome √© Lamuriel, e o retoq..."
[2025-05-31 17:54:19] debug: [audioService] Texto naturalizado: "Meu nome √© Lamuriel, e o retoque incluso √© uma sess√£o adicional gratuita em at√© trinta dias, para garantir a perfei√ß√£o do procedimento. Alguma outra d√∫vida que eu possa esclarecer?"
ffmpeg version 7.1.1-essentials_build-www.gyan.dev Copyright (c) 2000-2025 the FFmpeg developers
  built with gcc 14.2.0 (Rev1, Built by MSYS2 project)
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-bzlib --enable-lzma --enable-zlib --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-sdl2 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-mediafoundation --enable-libass --enable-libfreetype --enable-libfribidi --enable-libharfbuzz --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-dxva2 --enable-d3d11va --enable-d3d12va --enable-ffnvcodec --enable-libvpl --enable-nvdec --enable-nvenc --enable-vaapi --enable-libgme --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libtheora --enable-libvo-amrwbenc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-librubberband
  libavutil      59. 39.100 / 59. 39.100
  libavcodec     61. 19.101 / 61. 19.101
  libavformat    61.  7.100 / 61.  7.100
  libavdevice    61.  3.100 / 61.  3.100
  libavfilter    10.  4.100 / 10.  4.100
  libswscale      8.  3.100 /  8.  3.100
  libswresample   5.  3.100 /  5.  3.100
  libpostproc    58.  3.100 / 58.  3.100
[mp3 @ 0000018f91976200] Estimating duration from bitrate, this may be inaccurate
Input #0, mp3, from 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.mp3':
  Metadata:
    encoder         : Lavf59.27.100
  Duration: 00:00:12.38, start: 0.000000, bitrate: 128 kb/s
  Stream #0:0: Audio: mp3 (mp3float), 44100 Hz, mono, fltp, 128 kb/s
Stream mapping:
  Stream #0:0 -> #0:0 (mp3 (mp3float) -> opus (libopus))
Press [q] to stop, [?] for help
Output #0, ogg, to 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg':
  Metadata:
    encoder         : Lavf61.7.100
  Stream #0:0: Audio: opus, 48000 Hz, mono, flt, 64 kb/s
      Metadata:
        encoder         : Lavc61.19.101 libopus
[out#0/ogg @ 0000018f91990f80] video:0KiB audio:99KiB subtitle:0KiB other streams:0KiB global headers:0KiB muxing overhead: 1.130506%
size=     100KiB time=00:00:12.38 bitrate=  66.3kbits/s speed=39.3x
[2025-05-31 17:54:27] info: [audioService] √Åudio gerado e convertido com sucesso
[2025-05-31 17:54:27] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de √°udio ‚Äî aguardando 6894ms
[2025-05-31 17:54:33] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:54:33] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724873619
[2025-05-31 17:54:33] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDhGNEVCMUY2RjEwNThCREM1QUZCRjA3QjZDNkRFQURBAA==",
                "timestamp": "1748724867",
                "type": "audio",
                "audio": {
                  "mime_type": "audio/ogg; codecs=opus",
                  "sha256": "2R22/nOpDgC3Aw4HeHuoutB1lMOXY2tEORq8O6RMnlk=",
                  "id": "1350635969559435",
                  "voice": true
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:54:33] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:54:33] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724873619
[2025-05-31 17:54:33] warn: [webhook] üö´ Mensagem duplicada detectada: wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDhGNEVCMUY2RjEwNThCREM1QUZCRjA3QjZDNkRFQURBAA==
[2025-05-31 17:54:34] info: [typingSimulator] üöÄ Enviando mensagem de √°udio ap√≥s digita√ß√£o
[2025-05-31 17:54:34] debug: [whatsapp] Enviando √°udio para 5512988256404
[2025-05-31 17:54:34] debug: [whatsapp] üîº Upload de √°udio iniciado para C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-05-31 17:54:34] debug: [whatsapp] Headers do FormData: {
  "Authorization": "Bearer EAARCeDx95qgBO18hTh6VZAfmpZBo7e7vQWEzl7JL5iHRidb72Nb9nu507WVYDiwZCldiIqAT1ZAJERYq4vci3j85WpIOZCCFu39jpNrEcaImi4WjZA0ut1QT4VrHHbNkLTBdwbSK8eZBrZCCATvgXNSZAPllkZANZC6xlys56P8NbzTiiaDvN6oeoiZAfTnU0Gar1LKzZBqQNOiZCRFElFZCScIebTjW3aIIb3LxBFhXU8aicvsXc2BBJORdMMZD",
  "content-type": "multipart/form-data; boundary=--------------------------858989139148563271405965"
}
[2025-05-31 17:54:35] info: [whatsapp] ‚úÖ Upload de √°udio conclu√≠do com media_id: 1402170117738429
[2025-05-31 17:54:36] info: [whatsapp] ‚úÖ √Åudio enviado com sucesso para 5512988256404
[2025-05-31 17:54:36] debug: [whatsapp] üßπ Arquivo tempor√°rio removido: C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-05-31 17:54:36] info: [typingSimulator] ‚úÖ mensagem de √°udio enviada com sucesso
[2025-05-31 17:54:38] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:54:38] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724878050
[2025-05-31 17:54:38] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjNFMzlEODM3ODdDOTNDMjFCOQA=",
                "status": "sent",
                "timestamp": "1748724899",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:54:38] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:54:38] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:54:38] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724878129
[2025-05-31 17:54:38] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjNFMzlEODM3ODdDOTNDMjFCOQA=",
                "status": "delivered",
                "timestamp": "1748724899",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:54:38] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:55:11] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:55:11] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724911707
[2025-05-31 17:55:11] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDFGNkJFQzQ2REQ1QzIzRUVGQUM4REQ1NDM0OEMwOEZEAA==",
                "timestamp": "1748724931",
                "type": "audio",
                "audio": {
                  "mime_type": "audio/ogg; codecs=opus",
                  "sha256": "8r5Ihz3EHpYgEfVw0kTvPGSHkCkw8741Q9nBaxLnZPA=",
                  "id": "1498380381539585",
                  "voice": true
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:55:11] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:55:11] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724911707
[2025-05-31 17:55:11] debug: [whatsapp] Iniciando download de m√≠dia: mediaId=1498380381539585
[2025-05-31 17:55:12] info: [whatsapp] M√≠dia baixada com sucesso: mediaId=1498380381539585
[2025-05-31 17:55:12] debug: [audioService] Iniciando transcri√ß√£o de √°udio
[2025-05-31 17:55:14] info: [audioService] Transcri√ß√£o conclu√≠da com sucesso
[2025-05-31 17:55:14] debug: [webhook] √Åudio transcrito: Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?
[2025-05-31 17:55:14] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?"
[2025-05-31 17:55:14] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724914795) para 5512988256404
[2025-05-31 17:55:14] debug: [handleMessage] [exec-1748724914795] üì≤ Iniciando atendimento: phone=5512988256404, texto="Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?", isAudio=true
[2025-05-31 17:55:14] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:55:14] info: [handleMessage] [exec-1748724914795] Estado atual do cliente: negociacao
[2025-05-31 17:55:14] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:55:14] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:55:14] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:55:14] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:55:14] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:55:14] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:55:14] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:55:14] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?"
}
[2025-05-31 17:55:14] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Nossa, que nome"
    }
  ]
}
[2025-05-31 17:55:16] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 17:55:16] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 376,
    "completion_tokens": 3,
    "total_tokens": 379,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:55:16] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: negociacao
[2025-05-31 17:55:16] info: [handleMessage] [exec-1748724914795] Estado sugerido pela IA: negociacao
[2025-05-31 17:55:16] debug: [ClientRepository] Atualizando retries para 5512988256404: 1
[2025-05-31 17:55:16] info: [ClientRepository] retries atualizado para 1 no cliente 5512988256404
[2025-05-31 17:55:16] debug: [handleMessage] [exec-1748724914795] Repeti√ß√£o detectada. Retries incrementado para 1
[2025-05-31 17:55:16] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 16 mensagens.
[2025-05-31 17:55:16] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:55:16] info: [validadorMultiplos] [exec-1748724914795] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 17:55:16] info: [validadorMultiplos] [exec-1748724914795] üß© Validando metas da etapa: negociacao
[2025-05-31 17:55:16] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:55:16] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:55:16] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:55:16] debug: [validadorMultiplos] [exec-1748724914795] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 17:55:16] debug: [validadorMultiplos] [exec-1748724914795] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 3.12ms
[2025-05-31 17:55:16] info: [validadorMultiplos] [exec-1748724914795] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-05-31 17:55:16] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 17:55:17] debug: [extractByIA] Resultado IA: Desculpe, mas sua mensagem n√£o cont√©m um valor percentual de desconto.
[2025-05-31 17:55:17] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 17:55:17] debug: [validadorMultiplos] [exec-1748724914795] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 17:55:17] debug: [validadorMultiplos] [exec-1748724914795] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1275.15ms
[2025-05-31 17:55:17] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 17:55:18] debug: [extractByIA] Resultado IA: O cliente n√£o mencionou nenhuma forma de pagamento nessa passagem.
[2025-05-31 17:55:18] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:55:18] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 17:55:18] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O cliente n√£o mencionou nenhuma forma de pagamento nessa passagem."
[2025-05-31 17:55:18] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?"
[2025-05-31 17:55:18] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:55:20] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:55:20] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1337ms
[2025-05-31 17:55:20] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O cliente n√£o mencionou nenhuma forma de pagamento nessa passagem.",
  "contexto": "Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi?",
  "resposta": "n√£o.",
  "tempo_ms": 1337,
  "validado": false
}
[2025-05-31 17:55:20] warn: [validadorMultiplos] [exec-1748724914795] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:55:20] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 17:55:20] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:55:20] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 17:55:20] debug: [validadorMultiplos] [exec-1748724914795] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 2637.30ms
[2025-05-31 17:55:20] info: [validadorMultiplos] [exec-1748724914795] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 17:55:20] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:55:20] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Nossa, que nome √∫nico voc√™ tem! Seu nome √© igual o meu? √â isso mesmo que eu entendi? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:55:20] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:55:20] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:55:20] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:55:20] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:55:20] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:55:20] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:55:20] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:55:20] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:55:20] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:55:20] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:55:20] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:55:20] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:55:20] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:55:20] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 17:55:20] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 17:55:20] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:55:20] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:55:20] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:55:20] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:55:20] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 17:55:22] info: [handleMessage] [exec-1748724914795] üîç Texto bruto da IA antes do filtro: Sim, coincidentemente temos o mesmo nome, Lamuriel! Agora, me fale, o que mais posso esclarecer para voc√™ se sentir seguro com a micropigmenta√ß√£o de barba?
[2025-05-31 17:55:22] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:55:22] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 17:55:22] info: [handleMessage] [exec-1748724914795] ‚úÖ Texto final p√≥s-processado: Sim, coincidentemente temos o mesmo nome, Lamuriel! Agora, me fale, o que mais posso esclarecer para voc√™ se sentir seguro com a micropigmenta√ß√£o de barba?
[2025-05-31 17:55:22] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:55:22] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:55:22] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:55:22] debug: [audioService] Iniciando s√≠ntese de voz: "Sim, coincidentemente temos o ..."
[2025-05-31 17:55:22] debug: [audioService] Texto naturalizado: "Sim, coincidentemente temos o mesmo nome, Lamuriel! Agora, me fale, o que mais posso esclarecer para voc√™ se sentir seguro com a micropigmenta√ß√£o de barba?"
ffmpeg version 7.1.1-essentials_build-www.gyan.dev Copyright (c) 2000-2025 the FFmpeg developers
  built with gcc 14.2.0 (Rev1, Built by MSYS2 project)
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-bzlib --enable-lzma --enable-zlib --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-sdl2 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-mediafoundation --enable-libass --enable-libfreetype --enable-libfribidi --enable-libharfbuzz --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-dxva2 --enable-d3d11va --enable-d3d12va --enable-ffnvcodec --enable-libvpl --enable-nvdec --enable-nvenc --enable-vaapi --enable-libgme --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libtheora --enable-libvo-amrwbenc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-librubberband
  libavutil      59. 39.100 / 59. 39.100
  libavcodec     61. 19.101 / 61. 19.101
  libavformat    61.  7.100 / 61.  7.100
  libavdevice    61.  3.100 / 61.  3.100
  libavfilter    10.  4.100 / 10.  4.100
  libswscale      8.  3.100 /  8.  3.100
  libswresample   5.  3.100 /  5.  3.100
  libpostproc    58.  3.100 / 58.  3.100
[mp3 @ 000001f5bdd56200] Estimating duration from bitrate, this may be inaccurate
Input #0, mp3, from 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.mp3':
  Metadata:
    encoder         : Lavf59.27.100
  Duration: 00:00:08.44, start: 0.000000, bitrate: 128 kb/s
  Stream #0:0: Audio: mp3 (mp3float), 44100 Hz, mono, fltp, 128 kb/s
Stream mapping:
  Stream #0:0 -> #0:0 (mp3 (mp3float) -> opus (libopus))
Press [q] to stop, [?] for help
Output #0, ogg, to 'C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg':
  Metadata:
    encoder         : Lavf61.7.100
  Stream #0:0: Audio: opus, 48000 Hz, mono, flt, 64 kb/s
      Metadata:
        encoder         : Lavc61.19.101 libopus
[out#0/ogg @ 000001f5bdd70f80] video:0KiB audio:71KiB subtitle:0KiB other streams:0KiB global headers:0KiB muxing overhead: 1.149834%
size=      72KiB time=00:00:08.43 bitrate=  70.1kbits/s speed=73.2x
[2025-05-31 17:55:25] info: [audioService] √Åudio gerado e convertido com sucesso
[2025-05-31 17:55:25] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de √°udio ‚Äî aguardando 3410ms
[2025-05-31 17:55:28] info: [typingSimulator] üöÄ Enviando mensagem de √°udio ap√≥s digita√ß√£o
[2025-05-31 17:55:28] debug: [whatsapp] Enviando √°udio para 5512988256404
[2025-05-31 17:55:28] debug: [whatsapp] üîº Upload de √°udio iniciado para C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-05-31 17:55:28] debug: [whatsapp] Headers do FormData: {
  "Authorization": "Bearer EAARCeDx95qgBO18hTh6VZAfmpZBo7e7vQWEzl7JL5iHRidb72Nb9nu507WVYDiwZCldiIqAT1ZAJERYq4vci3j85WpIOZCCFu39jpNrEcaImi4WjZA0ut1QT4VrHHbNkLTBdwbSK8eZBrZCCATvgXNSZAPllkZANZC6xlys56P8NbzTiiaDvN6oeoiZAfTnU0Gar1LKzZBqQNOiZCRFElFZCScIebTjW3aIIb3LxBFhXU8aicvsXc2BBJORdMMZD",
  "content-type": "multipart/form-data; boundary=--------------------------942009928569092499391246"
}
[2025-05-31 17:55:30] info: [whatsapp] ‚úÖ Upload de √°udio conclu√≠do com media_id: 1248555196775443
[2025-05-31 17:55:31] info: [whatsapp] ‚úÖ √Åudio enviado com sucesso para 5512988256404
[2025-05-31 17:55:31] debug: [whatsapp] üßπ Arquivo tempor√°rio removido: C:\projetos\whatsapp-chatgpt-bot\temp-resposta.ogg
[2025-05-31 17:55:31] info: [typingSimulator] ‚úÖ mensagem de √°udio enviada com sucesso
[2025-05-31 17:55:32] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:55:32] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724932386
[2025-05-31 17:55:32] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkZCM0MxMkFEMjhGOTYyNTRBMQA=",
                "status": "sent",
                "timestamp": "1748724953",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:55:32] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:55:33] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:55:33] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724933007
[2025-05-31 17:55:33] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkZCM0MxMkFEMjhGOTYyNTRBMQA=",
                "status": "delivered",
                "timestamp": "1748724954",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:55:33] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:56:32] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:32] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748724992847
[2025-05-31 17:56:32] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIENCNkU1NUMwNzY2Mjg1MUMzOEQzMjc3NEYxMkMxNTBCAA==",
                "timestamp": "1748725013",
                "text": {
                  "body": "Carai, truta"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:32] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:56:32] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748724992847
[2025-05-31 17:56:32] debug: [webhook] Texto recebido: Carai, truta
[2025-05-31 17:56:32] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Carai, truta"
[2025-05-31 17:56:32] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748724992861) para 5512988256404
[2025-05-31 17:56:32] debug: [handleMessage] [exec-1748724992861] üì≤ Iniciando atendimento: phone=5512988256404, texto="Carai, truta", isAudio=false
[2025-05-31 17:56:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:32] info: [handleMessage] [exec-1748724992861] Estado atual do cliente: negociacao
[2025-05-31 17:56:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:32] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:56:32] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:32] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:56:32] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:56:32] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:56:32] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:56:32] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "Carai, truta"
}
[2025-05-31 17:56:32] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: Carai, truta\nüìå"
    }
  ]
}
[2025-05-31 17:56:34] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-05-31 17:56:34] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 357,
    "completion_tokens": 3,
    "total_tokens": 360,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:56:34] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-05-31 17:56:34] info: [handleMessage] [exec-1748724992861] Estado sugerido pela IA: fechamento
[2025-05-31 17:56:34] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-05-31 17:56:34] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-05-31 17:56:34] info: [handleMessage] [exec-1748724992861] Estado atualizado: negociacao ‚Üí fechamento
[2025-05-31 17:56:34] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 17 mensagens.
[2025-05-31 17:56:34] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:56:34] info: [validadorMultiplos] [exec-1748724992861] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'fechamento'
[2025-05-31 17:56:34] info: [validadorMultiplos] [exec-1748724992861] üß© Validando metas da etapa: fechamento
[2025-05-31 17:56:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:34] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:56:34] info: [validadorMultiplos] [exec-1748724992861] Campo 'address' n√£o se aplica ao produto 'produto1'. Salvando null.
[2025-05-31 17:56:34] info: [ClientRepository] Atualizando campo address para 5512988256404: null
[2025-05-31 17:56:34] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:56:34] error: [mongo] ‚ùå Erro ao salvar campo rejeitado {
  "error": {
    "errors": {
      "valor": {
        "name": "ValidatorError",
        "message": "Path `valor` is required.",
        "properties": {
          "message": "Path `valor` is required.",
          "type": "required",
          "path": "valor",
          "value": null
        },
        "kind": "required",
        "path": "valor",
        "value": null
      }
    },
    "_message": "Rejection validation failed",
    "name": "ValidationError",
    "message": "Rejection validation failed: valor: Path `valor` is required."
  },
  "data": {
    "phone": "5512988256404",
    "clientId": 4,
    "campo": "address",
    "valor": null,
    "motivo": "Campo n√£o aplic√°vel ao produto",
    "messageIn": "Carai, truta",
    "createdAt": "2025-05-31T20:56:34.298Z"
  }
}
[2025-05-31 17:56:34] info: [validadorMultiplos] [exec-1748724992861] Campo 'payment_method' j√° est√° preenchido: pix. Pulando.
[2025-05-31 17:56:34] debug: [validadorMultiplos] [exec-1748724992861] ‚ö†Ô∏è Campo 'schedule_time' n√£o identificado no texto.
[2025-05-31 17:56:34] debug: [validadorMultiplos] [exec-1748724992861] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'schedule_time': 9.27ms
[2025-05-31 17:56:34] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 17:56:35] debug: [extractByIA] Resultado IA: Desculpe, esta resposta √© amb√≠gua. Preciso que voc√™ confirme claramente, pode ser "sim", "confirmado" ou similar.
[2025-05-31 17:56:35] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:56:35] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "confirmacao"
[2025-05-31 17:56:35] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, esta resposta √© amb√≠gua. Preciso que voc√™ confirme claramente, pode ser "sim", "confirmado" ou similar."
[2025-05-31 17:56:35] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Carai, truta"
[2025-05-31 17:56:35] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:56:37] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:56:37] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1221ms
[2025-05-31 17:56:37] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "confirmacao",
  "valor": "Desculpe, esta resposta √© amb√≠gua. Preciso que voc√™ confirme claramente, pode ser \"sim\", \"confirmado\" ou similar.",
  "contexto": "Carai, truta",
  "resposta": "n√£o.",
  "tempo_ms": 1221,
  "validado": false
}
[2025-05-31 17:56:37] warn: [validadorMultiplos] [exec-1748724992861] ‚ùå Campo 'confirmacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:56:37] info: [ClientRepository] Atualizando campo confirmacao para 5512988256404: null
[2025-05-31 17:56:37] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:56:37] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | confirmacao
[2025-05-31 17:56:37] debug: [validadorMultiplos] [exec-1748724992861] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'confirmacao': 2711.62ms
[2025-05-31 17:56:37] info: [validadorMultiplos] [exec-1748724992861] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'fechamento'
[2025-05-31 17:56:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "negociacao": negotiated_price, purchase_intent, desconto, forma_pagamento
[2025-05-31 17:56:37] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: negociacao
[2025-05-31 17:56:37] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:56:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:56:37] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 17:56:37] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-05-31 17:56:37] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 17:56:37] info: [handleMessage] [exec-1748724992861] üìã Checklist fechamento: {
  "aprovado": false,
  "faltando": [
    "address",
    "schedule_time",
    "confirmacao"
  ],
  "contradicoes": []
}
[2025-05-31 17:56:37] info: [handleMessage] [exec-1748724992861] ‚ö†Ô∏è Contradi√ß√µes encontradas:
[2025-05-31 17:56:37] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:56:37] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Carai, truta {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:56:38] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 17:56:38] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 17:56:38] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:56:38] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: fechamentoPrompt
[2025-05-31 17:56:38] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:56:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:38] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:56:38] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:56:38] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:56:38] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:56:38] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:56:38] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:56:38] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:56:38] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:56:38] info: [temperatura] üîç Calculando temperatura com base na etapa "fechamento" e perfil do cliente
[2025-05-31 17:56:38] debug: [temperatura] Etapa reconhecida: "fechamento" ‚Üí base inicial: 0.4
[2025-05-31 17:56:38] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:56:38] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:56:38] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:56:38] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:56:38] info: [temperatura] ‚úÖ Temperatura final calculada: 0.45
[2025-05-31 17:56:40] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:40] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725000082
[2025-05-31 17:56:40] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDM5MjE0QkQ2REYzQzM0QjY5REUxNDRCMDNEMzA2Rjc5AA==",
                "timestamp": "1748725021",
                "text": {
                  "body": "Nois tem o memo nome ent√£o"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:40] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:56:40] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725000082
[2025-05-31 17:56:40] debug: [webhook] Texto recebido: Nois tem o memo nome ent√£o
[2025-05-31 17:56:40] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Nois tem o memo nome ent√£o"
[2025-05-31 17:56:40] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725000100) para 5512988256404
[2025-05-31 17:56:40] debug: [handleMessage] [exec-1748725000100] üì≤ Iniciando atendimento: phone=5512988256404, texto="Nois tem o memo nome ent√£o", isAudio=false
[2025-05-31 17:56:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:40] info: [handleMessage] [exec-1748725000100] Estado atual do cliente: fechamento
[2025-05-31 17:56:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:40] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:56:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:40] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:56:40] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:56:40] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:56:40] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:56:40] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Nois tem o memo nome ent√£o"
}
[2025-05-31 17:56:40] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Nois tem o memo"
    }
  ]
}
[2025-05-31 17:56:40] info: [handleMessage] [exec-1748724992861] üîç Texto bruto da IA antes do filtro: Lamuriel, estou aqui para ajudar com o que precisar sobre a micropigmenta√ß√£o de barba. Como posso auxiliar voc√™ agora?
[2025-05-31 17:56:40] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:56:40] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa fechamento, phone=5512988256404
[2025-05-31 17:56:40] info: [handleMessage] [exec-1748724992861] ‚úÖ Texto final p√≥s-processado: Lamuriel, estou aqui para ajudar com o que precisar sobre a micropigmenta√ß√£o de barba. Como posso auxiliar voc√™ agora?
[2025-05-31 17:56:40] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:56:40] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:56:40] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:56:40] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3092ms
[2025-05-31 17:56:40] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "pos_venda"
}
[2025-05-31 17:56:40] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 360,
    "completion_tokens": 3,
    "total_tokens": 363,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:56:40] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: pos_venda
[2025-05-31 17:56:40] info: [handleMessage] [exec-1748725000100] Estado sugerido pela IA: pos_venda
[2025-05-31 17:56:40] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí pos_venda
[2025-05-31 17:56:40] debug: [ClientRepository] current_state atualizado para 'pos_venda' e retries resetado
[2025-05-31 17:56:40] info: [handleMessage] [exec-1748725000100] Estado atualizado: fechamento ‚Üí pos_venda
[2025-05-31 17:56:40] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 18 mensagens.
[2025-05-31 17:56:40] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:56:40] info: [validadorMultiplos] [exec-1748725000100] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'pos_venda'
[2025-05-31 17:56:40] info: [validadorMultiplos] [exec-1748725000100] üß© Validando metas da etapa: pos_venda
[2025-05-31 17:56:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:40] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:56:40] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-05-31 17:56:40] debug: [validadorMultiplos] [exec-1748725000100] ‚ö†Ô∏è Campo 'feedback' n√£o identificado no texto.
[2025-05-31 17:56:40] debug: [validadorMultiplos] [exec-1748725000100] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'feedback': 3.32ms
[2025-05-31 17:56:40] info: [validadorMultiplos] [exec-1748725000100] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'pos_venda'
[2025-05-31 17:56:40] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:56:40] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Nois tem o memo nome ent√£o {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:56:41] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:56:41] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:56:41] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:56:41] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:56:41] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:56:41] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:56:41] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:56:41] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:56:41] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:56:41] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:56:41] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:56:41] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:56:41] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:56:41] info: [temperatura] üîç Calculando temperatura com base na etapa "pos_venda" e perfil do cliente
[2025-05-31 17:56:41] debug: [temperatura] Etapa reconhecida: "pos_venda" ‚Üí base inicial: 0.5
[2025-05-31 17:56:41] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:56:41] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:56:41] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:56:41] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:56:41] info: [temperatura] ‚úÖ Temperatura final calculada: 0.55
[2025-05-31 17:56:42] info: [handleMessage] [exec-1748725000100] üîç Texto bruto da IA antes do filtro: Que coincid√™ncia bacana, Lamuriel! üòÑ Espero que esteja curtindo sua nova barba!
[2025-05-31 17:56:42] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:56:42] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa pos_venda, phone=5512988256404
[2025-05-31 17:56:42] info: [handleMessage] [exec-1748725000100] ‚úÖ Texto final p√≥s-processado: Que coincid√™ncia bacana, Lamuriel! üòÑ Espero que esteja curtindo sua nova barba!
[2025-05-31 17:56:42] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:56:42] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:56:42] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:56:42] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4445ms
[2025-05-31 17:56:43] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:56:43] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Lamuriel, estou aqui para ajudar com o que precisar sobre a micropigmenta√ß√£o de barba. Como posso auxiliar voc√™ agora?" Timestamp=1748725003782
[2025-05-31 17:56:43] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:56:43] debug: [whatsapp] Conte√∫do da mensagem: "Lamuriel, estou aqui para ajudar com o que precisar sobre a micropigmenta√ß√£o de barba. Como posso auxiliar voc√™ agora?"
[2025-05-31 17:56:43] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Lamuriel, estou aqui para ajudar com o que precisar sobre a micropigmenta√ß√£o de barba. Como posso auxiliar voc√™ agora?"
  }
}
[2025-05-31 17:56:43] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:56:44] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:56:44] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjBDMEI1REREN0Q0MjM2NjEyRgA="
    }
  ]
}
[2025-05-31 17:56:44] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:56:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725005297
[2025-05-31 17:56:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjBDMEI1REREN0Q0MjM2NjEyRgA=",
                "status": "sent",
                "timestamp": "1748725026",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:56:45] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:45] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725005578
[2025-05-31 17:56:45] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjBDMEI1REREN0Q0MjM2NjEyRgA=",
                "status": "delivered",
                "timestamp": "1748725027",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:45] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:56:47] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:56:47] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Que coincid√™ncia bacana, Lamuriel! üòÑ Espero que esteja curtindo sua nova barba!" Timestamp=1748725007320
[2025-05-31 17:56:47] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:56:47] debug: [whatsapp] Conte√∫do da mensagem: "Que coincid√™ncia bacana, Lamuriel! üòÑ Espero que esteja curtindo sua nova barba!"
[2025-05-31 17:56:47] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Que coincid√™ncia bacana, Lamuriel! üòÑ Espero que esteja curtindo sua nova barba!"
  }
}
[2025-05-31 17:56:47] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:56:47] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:56:47] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkYzNkNENjk1NkNEQkNFMTg3MAA="
    }
  ]
}
[2025-05-31 17:56:47] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:56:48] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:48] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725008674
[2025-05-31 17:56:48] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkYzNkNENjk1NkNEQkNFMTg3MAA=",
                "status": "sent",
                "timestamp": "1748725030",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:48] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:56:48] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:56:48] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725008908
[2025-05-31 17:56:48] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkYzNkNENjk1NkNEQkNFMTg3MAA=",
                "status": "delivered",
                "timestamp": "1748725030",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:56:48] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:57:25] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:25] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725045875
[2025-05-31 17:57:25] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDk3MzVEREUzMDkyOEZFQkRCMDg5RkQ1OTgzMkQ0NTFEAA==",
                "timestamp": "1748725067",
                "text": {
                  "body": "Oxi, como assim?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:25] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:57:25] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725045875
[2025-05-31 17:57:25] debug: [webhook] Texto recebido: Oxi, como assim?
[2025-05-31 17:57:25] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Oxi, como assim?"
[2025-05-31 17:57:25] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725045907) para 5512988256404
[2025-05-31 17:57:25] debug: [handleMessage] [exec-1748725045907] üì≤ Iniciando atendimento: phone=5512988256404, texto="Oxi, como assim?", isAudio=false
[2025-05-31 17:57:25] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:25] info: [handleMessage] [exec-1748725045907] Estado atual do cliente: pos_venda
[2025-05-31 17:57:25] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:25] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:57:25] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:25] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:57:25] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:57:25] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:57:25] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:57:25] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "pos_venda",
  "userMessage": "Oxi, como assim?"
}
[2025-05-31 17:57:25] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: pos_venda\nMensagem do cliente: Oxi, como assim?"
    }
  ]
}
[2025-05-31 17:57:27] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "encerramento"
}
[2025-05-31 17:57:27] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 358,
    "completion_tokens": 3,
    "total_tokens": 361,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:57:27] info: [aiStateDecider] üß≠ Etapa atual: pos_venda ‚Äî IA sugeriu: encerramento
[2025-05-31 17:57:27] info: [handleMessage] [exec-1748725045907] Estado sugerido pela IA: encerramento
[2025-05-31 17:57:27] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí encerramento
[2025-05-31 17:57:27] debug: [ClientRepository] current_state atualizado para 'encerramento' e retries resetado
[2025-05-31 17:57:27] info: [handleMessage] [exec-1748725045907] Estado atualizado: pos_venda ‚Üí encerramento
[2025-05-31 17:57:27] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 19 mensagens.
[2025-05-31 17:57:27] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:57:27] info: [validadorMultiplos] [exec-1748725045907] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'encerramento'
[2025-05-31 17:57:27] debug: [validadorMultiplos] [exec-1748725045907] Nenhuma meta v√°lida definida para etapa: encerramento
[2025-05-31 17:57:27] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:57:27] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Oxi, como assim? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:57:28] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 17:57:28] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 17:57:28] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:57:28] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:57:28] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:28] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:57:28] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:57:28] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:57:28] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:57:28] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:57:28] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:57:28] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:57:28] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:57:28] info: [temperatura] üîç Calculando temperatura com base na etapa "encerramento" e perfil do cliente
[2025-05-31 17:57:28] debug: [temperatura] Etapa reconhecida: "encerramento" ‚Üí base inicial: 0.3
[2025-05-31 17:57:28] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:57:28] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:57:28] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:57:28] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:57:28] info: [temperatura] ‚úÖ Temperatura final calculada: 0.35
[2025-05-31 17:57:29] info: [handleMessage] [exec-1748725045907] üîç Texto bruto da IA antes do filtro: Pe√ßo desculpas pela confus√£o. Estou √† disposi√ß√£o para esclarecer quaisquer d√∫vidas que voc√™ tenha.
[2025-05-31 17:57:29] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:57:29] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa encerramento, phone=5512988256404
[2025-05-31 17:57:29] info: [handleMessage] [exec-1748725045907] ‚úÖ Texto final p√≥s-processado: Pe√ßo desculpas pela confus√£o. Estou √† disposi√ß√£o para esclarecer quaisquer d√∫vidas que voc√™ tenha.
[2025-05-31 17:57:29] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:57:29] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:57:29] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:57:29] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5436ms
[2025-05-31 17:57:33] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:33] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725053804
[2025-05-31 17:57:33] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEQxRkIzNzQ2OUIxNTVCNjY4OTM4QTdGQ0I5NzU5QjAxAA==",
                "timestamp": "1748725074",
                "text": {
                  "body": "Ainda nem fiz o procedimento"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:33] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:57:33] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725053804
[2025-05-31 17:57:33] debug: [webhook] Texto recebido: Ainda nem fiz o procedimento
[2025-05-31 17:57:33] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Ainda nem fiz o procedimento"
[2025-05-31 17:57:33] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725053817) para 5512988256404
[2025-05-31 17:57:33] debug: [handleMessage] [exec-1748725053817] üì≤ Iniciando atendimento: phone=5512988256404, texto="Ainda nem fiz o procedimento", isAudio=false
[2025-05-31 17:57:33] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:33] info: [handleMessage] [exec-1748725053817] Estado atual do cliente: encerramento
[2025-05-31 17:57:33] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:33] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:57:33] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:33] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:57:33] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:57:33] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:57:33] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:57:33] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "encerramento",
  "userMessage": "Ainda nem fiz o procedimento"
}
[2025-05-31 17:57:33] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: encerramento\nMensagem do cliente: Ainda nem fiz"
    }
  ]
}
[2025-05-31 17:57:34] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "objecoes"
}
[2025-05-31 17:57:34] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 360,
    "completion_tokens": 3,
    "total_tokens": 363,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:57:34] info: [aiStateDecider] üß≠ Etapa atual: encerramento ‚Äî IA sugeriu: objecoes
[2025-05-31 17:57:34] info: [handleMessage] [exec-1748725053817] Estado sugerido pela IA: objecoes
[2025-05-31 17:57:34] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí objecoes
[2025-05-31 17:57:34] debug: [ClientRepository] current_state atualizado para 'objecoes' e retries resetado
[2025-05-31 17:57:34] info: [handleMessage] [exec-1748725053817] Estado atualizado: encerramento ‚Üí objecoes
[2025-05-31 17:57:34] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 20 mensagens.
[2025-05-31 17:57:34] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:57:34] info: [validadorMultiplos] [exec-1748725053817] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'objecoes'
[2025-05-31 17:57:34] info: [validadorMultiplos] [exec-1748725053817] üß© Validando metas da etapa: objecoes
[2025-05-31 17:57:34] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:34] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:57:34] info: [validadorMultiplos] [exec-1748725053817] Campo 'objection_type' j√° est√° preenchido: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.. Pulando.
[2025-05-31 17:57:34] info: [validadorMultiplos] [exec-1748725053817] Campo 'motivo_obje√ß√£o' j√° est√° preenchido: O cliente est√° preocupado com o custo do procedimento.. Pulando.
[2025-05-31 17:57:34] debug: [extractByIA] Prompt: Extraia a alternativa proposta pelo cliente em vez da oferta principal.
[2025-05-31 17:57:35] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:57:35] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Pe√ßo desculpas pela confus√£o. Estou √† disposi√ß√£o para esclarecer quaisquer d√∫vidas que voc√™ tenha." Timestamp=1748725055334
[2025-05-31 17:57:35] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:57:35] debug: [whatsapp] Conte√∫do da mensagem: "Pe√ßo desculpas pela confus√£o. Estou √† disposi√ß√£o para esclarecer quaisquer d√∫vidas que voc√™ tenha."
[2025-05-31 17:57:35] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Pe√ßo desculpas pela confus√£o. Estou √† disposi√ß√£o para esclarecer quaisquer d√∫vidas que voc√™ tenha."
  }
}
[2025-05-31 17:57:35] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:57:36] debug: [extractByIA] Resultado IA: Desculpe, mas sua frase n√£o cont√©m uma oferta principal e uma alternativa proposta pelo cliente. Voc√™ pode fornecer mais detalhes?
[2025-05-31 17:57:36] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:57:36] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "alternativa"
[2025-05-31 17:57:36] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas sua frase n√£o cont√©m uma oferta principal e uma alternativa proposta pelo cliente. Voc√™ pode fornecer mais detalhes?"
[2025-05-31 17:57:36] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Ainda nem fiz o procedimento"
[2025-05-31 17:57:36] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:57:36] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:57:36] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkVDOThGOENFRTg2OTE5MDQ4MgA="
    }
  ]
}
[2025-05-31 17:57:36] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:57:37] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:37] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725057040
[2025-05-31 17:57:37] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkVDOThGOENFRTg2OTE5MDQ4MgA=",
                "status": "sent",
                "timestamp": "1748725078",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:37] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:57:37] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:37] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725057130
[2025-05-31 17:57:37] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkVDOThGOENFRTg2OTE5MDQ4MgA=",
                "status": "delivered",
                "timestamp": "1748725078",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:37] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:57:37] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:57:37] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1246ms
[2025-05-31 17:57:37] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "alternativa",
  "valor": "Desculpe, mas sua frase n√£o cont√©m uma oferta principal e uma alternativa proposta pelo cliente. Voc√™ pode fornecer mais detalhes?",
  "contexto": "Ainda nem fiz o procedimento",
  "resposta": "n√£o.",
  "tempo_ms": 1246,
  "validado": false
}
[2025-05-31 17:57:37] warn: [validadorMultiplos] [exec-1748725053817] ‚ùå Campo 'alternativa' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:57:37] info: [ClientRepository] Atualizando campo alternativa para 5512988256404: null
[2025-05-31 17:57:37] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:57:37] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | alternativa
[2025-05-31 17:57:37] debug: [validadorMultiplos] [exec-1748725053817] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'alternativa': 2623.87ms
[2025-05-31 17:57:37] info: [validadorMultiplos] [exec-1748725053817] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'objecoes'
[2025-05-31 17:57:37] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:57:37] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Ainda nem fiz o procedimento {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:57:38] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:57:38] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:57:38] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:57:38] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:57:38] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:57:38] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:57:38] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:57:38] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:57:38] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:57:38] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:57:38] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:57:38] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:57:38] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:57:38] info: [temperatura] üîç Calculando temperatura com base na etapa "objecoes" e perfil do cliente
[2025-05-31 17:57:38] warn: [temperatura] Etapa desconhecida: "objecoes". Usando base padr√£o: 0.7
[2025-05-31 17:57:38] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:57:38] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:57:38] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:57:38] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:57:38] info: [temperatura] ‚úÖ Temperatura final calculada: 0.75
[2025-05-31 17:57:39] info: [handleMessage] [exec-1748725053817] üîç Texto bruto da IA antes do filtro: √â natural sentir-se cauteloso antes de tomar uma decis√£o como esta.
[2025-05-31 17:57:39] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:57:39] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa objecoes, phone=5512988256404
[2025-05-31 17:57:39] info: [handleMessage] [exec-1748725053817] ‚úÖ Texto final p√≥s-processado: √â natural sentir-se cauteloso antes de tomar uma decis√£o como esta.
[2025-05-31 17:57:39] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:57:39] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:57:39] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:57:39] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6072ms
[2025-05-31 17:57:45] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:57:45] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "√â natural sentir-se cauteloso antes de tomar uma decis√£o como esta." Timestamp=1748725065498
[2025-05-31 17:57:45] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:57:45] debug: [whatsapp] Conte√∫do da mensagem: "√â natural sentir-se cauteloso antes de tomar uma decis√£o como esta."
[2025-05-31 17:57:45] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "√â natural sentir-se cauteloso antes de tomar uma decis√£o como esta."
  }
}
[2025-05-31 17:57:45] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:57:46] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:57:46] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjYxMDk4MkM0RTIxNUZDQzVBMgA="
    }
  ]
}
[2025-05-31 17:57:46] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:57:47] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:47] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725067073
[2025-05-31 17:57:47] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjYxMDk4MkM0RTIxNUZDQzVBMgA=",
                "status": "sent",
                "timestamp": "1748725088",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:47] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:57:47] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:57:47] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725067363
[2025-05-31 17:57:47] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjYxMDk4MkM0RTIxNUZDQzVBMgA=",
                "status": "delivered",
                "timestamp": "1748725088",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:57:47] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:58:03] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:58:03] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725083915
[2025-05-31 17:58:03] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEQyMDczNzMxODhDNTVFOTBENjM3NzFEMjQ4Mzc4NDAwAA==",
                "timestamp": "1748725105",
                "text": {
                  "body": "Eu preciso marcar uma avalia√ß√£o?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:58:03] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 17:58:03] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725083915
[2025-05-31 17:58:03] debug: [webhook] Texto recebido: Eu preciso marcar uma avalia√ß√£o?
[2025-05-31 17:58:03] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Eu preciso marcar uma avalia√ß√£o?"
[2025-05-31 17:58:03] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725083955) para 5512988256404
[2025-05-31 17:58:03] debug: [handleMessage] [exec-1748725083955] üì≤ Iniciando atendimento: phone=5512988256404, texto="Eu preciso marcar uma avalia√ß√£o?", isAudio=false
[2025-05-31 17:58:03] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:58:03] info: [handleMessage] [exec-1748725083955] Estado atual do cliente: objecoes
[2025-05-31 17:58:03] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:58:03] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:58:03] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:58:03] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:58:03] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:58:03] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:58:03] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:58:03] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "objecoes",
  "userMessage": "Eu preciso marcar uma avalia√ß√£o?"
}
[2025-05-31 17:58:03] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: objecoes\nMensagem do cliente: Eu preciso marcar"
    }
  ]
}
[2025-05-31 17:58:05] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 17:58:05] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 361,
    "completion_tokens": 3,
    "total_tokens": 364,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 17:58:05] info: [aiStateDecider] üß≠ Etapa atual: objecoes ‚Äî IA sugeriu: negociacao
[2025-05-31 17:58:05] info: [handleMessage] [exec-1748725083955] Estado sugerido pela IA: negociacao
[2025-05-31 17:58:05] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-05-31 17:58:05] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-05-31 17:58:05] info: [handleMessage] [exec-1748725083955] Estado atualizado: objecoes ‚Üí negociacao
[2025-05-31 17:58:05] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 21 mensagens.
[2025-05-31 17:58:05] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 17:58:05] info: [validadorMultiplos] [exec-1748725083955] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 17:58:05] info: [validadorMultiplos] [exec-1748725083955] üß© Validando metas da etapa: negociacao
[2025-05-31 17:58:05] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:58:05] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 17:58:05] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 17:58:05] debug: [validadorMultiplos] [exec-1748725083955] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 17:58:05] debug: [validadorMultiplos] [exec-1748725083955] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 8.49ms
[2025-05-31 17:58:05] info: [validadorMultiplos] [exec-1748725083955] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-05-31 17:58:05] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 17:58:07] debug: [extractByIA] Resultado IA: A entrada fornecida n√£o cont√©m um valor percentual de desconto. Por favor, forne√ßa mais informa√ß√µes.
[2025-05-31 17:58:07] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 17:58:08] debug: [validadorMultiplos] [exec-1748725083955] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 17:58:08] debug: [validadorMultiplos] [exec-1748725083955] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 2683.76ms
[2025-05-31 17:58:08] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 17:58:09] debug: [extractByIA] Resultado IA: O texto n√£o menciona uma forma de pagamento.
[2025-05-31 17:58:09] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 17:58:09] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 17:58:09] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O texto n√£o menciona uma forma de pagamento."
[2025-05-31 17:58:09] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Eu preciso marcar uma avalia√ß√£o?"
[2025-05-31 17:58:09] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 17:58:09] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 17:58:09] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 775ms
[2025-05-31 17:58:09] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O texto n√£o menciona uma forma de pagamento.",
  "contexto": "Eu preciso marcar uma avalia√ß√£o?",
  "resposta": "n√£o.",
  "tempo_ms": 775,
  "validado": false
}
[2025-05-31 17:58:09] warn: [validadorMultiplos] [exec-1748725083955] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 17:58:09] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 17:58:09] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 17:58:09] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 17:58:09] debug: [validadorMultiplos] [exec-1748725083955] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 1990.71ms
[2025-05-31 17:58:10] info: [validadorMultiplos] [exec-1748725083955] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 17:58:10] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 17:58:10] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Eu preciso marcar uma avalia√ß√£o? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 17:58:10] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "levantamento"
}
[2025-05-31 17:58:10] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "levantamento"
[2025-05-31 17:58:10] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 17:58:10] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 17:58:10] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 17:58:10] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 17:58:10] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 17:58:10] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 17:58:10] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 17:58:10] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 17:58:10] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 17:58:10] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 17:58:10] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:58:10] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 17:58:10] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 17:58:10] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 17:58:10] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 17:58:10] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 17:58:10] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 17:58:10] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 17:58:12] info: [handleMessage] [exec-1748725083955] üîç Texto bruto da IA antes do filtro: Sim, a avalia√ß√£o gratuita antes da sess√£o √© essencial para personalizar o procedimento para o seu rosto.
[2025-05-31 17:58:12] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 17:58:12] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 17:58:12] warn: [verificadorPropostaNegociacao] ‚ö†Ô∏è Resposta fraca detectada na etapa de negocia√ß√£o:
Telefone: 5512988256404
Temperatura anterior: 0.65
Temperatura ajustada: 0.8500000000000001
Texto gerado: "Sim, a avalia√ß√£o gratuita antes da sess√£o √© essencial para personalizar o procedimento para o seu rosto."
[2025-05-31 17:58:12] info: [mongo] üß† Log de negocia√ß√£o salvo com sucesso para 5512988256404
[2025-05-31 17:58:12] warn: [handleMessage] [exec-1748725083955] ‚ôªÔ∏è Regenerando resposta com temperatura 0.8500000000000001
[2025-05-31 17:58:13] info: [handleMessage] [exec-1748725083955] üîÅ Nova resposta p√≥s-ajuste: Sim, a avalia√ß√£o gratuita √© o primeiro passo para entendermos as suas necessidades e planejarmos o procedimento.
[2025-05-31 17:58:13] info: [mongo] üß† Log de negocia√ß√£o salvo com sucesso para 5512988256404
[2025-05-31 17:58:13] info: [handleMessage] [exec-1748725083955] ‚úÖ Texto final p√≥s-processado: Sim, a avalia√ß√£o gratuita √© o primeiro passo para entendermos as suas necessidades e planejarmos o procedimento.
[2025-05-31 17:58:13] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 17:58:13] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 17:58:13] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 17:58:13] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6022ms
[2025-05-31 17:58:19] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 17:58:19] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Sim, a avalia√ß√£o gratuita √© o primeiro passo para entendermos as suas necessidades e planejarmos o procedimento." Timestamp=1748725099770
[2025-05-31 17:58:19] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 17:58:19] debug: [whatsapp] Conte√∫do da mensagem: "Sim, a avalia√ß√£o gratuita √© o primeiro passo para entendermos as suas necessidades e planejarmos o procedimento."
[2025-05-31 17:58:19] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Sim, a avalia√ß√£o gratuita √© o primeiro passo para entendermos as suas necessidades e planejarmos o procedimento."
  }
}
[2025-05-31 17:58:19] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 17:58:20] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 17:58:20] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFEOTI1RjA0OTU3MzNGQzY3QgA="
    }
  ]
}
[2025-05-31 17:58:20] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 17:58:21] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:58:21] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725101556
[2025-05-31 17:58:21] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFEOTI1RjA0OTU3MzNGQzY3QgA=",
                "status": "delivered",
                "timestamp": "1748725123",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:58:21] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 17:58:21] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 17:58:21] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725101619
[2025-05-31 17:58:21] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFEOTI1RjA0OTU3MzNGQzY3QgA=",
                "status": "sent",
                "timestamp": "1748725122",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 17:58:21] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:00:43] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:00:43] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725243501
[2025-05-31 18:00:43] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDNCNTEwNzU5OEQzQjQ2MTMwRUUxMzI1M0Y1NThBREQ4AA==",
                "timestamp": "1748725264",
                "text": {
                  "body": "E como faz?"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:00:43] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:00:43] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725243501
[2025-05-31 18:00:43] debug: [webhook] Texto recebido: E como faz?
[2025-05-31 18:00:43] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "E como faz?"
[2025-05-31 18:00:43] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725243518) para 5512988256404
[2025-05-31 18:00:43] debug: [handleMessage] [exec-1748725243518] üì≤ Iniciando atendimento: phone=5512988256404, texto="E como faz?", isAudio=false
[2025-05-31 18:00:43] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:00:43] info: [handleMessage] [exec-1748725243518] Estado atual do cliente: negociacao
[2025-05-31 18:00:43] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:00:43] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:00:43] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:00:43] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:00:43] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:00:43] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:00:43] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:00:43] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "E como faz?"
}
[2025-05-31 18:00:43] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: E como faz?\nüìå "
    }
  ]
}
[2025-05-31 18:00:44] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-05-31 18:00:44] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 355,
    "completion_tokens": 3,
    "total_tokens": 358,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:00:44] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-05-31 18:00:44] info: [handleMessage] [exec-1748725243518] Estado sugerido pela IA: fechamento
[2025-05-31 18:00:44] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-05-31 18:00:44] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-05-31 18:00:44] info: [handleMessage] [exec-1748725243518] Estado atualizado: negociacao ‚Üí fechamento
[2025-05-31 18:00:44] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 22 mensagens.
[2025-05-31 18:00:44] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:00:44] info: [validadorMultiplos] [exec-1748725243518] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'fechamento'
[2025-05-31 18:00:44] info: [validadorMultiplos] [exec-1748725243518] üß© Validando metas da etapa: fechamento
[2025-05-31 18:00:44] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:00:44] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:00:44] info: [validadorMultiplos] [exec-1748725243518] Campo 'address' n√£o se aplica ao produto 'produto1'. Salvando null.
[2025-05-31 18:00:44] info: [ClientRepository] Atualizando campo address para 5512988256404: null
[2025-05-31 18:00:44] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:00:44] error: [mongo] ‚ùå Erro ao salvar campo rejeitado {
  "error": {
    "errors": {
      "valor": {
        "name": "ValidatorError",
        "message": "Path `valor` is required.",
        "properties": {
          "message": "Path `valor` is required.",
          "type": "required",
          "path": "valor",
          "value": null
        },
        "kind": "required",
        "path": "valor",
        "value": null
      }
    },
    "_message": "Rejection validation failed",
    "name": "ValidationError",
    "message": "Rejection validation failed: valor: Path `valor` is required."
  },
  "data": {
    "phone": "5512988256404",
    "clientId": 4,
    "campo": "address",
    "valor": null,
    "motivo": "Campo n√£o aplic√°vel ao produto",
    "messageIn": "E como faz?",
    "createdAt": "2025-05-31T21:00:44.951Z"
  }
}
[2025-05-31 18:00:44] info: [validadorMultiplos] [exec-1748725243518] Campo 'payment_method' j√° est√° preenchido: pix. Pulando.
[2025-05-31 18:00:44] debug: [validadorMultiplos] [exec-1748725243518] ‚ö†Ô∏è Campo 'schedule_time' n√£o identificado no texto.
[2025-05-31 18:00:44] debug: [validadorMultiplos] [exec-1748725243518] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'schedule_time': 1.37ms
[2025-05-31 18:00:44] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 18:00:47] debug: [extractByIA] Resultado IA: A resposta n√£o esclarece se o cliente confirmou o fechamento ou n√£o.
[2025-05-31 18:00:47] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:00:47] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "confirmacao"
[2025-05-31 18:00:47] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A resposta n√£o esclarece se o cliente confirmou o fechamento ou n√£o."
[2025-05-31 18:00:47] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "E como faz?"
[2025-05-31 18:00:47] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:00:48] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:00:48] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1143ms
[2025-05-31 18:00:48] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "confirmacao",
  "valor": "A resposta n√£o esclarece se o cliente confirmou o fechamento ou n√£o.",
  "contexto": "E como faz?",
  "resposta": "n√£o.",
  "tempo_ms": 1143,
  "validado": false
}
[2025-05-31 18:00:48] warn: [validadorMultiplos] [exec-1748725243518] ‚ùå Campo 'confirmacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:00:48] info: [ClientRepository] Atualizando campo confirmacao para 5512988256404: null
[2025-05-31 18:00:48] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:00:48] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | confirmacao
[2025-05-31 18:00:48] debug: [validadorMultiplos] [exec-1748725243518] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'confirmacao': 3271.29ms
[2025-05-31 18:00:48] info: [validadorMultiplos] [exec-1748725243518] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'fechamento'
[2025-05-31 18:00:48] debug: [metaPorEtapa] üîç Metas esperadas para etapa "negociacao": negotiated_price, purchase_intent, desconto, forma_pagamento
[2025-05-31 18:00:48] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: negociacao
[2025-05-31 18:00:48] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 18:00:48] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 18:00:48] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 18:00:48] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-05-31 18:00:48] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 18:00:48] info: [handleMessage] [exec-1748725243518] üìã Checklist fechamento: {
  "aprovado": false,
  "faltando": [
    "address",
    "schedule_time",
    "confirmacao"
  ],
  "contradicoes": []
}
[2025-05-31 18:00:48] info: [handleMessage] [exec-1748725243518] ‚ö†Ô∏è Contradi√ß√µes encontradas:
[2025-05-31 18:00:48] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:00:48] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados E como faz? {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:00:49] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 18:00:49] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 18:00:49] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:00:49] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: fechamentoPrompt
[2025-05-31 18:00:49] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:00:49] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:00:49] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:00:49] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:00:49] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:00:49] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:00:49] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:00:49] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:00:49] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:00:49] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:00:49] info: [temperatura] üîç Calculando temperatura com base na etapa "fechamento" e perfil do cliente
[2025-05-31 18:00:49] debug: [temperatura] Etapa reconhecida: "fechamento" ‚Üí base inicial: 0.4
[2025-05-31 18:00:49] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:00:49] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:00:49] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:00:49] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:00:49] info: [temperatura] ‚úÖ Temperatura final calculada: 0.45
[2025-05-31 18:00:50] info: [handleMessage] [exec-1748725243518] üîç Texto bruto da IA antes do filtro: Para come√ßar, posso confirmar seu nome completo e a forma de pagamento que prefere utilizar?
[2025-05-31 18:00:50] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:00:50] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa fechamento, phone=5512988256404
[2025-05-31 18:00:50] info: [handleMessage] [exec-1748725243518] ‚úÖ Texto final p√≥s-processado: Para come√ßar, posso confirmar seu nome completo e a forma de pagamento que prefere utilizar?
[2025-05-31 18:00:50] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:00:50] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:00:50] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:00:50] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4297ms
[2025-05-31 18:00:55] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:00:55] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Para come√ßar, posso confirmar seu nome completo e a forma de pagamento que prefere utilizar?" Timestamp=1748725255009
[2025-05-31 18:00:55] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:00:55] debug: [whatsapp] Conte√∫do da mensagem: "Para come√ßar, posso confirmar seu nome completo e a forma de pagamento que prefere utilizar?"
[2025-05-31 18:00:55] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Para come√ßar, posso confirmar seu nome completo e a forma de pagamento que prefere utilizar?"
  }
}
[2025-05-31 18:00:55] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:00:55] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:00:55] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJERDE1M0ZFMzY3MkI4MUJGMwA="
    }
  ]
}
[2025-05-31 18:00:55] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:00:56] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:00:56] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725256725
[2025-05-31 18:00:56] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJERDE1M0ZFMzY3MkI4MUJGMwA=",
                "status": "sent",
                "timestamp": "1748725278",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:00:56] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:00:56] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:00:56] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725256761
[2025-05-31 18:00:56] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjJERDE1M0ZFMzY3MkI4MUJGMwA=",
                "status": "delivered",
                "timestamp": "1748725278",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:00:56] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:01:55] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:01:55] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725315437
[2025-05-31 18:01:55] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDA0MjUxNkQ3QkVCM0Q3NjE5QUUxNjgxQTA5NTRFRDY3AA==",
                "timestamp": "1748725336",
                "text": {
                  "body": "Joselito limonal da cantareira, pix"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:01:55] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:01:55] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725315437
[2025-05-31 18:01:55] debug: [webhook] Texto recebido: Joselito limonal da cantareira, pix
[2025-05-31 18:01:55] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Joselito limonal da cantareira, pix"
[2025-05-31 18:01:55] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725315451) para 5512988256404
[2025-05-31 18:01:55] debug: [handleMessage] [exec-1748725315451] üì≤ Iniciando atendimento: phone=5512988256404, texto="Joselito limonal da cantareira, pix", isAudio=false
[2025-05-31 18:01:55] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:01:55] info: [handleMessage] [exec-1748725315451] Estado atual do cliente: fechamento
[2025-05-31 18:01:55] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:01:55] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:01:55] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:01:55] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:01:55] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:01:55] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:01:55] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:01:55] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Joselito limonal da cantareira, pix"
}
[2025-05-31 18:01:55] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Joselito limona"
    }
  ]
}
[2025-05-31 18:01:57] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "pos_venda"
}
[2025-05-31 18:01:57] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 364,
    "completion_tokens": 3,
    "total_tokens": 367,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:01:57] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: pos_venda
[2025-05-31 18:01:57] info: [handleMessage] [exec-1748725315451] Estado sugerido pela IA: pos_venda
[2025-05-31 18:01:57] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí pos_venda
[2025-05-31 18:01:57] debug: [ClientRepository] current_state atualizado para 'pos_venda' e retries resetado
[2025-05-31 18:01:57] info: [handleMessage] [exec-1748725315451] Estado atualizado: fechamento ‚Üí pos_venda
[2025-05-31 18:01:57] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 23 mensagens.
[2025-05-31 18:01:57] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:01:57] info: [validadorMultiplos] [exec-1748725315451] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'pos_venda'
[2025-05-31 18:01:57] info: [validadorMultiplos] [exec-1748725315451] üß© Validando metas da etapa: pos_venda
[2025-05-31 18:01:57] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:01:57] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:01:57] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-05-31 18:01:57] debug: [validadorMultiplos] [exec-1748725315451] ‚ö†Ô∏è Campo 'feedback' n√£o identificado no texto.
[2025-05-31 18:01:57] debug: [validadorMultiplos] [exec-1748725315451] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'feedback': 5.01ms
[2025-05-31 18:01:57] info: [validadorMultiplos] [exec-1748725315451] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'pos_venda'
[2025-05-31 18:01:57] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:01:57] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Joselito limonal da cantareira, pix {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:01:58] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 18:01:58] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 18:01:58] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:01:58] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:01:58] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:01:58] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:01:58] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:01:58] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:01:58] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:01:58] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:01:58] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:01:58] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:01:58] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:01:58] info: [temperatura] üîç Calculando temperatura com base na etapa "pos_venda" e perfil do cliente
[2025-05-31 18:01:58] debug: [temperatura] Etapa reconhecida: "pos_venda" ‚Üí base inicial: 0.5
[2025-05-31 18:01:58] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:01:58] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:01:58] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:01:58] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:01:58] info: [temperatura] ‚úÖ Temperatura final calculada: 0.55
[2025-05-31 18:02:00] info: [handleMessage] [exec-1748725315451] üîç Texto bruto da IA antes do filtro: Ol√° Lamuriel, agrade√ßo por escolher nosso servi√ßo! Quando estiver pronto, posso te enviar os detalhes para pagamento via PIX. üòâ
[2025-05-31 18:02:00] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:02:00] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa pos_venda, phone=5512988256404
[2025-05-31 18:02:00] info: [handleMessage] [exec-1748725315451] ‚úÖ Texto final p√≥s-processado: Lamuriel, agrade√ßo por escolher nosso servi√ßo! Quando estiver pronto, posso te enviar os detalhes para pagamento via PIX. üòâ
[2025-05-31 18:02:00] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:02:00] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:02:00] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:02:00] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3773ms
[2025-05-31 18:02:04] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:02:04] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Lamuriel, agrade√ßo por escolher nosso servi√ßo! Quando estiver pronto, posso te enviar os detalhes para pagamento via PIX. üòâ" Timestamp=1748725324173
[2025-05-31 18:02:04] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:02:04] debug: [whatsapp] Conte√∫do da mensagem: "Lamuriel, agrade√ßo por escolher nosso servi√ßo! Quando estiver pronto, posso te enviar os detalhes para pagamento via PIX. üòâ"
[2025-05-31 18:02:04] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Lamuriel, agrade√ßo por escolher nosso servi√ßo! Quando estiver pronto, posso te enviar os detalhes para pagamento via PIX. üòâ"
  }
}
[2025-05-31 18:02:04] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:02:04] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:02:04] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIzNTNBRkYxRjBBMzMxOEU5NgA="
    }
  ]
}
[2025-05-31 18:02:04] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:02:05] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:05] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725325921
[2025-05-31 18:02:05] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIzNTNBRkYxRjBBMzMxOEU5NgA=",
                "status": "sent",
                "timestamp": "1748725347",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:05] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:02:06] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:06] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725326079
[2025-05-31 18:02:06] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjIzNTNBRkYxRjBBMzMxOEU5NgA=",
                "status": "delivered",
                "timestamp": "1748725347",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:06] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:02:24] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:24] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725344142
[2025-05-31 18:02:24] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIEUyQzMxRTQxRDIyQzM5ODIwMEEwREQyODM0NDAxRkUxAA==",
                "timestamp": "1748725365",
                "text": {
                  "body": "Estou pronto"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:24] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:02:24] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725344142
[2025-05-31 18:02:24] debug: [webhook] Texto recebido: Estou pronto
[2025-05-31 18:02:24] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Estou pronto"
[2025-05-31 18:02:24] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725344183) para 5512988256404
[2025-05-31 18:02:24] debug: [handleMessage] [exec-1748725344183] üì≤ Iniciando atendimento: phone=5512988256404, texto="Estou pronto", isAudio=false
[2025-05-31 18:02:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:24] info: [handleMessage] [exec-1748725344183] Estado atual do cliente: pos_venda
[2025-05-31 18:02:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:24] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:02:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:24] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:02:24] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:02:24] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:02:24] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:02:24] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "pos_venda",
  "userMessage": "Estou pronto"
}
[2025-05-31 18:02:24] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: pos_venda\nMensagem do cliente: Estou pronto\nüìå "
    }
  ]
}
[2025-05-31 18:02:25] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "reativacao"
}
[2025-05-31 18:02:25] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 356,
    "completion_tokens": 3,
    "total_tokens": 359,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:02:25] info: [aiStateDecider] üß≠ Etapa atual: pos_venda ‚Äî IA sugeriu: reativacao
[2025-05-31 18:02:25] info: [handleMessage] [exec-1748725344183] Estado sugerido pela IA: reativacao
[2025-05-31 18:02:25] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí reativacao
[2025-05-31 18:02:25] debug: [ClientRepository] current_state atualizado para 'reativacao' e retries resetado
[2025-05-31 18:02:25] info: [handleMessage] [exec-1748725344183] Estado atualizado: pos_venda ‚Üí reativacao
[2025-05-31 18:02:25] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 24 mensagens.
[2025-05-31 18:02:25] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:02:25] info: [validadorMultiplos] [exec-1748725344183] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'reativacao'
[2025-05-31 18:02:25] info: [validadorMultiplos] [exec-1748725344183] üß© Validando metas da etapa: reativacao
[2025-05-31 18:02:25] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:25] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:02:25] debug: [extractReactivationReason] Nenhuma raz√£o de reativa√ß√£o reconhecida via regex
[2025-05-31 18:02:25] debug: [validadorMultiplos] [exec-1748725344183] ‚ö†Ô∏è Campo 'reactivation_reason' n√£o identificado no texto.
[2025-05-31 18:02:25] debug: [validadorMultiplos] [exec-1748725344183] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'reactivation_reason': 2.90ms
[2025-05-31 18:02:25] debug: [extractByIA] Prompt: Extraia o nome ou contato da pessoa indicada pelo cliente.
[2025-05-31 18:02:26] debug: [extractByIA] Resultado IA: Desculpe, mas voc√™ n√£o forneceu o nome ou contato de qualquer pessoa.
[2025-05-31 18:02:26] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:02:26] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "indicacao"
[2025-05-31 18:02:26] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas voc√™ n√£o forneceu o nome ou contato de qualquer pessoa."
[2025-05-31 18:02:26] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Estou pronto"
[2025-05-31 18:02:26] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:02:27] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o"
[2025-05-31 18:02:27] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 869ms
[2025-05-31 18:02:27] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "indicacao",
  "valor": "Desculpe, mas voc√™ n√£o forneceu o nome ou contato de qualquer pessoa.",
  "contexto": "Estou pronto",
  "resposta": "n√£o",
  "tempo_ms": 869,
  "validado": false
}
[2025-05-31 18:02:27] warn: [validadorMultiplos] [exec-1748725344183] ‚ùå Campo 'indicacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:02:27] info: [ClientRepository] Atualizando campo indicacao para 5512988256404: null
[2025-05-31 18:02:27] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:02:27] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | indicacao
[2025-05-31 18:02:27] debug: [validadorMultiplos] [exec-1748725344183] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'indicacao': 2382.03ms
[2025-05-31 18:02:27] info: [validadorMultiplos] [exec-1748725344183] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'reativacao'
[2025-05-31 18:02:27] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:02:27] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Estou pronto {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:02:28] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 18:02:28] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 18:02:28] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:02:28] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:02:28] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:28] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:02:28] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:02:28] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:02:28] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:02:28] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:02:28] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:02:28] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:02:29] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:02:29] info: [temperatura] üîç Calculando temperatura com base na etapa "reativacao" e perfil do cliente
[2025-05-31 18:02:29] debug: [temperatura] Etapa reconhecida: "reativacao" ‚Üí base inicial: 0.8
[2025-05-31 18:02:29] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:02:29] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:02:29] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:02:29] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:02:29] info: [temperatura] ‚úÖ Temperatura final calculada: 0.85
[2025-05-31 18:02:31] info: [handleMessage] [exec-1748725344183] üîç Texto bruto da IA antes do filtro: Que bom que retornou, Lamuriel! üôå Temos uma novidade: agora inclu√≠mos um tratamento p√≥s-procedimento para garantir ainda mais os resultados. Gostaria de marcar uma avalia√ß√£o gratuita para conversarmos sobre isso?
[2025-05-31 18:02:31] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:02:31] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa reativacao, phone=5512988256404
[2025-05-31 18:02:31] info: [handleMessage] [exec-1748725344183] ‚úÖ Texto final p√≥s-processado: Que bom que retornou, Lamuriel! ÔøΩ  Temos uma novidade: agora inclu√≠mos um tratamento p√≥s-procedimento para garantir ainda mais os resultados. Gostaria de marcar uma avalia√ß√£o gratuita para conversarmos sobre isso?
[2025-05-31 18:02:31] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:02:31] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:02:31] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:02:31] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 3273ms
[2025-05-31 18:02:35] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:02:35] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Que bom que retornou, Lamuriel! üôå Temos uma novidade: agora inclu√≠mos um tratamento p√≥s-procedimento para garantir ainda mais os resultados. Gostaria de marcar uma avalia√ß√£o gratuita para conversarmos sobre isso?" Timestamp=1748725355096
[2025-05-31 18:02:35] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:02:35] debug: [whatsapp] Conte√∫do da mensagem: "Que bom que retornou, Lamuriel! üôå Temos uma novidade: agora inclu√≠mos um tratamento p√≥s-procedimento para garantir ainda mais os resultados. Gostaria de marcar uma avalia√ß√£o gratuita para conversarmos sobre isso?"
[2025-05-31 18:02:35] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Que bom que retornou, Lamuriel! üôå Temos uma novidade: agora inclu√≠mos um tratamento p√≥s-procedimento para garantir ainda mais os resultados. Gostaria de marcar uma avalia√ß√£o gratuita para conversarmos sobre isso?"
  }
}
[2025-05-31 18:02:35] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:02:35] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:02:35] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjEzRkVDNkUzNzMzQ0Y4QUQyMgA="
    }
  ]
}
[2025-05-31 18:02:35] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:02:36] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:36] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725356915
[2025-05-31 18:02:36] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjEzRkVDNkUzNzMzQ0Y4QUQyMgA=",
                "status": "sent",
                "timestamp": "1748725378",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:36] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:02:36] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:36] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725356930
[2025-05-31 18:02:36] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjEzRkVDNkUzNzMzQ0Y4QUQyMgA=",
                "status": "delivered",
                "timestamp": "1748725378",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:36] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:02:54] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:02:54] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725374273
[2025-05-31 18:02:54] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDIxRjNDMjAyNzdBRkRDRTVBNTdDQjgxMzAxRDlCMzkxAA==",
                "timestamp": "1748725395",
                "text": {
                  "body": "Sim"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:02:54] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:02:54] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725374273
[2025-05-31 18:02:54] debug: [webhook] Texto recebido: Sim
[2025-05-31 18:02:54] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Sim"
[2025-05-31 18:02:54] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725374293) para 5512988256404
[2025-05-31 18:02:54] debug: [handleMessage] [exec-1748725374293] üì≤ Iniciando atendimento: phone=5512988256404, texto="Sim", isAudio=false
[2025-05-31 18:02:54] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:54] info: [handleMessage] [exec-1748725374293] Estado atual do cliente: reativacao
[2025-05-31 18:02:54] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:54] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:02:54] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:54] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:02:54] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:02:54] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:02:54] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:02:54] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "reativacao",
  "userMessage": "Sim"
}
[2025-05-31 18:02:54] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: reativacao\nMensagem do cliente: Sim\nüìå DADOS J√Å"
    }
  ]
}
[2025-05-31 18:02:55] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "levantamento"
}
[2025-05-31 18:02:55] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 354,
    "completion_tokens": 2,
    "total_tokens": 356,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:02:55] info: [aiStateDecider] üß≠ Etapa atual: reativacao ‚Äî IA sugeriu: levantamento
[2025-05-31 18:02:55] info: [handleMessage] [exec-1748725374293] Estado sugerido pela IA: levantamento
[2025-05-31 18:02:55] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí levantamento
[2025-05-31 18:02:55] debug: [ClientRepository] current_state atualizado para 'levantamento' e retries resetado
[2025-05-31 18:02:55] info: [handleMessage] [exec-1748725374293] Estado atualizado: reativacao ‚Üí levantamento
[2025-05-31 18:02:55] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 25 mensagens.
[2025-05-31 18:02:55] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:02:55] info: [validadorMultiplos] [exec-1748725374293] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'levantamento'
[2025-05-31 18:02:55] info: [validadorMultiplos] [exec-1748725374293] üß© Validando metas da etapa: levantamento
[2025-05-31 18:02:55] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:02:55] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:02:55] debug: [extractNeeds] Nenhuma necessidade reconhecida via regex
[2025-05-31 18:02:55] debug: [validadorMultiplos] [exec-1748725374293] ‚ö†Ô∏è Campo 'needs' n√£o identificado no texto.
[2025-05-31 18:02:55] debug: [validadorMultiplos] [exec-1748725374293] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'needs': 3.24ms
[2025-05-31 18:02:55] debug: [extractByIA] Prompt: Extraia as solu√ß√µes que o cliente j√° tentou anteriormente.
[2025-05-31 18:02:57] debug: [extractByIA] Resultado IA: Voc√™ n√£o forneceu informa√ß√µes suficientes para eu identificar as solu√ß√µes que o cliente j√° tentou. Por favor, forne√ßa mais detalhes.
[2025-05-31 18:02:57] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:02:57] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "attempted_solutions"
[2025-05-31 18:02:57] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Voc√™ n√£o forneceu informa√ß√µes suficientes para eu identificar as solu√ß√µes que o cliente j√° tentou. Por favor, forne√ßa mais detalhes."
[2025-05-31 18:02:57] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Sim"
[2025-05-31 18:02:57] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:02:58] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:02:58] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 777ms
[2025-05-31 18:02:58] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "attempted_solutions",
  "valor": "Voc√™ n√£o forneceu informa√ß√µes suficientes para eu identificar as solu√ß√µes que o cliente j√° tentou. Por favor, forne√ßa mais detalhes.",
  "contexto": "Sim",
  "resposta": "n√£o.",
  "tempo_ms": 777,
  "validado": false
}
[2025-05-31 18:02:58] warn: [validadorMultiplos] [exec-1748725374293] ‚ùå Campo 'attempted_solutions' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:02:58] info: [ClientRepository] Atualizando campo attempted_solutions para 5512988256404: null
[2025-05-31 18:02:58] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:02:58] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | attempted_solutions
[2025-05-31 18:02:58] debug: [validadorMultiplos] [exec-1748725374293] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'attempted_solutions': 2743.93ms
[2025-05-31 18:02:58] debug: [extractByIA] Prompt: O que o cliente espera ou deseja alcan√ßar com esse servi√ßo?
[2025-05-31 18:03:00] debug: [extractByIA] Resultado IA: Desculpe, mas a sua resposta n√£o est√° clara. Para poder lhe ajudar melhor, por favor forne√ßa mais detalhes sobre o servi√ßo mencionado.
[2025-05-31 18:03:00] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:03:00] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "expectations"
[2025-05-31 18:03:00] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas a sua resposta n√£o est√° clara. Para poder lhe ajudar melhor, por favor forne√ßa mais detalhes sobre o servi√ßo mencionado."
[2025-05-31 18:03:00] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Sim"
[2025-05-31 18:03:00] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:03:01] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:03:01] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1161ms
[2025-05-31 18:03:01] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "expectations",
  "valor": "Desculpe, mas a sua resposta n√£o est√° clara. Para poder lhe ajudar melhor, por favor forne√ßa mais detalhes sobre o servi√ßo mencionado.",
  "contexto": "Sim",
  "resposta": "n√£o.",
  "tempo_ms": 1161,
  "validado": false
}
[2025-05-31 18:03:01] warn: [validadorMultiplos] [exec-1748725374293] ‚ùå Campo 'expectations' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:03:01] info: [ClientRepository] Atualizando campo expectations para 5512988256404: null
[2025-05-31 18:03:01] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:03:01] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | expectations
[2025-05-31 18:03:01] debug: [validadorMultiplos] [exec-1748725374293] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'expectations': 3021.43ms
[2025-05-31 18:03:01] debug: [extractByIA] Prompt: Extraia o n√≠vel de urg√™ncia do cliente (baixa, m√©dia, alta, imediata).
[2025-05-31 18:03:02] debug: [extractByIA] Resultado IA: A pergunta n√£o fornece informa√ß√µes suficientes para determinar o n√≠vel de urg√™ncia do cliente.
[2025-05-31 18:03:02] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:03:02] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "urgency_level"
[2025-05-31 18:03:02] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "A pergunta n√£o fornece informa√ß√µes suficientes para determinar o n√≠vel de urg√™ncia do cliente."
[2025-05-31 18:03:02] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Sim"
[2025-05-31 18:03:02] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:03:04] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:03:04] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1293ms
[2025-05-31 18:03:04] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "urgency_level",
  "valor": "A pergunta n√£o fornece informa√ß√µes suficientes para determinar o n√≠vel de urg√™ncia do cliente.",
  "contexto": "Sim",
  "resposta": "n√£o.",
  "tempo_ms": 1293,
  "validado": false
}
[2025-05-31 18:03:04] warn: [validadorMultiplos] [exec-1748725374293] ‚ùå Campo 'urgency_level' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:03:04] info: [ClientRepository] Atualizando campo urgency_level para 5512988256404: null
[2025-05-31 18:03:04] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:03:04] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | urgency_level
[2025-05-31 18:03:04] debug: [validadorMultiplos] [exec-1748725374293] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'urgency_level': 2668.12ms
[2025-05-31 18:03:04] info: [validadorMultiplos] [exec-1748725374293] Campo 'client_stage' j√° est√° preenchido: O cliente est√° no es. Pulando.
[2025-05-31 18:03:04] debug: [extractByIA] Prompt: Extraia a disponibilidade de hor√°rio do cliente. Ex: "sexta √† tarde", "amanh√£ de manh√£".
[2025-05-31 18:03:06] debug: [extractByIA] Resultado IA: Desculpe, a entrada dada n√£o especifica a disponibilidade do cliente. Por favor, forne√ßa uma entrada v√°lida, como "sexta √† tarde" ou "amanh√£ de manh√£".
[2025-05-31 18:03:06] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:03:06] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "disponibilidade"
[2025-05-31 18:03:06] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, a entrada dada n√£o especifica a disponibilidade do cliente. Por favor, forne√ßa uma entrada v√°lida, como "sexta √† tarde" ou "amanh√£ de manh√£"."
[2025-05-31 18:03:06] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Sim"
[2025-05-31 18:03:06] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:03:07] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:03:07] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1179ms
[2025-05-31 18:03:07] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "disponibilidade",
  "valor": "Desculpe, a entrada dada n√£o especifica a disponibilidade do cliente. Por favor, forne√ßa uma entrada v√°lida, como \"sexta √† tarde\" ou \"amanh√£ de manh√£\".",
  "contexto": "Sim",
  "resposta": "n√£o.",
  "tempo_ms": 1179,
  "validado": false
}
[2025-05-31 18:03:07] warn: [validadorMultiplos] [exec-1748725374293] ‚ùå Campo 'disponibilidade' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:03:07] info: [ClientRepository] Atualizando campo disponibilidade para 5512988256404: null
[2025-05-31 18:03:07] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:03:07] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | disponibilidade
[2025-05-31 18:03:07] debug: [validadorMultiplos] [exec-1748725374293] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'disponibilidade': 3226.14ms
[2025-05-31 18:03:07] info: [validadorMultiplos] [exec-1748725374293] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'levantamento'
[2025-05-31 18:03:07] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:03:07] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Sim {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:03:08] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 18:03:08] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 18:03:08] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:03:08] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:03:08] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:08] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:03:08] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:03:08] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:03:08] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:03:08] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:03:08] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:03:08] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:03:08] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:03:08] info: [temperatura] üîç Calculando temperatura com base na etapa "levantamento" e perfil do cliente
[2025-05-31 18:03:08] debug: [temperatura] Etapa reconhecida: "levantamento" ‚Üí base inicial: 0.85
[2025-05-31 18:03:08] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:03:08] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:03:08] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:03:08] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:03:08] info: [temperatura] ‚úÖ Temperatura final calculada: 0.9
[2025-05-31 18:03:09] info: [handleMessage] [exec-1748725374293] üîç Texto bruto da IA antes do filtro: √ìtimo! Gostaria de agendar uma avalia√ß√£o gratuita ou tem alguma d√∫vida que posso esclarecer?
[2025-05-31 18:03:09] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:03:09] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa levantamento, phone=5512988256404
[2025-05-31 18:03:09] info: [handleMessage] [exec-1748725374293] ‚úÖ Texto final p√≥s-processado: √ìtimo! Gostaria de agendar uma avalia√ß√£o gratuita ou tem alguma d√∫vida que posso esclarecer?
[2025-05-31 18:03:09] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:03:09] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:03:09] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:03:09] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5703ms
[2025-05-31 18:03:15] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:03:15] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "√ìtimo! Gostaria de agendar uma avalia√ß√£o gratuita ou tem alguma d√∫vida que posso esclarecer?" Timestamp=1748725395274
[2025-05-31 18:03:15] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:03:15] debug: [whatsapp] Conte√∫do da mensagem: "√ìtimo! Gostaria de agendar uma avalia√ß√£o gratuita ou tem alguma d√∫vida que posso esclarecer?"
[2025-05-31 18:03:15] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "√ìtimo! Gostaria de agendar uma avalia√ß√£o gratuita ou tem alguma d√∫vida que posso esclarecer?"
  }
}
[2025-05-31 18:03:15] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:03:16] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:03:16] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxODI2MzhFMzc5NDUyNzAyMgA="
    }
  ]
}
[2025-05-31 18:03:16] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:03:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:03:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725396805
[2025-05-31 18:03:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxODI2MzhFMzc5NDUyNzAyMgA=",
                "status": "sent",
                "timestamp": "1748725418",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:03:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:03:17] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:03:17] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725397093
[2025-05-31 18:03:17] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQxODI2MzhFMzc5NDUyNzAyMgA=",
                "status": "delivered",
                "timestamp": "1748725418",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:03:17] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:03:37] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:03:37] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725417592
[2025-05-31 18:03:37] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDk4NEU4Mzc5OUM2QzRBQUY1RDdDM0I1N0Q2REQ3MzY2AA==",
                "timestamp": "1748725438",
                "text": {
                  "body": "Pode agendar"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:03:37] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:03:37] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725417592
[2025-05-31 18:03:37] debug: [webhook] Texto recebido: Pode agendar
[2025-05-31 18:03:37] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Pode agendar"
[2025-05-31 18:03:37] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725417608) para 5512988256404
[2025-05-31 18:03:37] debug: [handleMessage] [exec-1748725417608] üì≤ Iniciando atendimento: phone=5512988256404, texto="Pode agendar", isAudio=false
[2025-05-31 18:03:37] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:37] info: [handleMessage] [exec-1748725417608] Estado atual do cliente: levantamento
[2025-05-31 18:03:37] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:37] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:03:37] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:37] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:03:37] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:03:37] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:03:37] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:03:37] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "levantamento",
  "userMessage": "Pode agendar"
}
[2025-05-31 18:03:37] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: levantamento\nMensagem do cliente: Pode agendar\n"
    }
  ]
}
[2025-05-31 18:03:39] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "proposta"
}
[2025-05-31 18:03:39] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 357,
    "completion_tokens": 2,
    "total_tokens": 359,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:03:39] info: [aiStateDecider] üß≠ Etapa atual: levantamento ‚Äî IA sugeriu: proposta
[2025-05-31 18:03:39] info: [handleMessage] [exec-1748725417608] Estado sugerido pela IA: proposta
[2025-05-31 18:03:39] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí proposta
[2025-05-31 18:03:39] debug: [ClientRepository] current_state atualizado para 'proposta' e retries resetado
[2025-05-31 18:03:39] info: [handleMessage] [exec-1748725417608] Estado atualizado: levantamento ‚Üí proposta
[2025-05-31 18:03:39] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 26 mensagens.
[2025-05-31 18:03:39] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:03:39] info: [validadorMultiplos] [exec-1748725417608] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'proposta'
[2025-05-31 18:03:39] info: [validadorMultiplos] [exec-1748725417608] üß© Validando metas da etapa: proposta
[2025-05-31 18:03:39] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:39] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:03:39] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 18:03:39] debug: [validadorMultiplos] [exec-1748725417608] ‚ö†Ô∏è Campo 'budget' n√£o identificado no texto.
[2025-05-31 18:03:39] debug: [validadorMultiplos] [exec-1748725417608] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'budget': 5.00ms
[2025-05-31 18:03:39] info: [validadorMultiplos] [exec-1748725417608] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'proposta'
[2025-05-31 18:03:39] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:03:39] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Pode agendar {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:03:40] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "abordagem"
}
[2025-05-31 18:03:40] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "abordagem"
[2025-05-31 18:03:40] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:03:40] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:03:40] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:03:40] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:03:40] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:03:40] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:03:40] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:03:40] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:03:40] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:03:40] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:03:40] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:03:40] info: [temperatura] üîç Calculando temperatura com base na etapa "proposta" e perfil do cliente
[2025-05-31 18:03:40] debug: [temperatura] Etapa reconhecida: "proposta" ‚Üí base inicial: 0.75
[2025-05-31 18:03:40] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:03:40] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:03:40] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:03:40] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:03:40] info: [temperatura] ‚úÖ Temperatura final calculada: 0.8
[2025-05-31 18:03:42] info: [handleMessage] [exec-1748725417608] üîç Texto bruto da IA antes do filtro: Claro, para qual data e hor√°rio voc√™ gostaria de agendar sua avalia√ß√£o gratuita e possivelmente o procedimento de micropigmenta√ß√£o de barba?
[2025-05-31 18:03:42] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:03:42] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa proposta, phone=5512988256404
[2025-05-31 18:03:42] info: [handleMessage] [exec-1748725417608] ‚úÖ Texto final p√≥s-processado: para qual data e hor√°rio voc√™ gostaria de agendar sua avalia√ß√£o gratuita e possivelmente o procedimento de micropigmenta√ß√£o de barba?
[2025-05-31 18:03:42] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:03:42] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:03:42] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:03:42] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6665ms
[2025-05-31 18:03:48] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:03:48] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "para qual data e hor√°rio voc√™ gostaria de agendar sua avalia√ß√£o gratuita e possivelmente o procedimento de micropigmenta√ß√£o de barba?" Timestamp=1748725428818
[2025-05-31 18:03:48] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:03:48] debug: [whatsapp] Conte√∫do da mensagem: "para qual data e hor√°rio voc√™ gostaria de agendar sua avalia√ß√£o gratuita e possivelmente o procedimento de micropigmenta√ß√£o de barba?"
[2025-05-31 18:03:48] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "para qual data e hor√°rio voc√™ gostaria de agendar sua avalia√ß√£o gratuita e possivelmente o procedimento de micropigmenta√ß√£o de barba?"
  }
}
[2025-05-31 18:03:48] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:03:49] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:03:49] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQ0M0M5NkY1QTc1RDAwODA4MgA="
    }
  ]
}
[2025-05-31 18:03:49] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:03:50] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:03:50] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725430596
[2025-05-31 18:03:50] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQ0M0M5NkY1QTc1RDAwODA4MgA=",
                "status": "sent",
                "timestamp": "1748725451",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:03:50] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:03:50] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:03:50] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725430757
[2025-05-31 18:03:50] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEkQ0M0M5NkY1QTc1RDAwODA4MgA=",
                "status": "delivered",
                "timestamp": "1748725452",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:03:50] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:05:24] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:05:24] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725524131
[2025-05-31 18:05:24] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDlFNDM4RUIxNjM3RTc0QzIwMUY3OTRGN0QzMDdCNjM2AA==",
                "timestamp": "1748725545",
                "text": {
                  "body": "Quinta pela manh√£"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:05:24] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:05:24] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748725524131
[2025-05-31 18:05:24] debug: [webhook] Texto recebido: Quinta pela manh√£
[2025-05-31 18:05:24] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Quinta pela manh√£"
[2025-05-31 18:05:24] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748725524171) para 5512988256404
[2025-05-31 18:05:24] debug: [handleMessage] [exec-1748725524171] üì≤ Iniciando atendimento: phone=5512988256404, texto="Quinta pela manh√£", isAudio=false
[2025-05-31 18:05:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:05:24] info: [handleMessage] [exec-1748725524171] Estado atual do cliente: proposta
[2025-05-31 18:05:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:05:24] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:05:24] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:05:24] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:05:24] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:05:24] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:05:24] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:05:24] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "proposta",
  "userMessage": "Quinta pela manh√£"
}
[2025-05-31 18:05:24] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: proposta\nMensagem do cliente: Quinta pela manh√£"
    }
  ]
}
[2025-05-31 18:05:25] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "negociacao"
}
[2025-05-31 18:05:25] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 358,
    "completion_tokens": 3,
    "total_tokens": 361,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:05:25] info: [aiStateDecider] üß≠ Etapa atual: proposta ‚Äî IA sugeriu: negociacao
[2025-05-31 18:05:25] info: [handleMessage] [exec-1748725524171] Estado sugerido pela IA: negociacao
[2025-05-31 18:05:25] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí negociacao
[2025-05-31 18:05:25] debug: [ClientRepository] current_state atualizado para 'negociacao' e retries resetado
[2025-05-31 18:05:25] info: [handleMessage] [exec-1748725524171] Estado atualizado: proposta ‚Üí negociacao
[2025-05-31 18:05:25] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 27 mensagens.
[2025-05-31 18:05:25] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:05:25] info: [validadorMultiplos] [exec-1748725524171] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'negociacao'
[2025-05-31 18:05:25] info: [validadorMultiplos] [exec-1748725524171] üß© Validando metas da etapa: negociacao
[2025-05-31 18:05:25] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:05:25] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:05:25] debug: [extractBudget] Nenhum or√ßamento reconhecido via regex
[2025-05-31 18:05:25] debug: [validadorMultiplos] [exec-1748725524171] ‚ö†Ô∏è Campo 'negotiated_price' n√£o identificado no texto.
[2025-05-31 18:05:25] debug: [validadorMultiplos] [exec-1748725524171] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'negotiated_price': 4.52ms
[2025-05-31 18:05:25] info: [validadorMultiplos] [exec-1748725524171] Campo 'purchase_intent' j√° est√° preenchido: Talvez. Pulando.
[2025-05-31 18:05:25] debug: [extractByIA] Prompt: Extraia o valor percentual de desconto solicitado. Apenas o n√∫mero.
[2025-05-31 18:05:26] debug: [extractByIA] Resultado IA: Desculpe, mas n√£o h√° uma porcentagem de desconto mencionada nessa frase para ser extra√≠da.
[2025-05-31 18:05:26] debug: [extractDesconto] Extra√≠do via IA: NaN%
[2025-05-31 18:05:26] debug: [validadorMultiplos] [exec-1748725524171] ‚ö†Ô∏è Campo 'desconto' n√£o identificado no texto.
[2025-05-31 18:05:26] debug: [validadorMultiplos] [exec-1748725524171] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'desconto': 1348.62ms
[2025-05-31 18:05:26] debug: [extractByIA] Prompt: Extraia a forma de pagamento citada pelo cliente (pix, cart√£o, etc.)
[2025-05-31 18:05:28] debug: [extractByIA] Resultado IA: O texto fornecido n√£o especifica uma forma de pagamento. Por favor, forne√ßa um exemplo que mencione um m√©todo de pagamento.
[2025-05-31 18:05:28] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:05:28] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "forma_pagamento"
[2025-05-31 18:05:28] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "O texto fornecido n√£o especifica uma forma de pagamento. Por favor, forne√ßa um exemplo que mencione um m√©todo de pagamento."
[2025-05-31 18:05:28] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "Quinta pela manh√£"
[2025-05-31 18:05:28] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:05:29] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:05:29] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 869ms
[2025-05-31 18:05:29] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "forma_pagamento",
  "valor": "O texto fornecido n√£o especifica uma forma de pagamento. Por favor, forne√ßa um exemplo que mencione um m√©todo de pagamento.",
  "contexto": "Quinta pela manh√£",
  "resposta": "n√£o.",
  "tempo_ms": 869,
  "validado": false
}
[2025-05-31 18:05:29] warn: [validadorMultiplos] [exec-1748725524171] ‚ùå Campo 'forma_pagamento' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:05:29] info: [ClientRepository] Atualizando campo forma_pagamento para 5512988256404: null
[2025-05-31 18:05:29] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:05:29] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | forma_pagamento
[2025-05-31 18:05:29] debug: [validadorMultiplos] [exec-1748725524171] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'forma_pagamento': 2292.35ms
[2025-05-31 18:05:29] info: [validadorMultiplos] [exec-1748725524171] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'negociacao'
[2025-05-31 18:05:29] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:05:29] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Quinta pela manh√£ {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:05:30] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 18:05:30] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 18:05:30] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:05:30] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:05:30] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:05:30] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:05:30] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:05:30] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:05:30] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:05:30] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:05:30] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:05:30] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:05:30] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:05:30] info: [temperatura] üîç Calculando temperatura com base na etapa "negociacao" e perfil do cliente
[2025-05-31 18:05:30] debug: [temperatura] Etapa reconhecida: "negociacao" ‚Üí base inicial: 0.6
[2025-05-31 18:05:30] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:05:30] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:05:30] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:05:30] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:05:30] info: [temperatura] ‚úÖ Temperatura final calculada: 0.65
[2025-05-31 18:05:31] info: [handleMessage] [exec-1748725524171] üîç Texto bruto da IA antes do filtro: Perfeito, Lamuriel! Temos hor√°rios dispon√≠veis na quinta pela manh√£. Qual hor√°rio seria ideal para voc√™?
[2025-05-31 18:05:31] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:05:31] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa negociacao, phone=5512988256404
[2025-05-31 18:05:31] info: [handleMessage] [exec-1748725524171] ‚úÖ Texto final p√≥s-processado: Perfeito, Lamuriel! Temos hor√°rios dispon√≠veis na quinta pela manh√£. Qual hor√°rio seria ideal para voc√™?
[2025-05-31 18:05:31] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:05:31] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:05:31] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:05:31] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 4429ms
[2025-05-31 18:05:36] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:05:36] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Perfeito, Lamuriel! Temos hor√°rios dispon√≠veis na quinta pela manh√£. Qual hor√°rio seria ideal para voc√™?" Timestamp=1748725536430
[2025-05-31 18:05:36] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:05:36] debug: [whatsapp] Conte√∫do da mensagem: "Perfeito, Lamuriel! Temos hor√°rios dispon√≠veis na quinta pela manh√£. Qual hor√°rio seria ideal para voc√™?"
[2025-05-31 18:05:36] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Perfeito, Lamuriel! Temos hor√°rios dispon√≠veis na quinta pela manh√£. Qual hor√°rio seria ideal para voc√™?"
  }
}
[2025-05-31 18:05:36] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:05:37] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:05:37] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjVEOUY5NjY3ODA3MDhCRjVCRgA="
    }
  ]
}
[2025-05-31 18:05:37] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:05:38] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:05:38] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725538190
[2025-05-31 18:05:38] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjVEOUY5NjY3ODA3MDhCRjVCRgA=",
                "status": "sent",
                "timestamp": "1748725559",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:05:38] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:05:38] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:05:38] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748725538225
[2025-05-31 18:05:38] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjVEOUY5NjY3ODA3MDhCRjVCRgA=",
                "status": "delivered",
                "timestamp": "1748725559",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:05:38] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:15:00] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:15:00] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726100059
[2025-05-31 18:15:00] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDY0MDY5MkJBMTMxNEEzQjREMUU1QkIwM0Y1N0JBMEY3AA==",
                "timestamp": "1748726121",
                "text": {
                  "body": "11h"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:15:00] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:15:00] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748726100059
[2025-05-31 18:15:00] debug: [webhook] Texto recebido: 11h
[2025-05-31 18:15:00] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "11h"
[2025-05-31 18:15:00] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748726100071) para 5512988256404
[2025-05-31 18:15:00] debug: [handleMessage] [exec-1748726100071] üì≤ Iniciando atendimento: phone=5512988256404, texto="11h", isAudio=false
[2025-05-31 18:15:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:15:00] info: [handleMessage] [exec-1748726100071] Estado atual do cliente: negociacao
[2025-05-31 18:15:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:15:00] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:15:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:15:00] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:15:00] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:15:00] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:15:00] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:15:00] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "negociacao",
  "userMessage": "11h"
}
[2025-05-31 18:15:00] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: negociacao\nMensagem do cliente: 11h\nüìå DADOS J√Å"
    }
  ]
}
[2025-05-31 18:15:00] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "fechamento"
}
[2025-05-31 18:15:00] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 355,
    "completion_tokens": 3,
    "total_tokens": 358,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:15:00] info: [aiStateDecider] üß≠ Etapa atual: negociacao ‚Äî IA sugeriu: fechamento
[2025-05-31 18:15:00] info: [handleMessage] [exec-1748726100071] Estado sugerido pela IA: fechamento
[2025-05-31 18:15:00] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí fechamento
[2025-05-31 18:15:00] debug: [ClientRepository] current_state atualizado para 'fechamento' e retries resetado
[2025-05-31 18:15:00] info: [handleMessage] [exec-1748726100071] Estado atualizado: negociacao ‚Üí fechamento
[2025-05-31 18:15:00] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 28 mensagens.
[2025-05-31 18:15:00] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:15:00] info: [validadorMultiplos] [exec-1748726100071] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'fechamento'
[2025-05-31 18:15:00] info: [validadorMultiplos] [exec-1748726100071] üß© Validando metas da etapa: fechamento
[2025-05-31 18:15:00] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:15:00] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:15:00] info: [validadorMultiplos] [exec-1748726100071] Campo 'address' n√£o se aplica ao produto 'produto1'. Salvando null.
[2025-05-31 18:15:00] info: [ClientRepository] Atualizando campo address para 5512988256404: null
[2025-05-31 18:15:00] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:15:00] error: [mongo] ‚ùå Erro ao salvar campo rejeitado {
  "error": {
    "errors": {
      "valor": {
        "name": "ValidatorError",
        "message": "Path `valor` is required.",
        "properties": {
          "message": "Path `valor` is required.",
          "type": "required",
          "path": "valor",
          "value": null
        },
        "kind": "required",
        "path": "valor",
        "value": null
      }
    },
    "_message": "Rejection validation failed",
    "name": "ValidationError",
    "message": "Rejection validation failed: valor: Path `valor` is required."
  },
  "data": {
    "phone": "5512988256404",
    "clientId": 4,
    "campo": "address",
    "valor": null,
    "motivo": "Campo n√£o aplic√°vel ao produto",
    "messageIn": "11h",
    "createdAt": "2025-05-31T21:15:00.958Z"
  }
}
[2025-05-31 18:15:00] info: [validadorMultiplos] [exec-1748726100071] Campo 'payment_method' j√° est√° preenchido: pix. Pulando.
[2025-05-31 18:15:00] debug: [validadorMultiplos] [exec-1748726100071] ‚ö†Ô∏è Campo 'schedule_time' n√£o identificado no texto.
[2025-05-31 18:15:00] debug: [validadorMultiplos] [exec-1748726100071] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'schedule_time': 8.88ms
[2025-05-31 18:15:00] debug: [extractByIA] Prompt: Cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 18:15:03] debug: [extractByIA] Resultado IA: Desculpe, mas sua resposta n√£o est√° clara. Voc√™ pode confirmar se o cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar.
[2025-05-31 18:15:03] debug: [validadorIA] ‚è≥ Iniciando valida√ß√£o com IA
[2025-05-31 18:15:03] debug: [validadorIA] ‚ñ∂Ô∏è Campo: "confirmacao"
[2025-05-31 18:15:03] debug: [validadorIA] ‚ñ∂Ô∏è Valor: "Desculpe, mas sua resposta n√£o est√° clara. Voc√™ pode confirmar se o cliente confirmou o fechamento? Retorne: "sim", "confirmado" ou similar."
[2025-05-31 18:15:03] debug: [validadorIA] ‚ñ∂Ô∏è Contexto: "11h"
[2025-05-31 18:15:03] debug: [validadorIA] ‚ñ∂Ô∏è Idioma: "pt"
[2025-05-31 18:15:04] debug: [validadorIA] üß† Resposta bruta da IA: "n√£o."
[2025-05-31 18:15:04] debug: [validadorIA] ‚è±Ô∏è Tempo de resposta: 1297ms
[2025-05-31 18:15:04] info: [validadorIA] ‚úÖ Resultado da valida√ß√£o {
  "campo": "confirmacao",
  "valor": "Desculpe, mas sua resposta n√£o est√° clara. Voc√™ pode confirmar se o cliente confirmou o fechamento? Retorne: \"sim\", \"confirmado\" ou similar.",
  "contexto": "11h",
  "resposta": "n√£o.",
  "tempo_ms": 1297,
  "validado": false
}
[2025-05-31 18:15:04] warn: [validadorMultiplos] [exec-1748726100071] ‚ùå Campo 'confirmacao' rejeitado pela IA. Salvando null e logando no MongoDB.
[2025-05-31 18:15:04] info: [ClientRepository] Atualizando campo confirmacao para 5512988256404: null
[2025-05-31 18:15:04] debug: [ClientRepository] Resultado do update: {
  "fieldCount": 0,
  "affectedRows": 1,
  "insertId": 0,
  "info": "Rows matched: 1  Changed: 0  Warnings: 0",
  "serverStatus": 34,
  "warningStatus": 0,
  "changedRows": 0
}
[2025-05-31 18:15:04] info: [mongo] ‚ö†Ô∏è Campo rejeitado salvo no MongoDB: 5512988256404 | confirmacao
[2025-05-31 18:15:04] debug: [validadorMultiplos] [exec-1748726100071] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'confirmacao': 3971.86ms
[2025-05-31 18:15:04] info: [validadorMultiplos] [exec-1748726100071] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'fechamento'
[2025-05-31 18:15:04] debug: [metaPorEtapa] üîç Metas esperadas para etapa "negociacao": negotiated_price, purchase_intent, desconto, forma_pagamento
[2025-05-31 18:15:04] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: negociacao
[2025-05-31 18:15:04] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 18:15:04] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 18:15:04] debug: [metaPorEtapa] üîç Metas esperadas para etapa "fechamento": address, payment_method, schedule_time, confirmacao
[2025-05-31 18:15:04] debug: [verificadorContradicoes] Verificando contradi√ß√µes para etapa: fechamento
[2025-05-31 18:15:04] debug: [verificadorContradicoes] Total de alertas gerados: 0
[2025-05-31 18:15:04] info: [handleMessage] [exec-1748726100071] üìã Checklist fechamento: {
  "aprovado": false,
  "faltando": [
    "address",
    "schedule_time",
    "confirmacao"
  ],
  "contradicoes": []
}
[2025-05-31 18:15:04] info: [handleMessage] [exec-1748726100071] ‚ö†Ô∏è Contradi√ß√µes encontradas:
[2025-05-31 18:15:04] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:15:04] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados 11h {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:15:05] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 18:15:05] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 18:15:05] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:15:05] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: fechamentoPrompt
[2025-05-31 18:15:05] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:15:05] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:15:05] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:15:05] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:15:05] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:15:05] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:15:05] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:15:05] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:15:05] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:15:05] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:15:05] info: [temperatura] üîç Calculando temperatura com base na etapa "fechamento" e perfil do cliente
[2025-05-31 18:15:05] debug: [temperatura] Etapa reconhecida: "fechamento" ‚Üí base inicial: 0.4
[2025-05-31 18:15:05] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:15:05] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:15:05] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:15:05] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:15:05] info: [temperatura] ‚úÖ Temperatura final calculada: 0.45
[2025-05-31 18:15:07] info: [handleMessage] [exec-1748726100071] üîç Texto bruto da IA antes do filtro: Perfeito, Lamuriel! Podemos agendar sua micropigmenta√ß√£o de barba para as 11h. Qual seria o melhor dia para voc√™?
[2025-05-31 18:15:07] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:15:07] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa fechamento, phone=5512988256404
[2025-05-31 18:15:07] info: [handleMessage] [exec-1748726100071] ‚úÖ Texto final p√≥s-processado: Perfeito, Lamuriel! Podemos agendar sua micropigmenta√ß√£o de barba para as 11h. Qual seria o melhor dia para voc√™?
[2025-05-31 18:15:07] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:15:07] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:15:07] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:15:07] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 6817ms
[2025-05-31 18:15:14] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:15:14] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Perfeito, Lamuriel! Podemos agendar sua micropigmenta√ß√£o de barba para as 11h. Qual seria o melhor dia para voc√™?" Timestamp=1748726114606
[2025-05-31 18:15:14] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:15:14] debug: [whatsapp] Conte√∫do da mensagem: "Perfeito, Lamuriel! Podemos agendar sua micropigmenta√ß√£o de barba para as 11h. Qual seria o melhor dia para voc√™?"
[2025-05-31 18:15:14] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Perfeito, Lamuriel! Podemos agendar sua micropigmenta√ß√£o de barba para as 11h. Qual seria o melhor dia para voc√™?"
  }
}
[2025-05-31 18:15:14] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:15:15] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:15:15] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjUxN0RFNkQxMTk2OTQ5RTI3QwA="
    }
  ]
}
[2025-05-31 18:15:15] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:15:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:15:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726116068
[2025-05-31 18:15:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjUxN0RFNkQxMTk2OTQ5RTI3QwA=",
                "status": "sent",
                "timestamp": "1748726137",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:15:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:15:16] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:15:16] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726116384
[2025-05-31 18:15:16] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjUxN0RFNkQxMTk2OTQ5RTI3QwA=",
                "status": "delivered",
                "timestamp": "1748726137",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:15:16] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:16:19] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:16:19] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726179939
[2025-05-31 18:16:19] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lagarto"
                },
                "wa_id": "5512988256404"
              }
            ],
            "messages": [
              {
                "from": "5512988256404",
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABIYIDg2QTcwMzVCQjgzNTcyRjVGMDY0MzUwMjIzRDVFRDVEAA==",
                "timestamp": "1748726201",
                "text": {
                  "body": "Quinta"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:16:19] debug: üì• Mensagem recebida: [object Object]
[2025-05-31 18:16:19] info: [webhook] ‚ñ∂Ô∏è Webhook recebido para 5512988256404, timestamp=1748726179939
[2025-05-31 18:16:19] debug: [webhook] Texto recebido: Quinta
[2025-05-31 18:16:19] info: [mensagem] üì• Mensagem recebida do cliente (5512988256404): "Quinta"
[2025-05-31 18:16:19] info: [handleMessage] ‚ñ∂Ô∏è Nova execu√ß√£o iniciada (exec-1748726179976) para 5512988256404
[2025-05-31 18:16:19] debug: [handleMessage] [exec-1748726179976] üì≤ Iniciando atendimento: phone=5512988256404, texto="Quinta", isAudio=false
[2025-05-31 18:16:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:16:19] info: [handleMessage] [exec-1748726179976] Estado atual do cliente: fechamento
[2025-05-31 18:16:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:16:19] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:16:19] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:16:19] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:16:19] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:16:19] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:16:20] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:16:20] debug: [aiStateDecider] Enviando para IA decidir pr√≥ximo estado {
  "currentState": "fechamento",
  "userMessage": "Quinta"
}
[2025-05-31 18:16:20] debug: [openai] Criando chat completion {
  "model": "gpt-4-1106-preview",
  "temperature": 0.9,
  "origem": "vinda do .env ou env.ts",
  "mensagens": [
    {
      "role": "system",
      "preview": "Voc√™ √© um assistente de vendas que decide a pr√≥xima etapa do"
    },
    {
      "role": "user",
      "preview": "Etapa atual: fechamento\nMensagem do cliente: Quinta\nüìå DADOS"
    }
  ]
}
[2025-05-31 18:16:20] info: [openai] ü§ñ Resposta da IA recebida {
  "texto": "pos_venda"
}
[2025-05-31 18:16:20] debug: [openai] Completion metadata {
  "finish_reason": "stop",
  "usage": {
    "prompt_tokens": 355,
    "completion_tokens": 3,
    "total_tokens": 358,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  }
}
[2025-05-31 18:16:20] info: [aiStateDecider] üß≠ Etapa atual: fechamento ‚Äî IA sugeriu: pos_venda
[2025-05-31 18:16:20] info: [handleMessage] [exec-1748726179976] Estado sugerido pela IA: pos_venda
[2025-05-31 18:16:20] info: [ClientRepository] Atualizando estado do cliente: 5512988256404 ‚Üí pos_venda
[2025-05-31 18:16:20] debug: [ClientRepository] current_state atualizado para 'pos_venda' e retries resetado
[2025-05-31 18:16:20] info: [handleMessage] [exec-1748726179976] Estado atualizado: fechamento ‚Üí pos_venda
[2025-05-31 18:16:20] info: [mongo] üìñ Hist√≥rico carregado para 5512988256404, total de 29 mensagens.
[2025-05-31 18:16:20] debug: [perfil] üïê Aguardando mais mensagens do cliente (0/4)...
[2025-05-31 18:16:20] info: [validadorMultiplos] [exec-1748726179976] üõ†Ô∏è Iniciando valida√ß√£o m√∫ltipla para etapa 'pos_venda'
[2025-05-31 18:16:20] info: [validadorMultiplos] [exec-1748726179976] üß© Validando metas da etapa: pos_venda
[2025-05-31 18:16:20] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:16:20] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: validadorMultiplos
[2025-05-31 18:16:20] debug: [extractFeedback] Nenhum feedback reconhecido via regex
[2025-05-31 18:16:20] debug: [validadorMultiplos] [exec-1748726179976] ‚ö†Ô∏è Campo 'feedback' n√£o identificado no texto.
[2025-05-31 18:16:20] debug: [validadorMultiplos] [exec-1748726179976] ‚è±Ô∏è Tempo de execu√ß√£o para campo 'feedback': 3.55ms
[2025-05-31 18:16:20] info: [validadorMultiplos] [exec-1748726179976] ‚úÖ Valida√ß√£o m√∫ltipla conclu√≠da para etapa 'pos_venda'
[2025-05-31 18:16:20] debug: [intentFallback] üîç Iniciando fallback de inten√ß√£o via IA
[2025-05-31 18:16:20] debug: [intentFallback] Prompt do sistema e mensagem do usu√°rio enviados Quinta {
  "prompt": "Voc√™ √© um classificador de inten√ß√µes para um funil de vendas. \n  Dado o conte√∫do de uma mensagem de um cliente, voc√™ deve responder apenas com uma destas palavras:\n  abordagem, levantamento, proposta, objecoes, negociacao, fechamento, posvenda, reativacao, encerramento.\n  N√£o explique, n√£o comente, apenas retorne a palavra da inten√ß√£o correta."
}
[2025-05-31 18:16:21] debug: [intentFallback] üß† Resposta recebida do ChatGPT {
  "intent": "encerramento"
}
[2025-05-31 18:16:21] info: [intentFallback] ‚úÖ Inten√ß√£o reconhecida via fallback: "encerramento"
[2025-05-31 18:16:21] info: [produtoMap] ‚úÖ Produto carregado: Micropigmenta√ß√£o de Barba ‚Äî Origem: conversationManager
[2025-05-31 18:16:21] debug: [resumoDoHistorico] Iniciando leitura do hist√≥rico do cliente 5512988256404
[2025-05-31 18:16:21] debug: [ClientRepository] Buscando cliente por telefone: 5512988256404
[2025-05-31 18:16:21] debug: [resumoDoHistorico] name: Lamuriel
[2025-05-31 18:16:21] debug: [resumoDoHistorico] client_stage: O cliente est√° no es
[2025-05-31 18:16:21] debug: [resumoDoHistorico] objection_type: A obje√ß√£o apresentada pelo cliente √© o pre√ßo.
[2025-05-31 18:16:21] debug: [resumoDoHistorico] purchase_intent: Talvez
[2025-05-31 18:16:21] info: [perfilCliente] üîç Recuperando perfil para 5512988256404 baseado no botPersona
[2025-05-31 18:16:21] debug: [perfilCliente] Estilo de fala atual aplicado no botPersona: {
  "tom": "objetivo, simp√°tico e vendedor",
  "formalidade": "informal como padr√£o; formal s√≥ se o cliente for s√©rio",
  "vocabul√°rio": "popular, acess√≠vel, claro",
  "emojis": true,
  "frasesCurtas": true,
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "evita": [
    "frases longas",
    "respostas gen√©ricas",
    "linguagem rob√≥tica ou t√©cnica"
  ]
}
[2025-05-31 18:16:21] info: [perfilCliente] ‚úÖ Perfil completo reconstru√≠do para 5512988256404
[2025-05-31 18:16:21] debug: [perfilCliente] PerfilCliente resultante: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:16:21] info: [temperatura] üîç Calculando temperatura com base na etapa "pos_venda" e perfil do cliente
[2025-05-31 18:16:21] debug: [temperatura] Etapa reconhecida: "pos_venda" ‚Üí base inicial: 0.5
[2025-05-31 18:16:21] debug: [temperatura] Perfil recebido: {
  "formalidade": "formal",
  "emojis": true,
  "fala": "fala pouco",
  "detalhamento": "detalhista",
  "temperamento": "sangu√≠neo",
  "linguagemTecnica": "mista",
  "urgencia": "paciente"
}
[2025-05-31 18:16:21] debug: [temperatura] Ajuste: temperamento "sangu√≠neo" ‚Üí +0.1
[2025-05-31 18:16:21] debug: [temperatura] Ajuste: fala "fala pouco" ‚Üí -0.1
[2025-05-31 18:16:21] debug: [temperatura] Ajuste: detalhamento "detalhista" ‚Üí +0.05
[2025-05-31 18:16:21] info: [temperatura] ‚úÖ Temperatura final calculada: 0.55
[2025-05-31 18:16:23] info: [handleMessage] [exec-1748726179976] üîç Texto bruto da IA antes do filtro: Ol√° Lamuriel, espero que esteja tudo bem! Quando quiser, adoraria ouvir como est√° se sentindo com a nova barba. üòäüßî
[2025-05-31 18:16:23] info: [mongo] üìÑ AuditLog salvo com sucesso para 5512988256404
[2025-05-31 18:16:23] info: [registrarAuditoriaIA] ‚úÖ Auditoria registrada para etapa pos_venda, phone=5512988256404
[2025-05-31 18:16:23] info: [handleMessage] [exec-1748726179976] ‚úÖ Texto final p√≥s-processado: Lamuriel, espero que esteja tudo bem! Quando quiser, adoraria ouvir como est√° se sentindo com a nova barba. üòäüßî
[2025-05-31 18:16:23] info: [interactions] üíæ Intera√ß√£o salva para cliente ID 4
[2025-05-31 18:16:23] debug: [ClientRepository] last_interaction atualizada para cliente ID 4
[2025-05-31 18:16:23] info: [mongo] üí¨ Intera√ß√£o salva no MongoDB para 5512988256404
[2025-05-31 18:16:23] info: [typingSimulator] ‚åõ Simulando digita√ß√£o para mensagem de texto ‚Äî aguardando 5982ms
[2025-05-31 18:16:29] info: [typingSimulator] üöÄ Enviando mensagem de texto ap√≥s digita√ß√£o
[2025-05-31 18:16:29] info: [sendText] Enviando mensagem para 5512988256404. Conte√∫do: "Lamuriel, espero que esteja tudo bem! Quando quiser, adoraria ouvir como est√° se sentindo com a nova barba. üòäüßî" Timestamp=1748726189093
[2025-05-31 18:16:29] info: [whatsapp] ‚úâÔ∏è Preparando envio de mensagem para: 5512988256404
[2025-05-31 18:16:29] debug: [whatsapp] Conte√∫do da mensagem: "Lamuriel, espero que esteja tudo bem! Quando quiser, adoraria ouvir como est√° se sentindo com a nova barba. üòäüßî"
[2025-05-31 18:16:29] debug: [whatsapp] Payload final: {
  "messaging_product": "whatsapp",
  "to": "5512988256404",
  "type": "text",
  "text": {
    "body": "Lamuriel, espero que esteja tudo bem! Quando quiser, adoraria ouvir como est√° se sentindo com a nova barba. üòäüßî"
  }
}
[2025-05-31 18:16:29] debug: [whatsapp] Token usado (parcial): EAARCeDx...
[2025-05-31 18:16:29] info: [whatsapp] ‚úÖ Mensagem enviada com sucesso para 5512988256404
[2025-05-31 18:16:29] debug: [whatsapp] Resposta da API Meta: {
  "messaging_product": "whatsapp",
  "contacts": [
    {
      "input": "5512988256404",
      "wa_id": "5512988256404"
    }
  ],
  "messages": [
    {
      "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFBNjEyRjEzRkY3NkVFQ0NCMwA="
    }
  ]
}
[2025-05-31 18:16:29] info: [typingSimulator] ‚úÖ mensagem de texto enviada com sucesso
[2025-05-31 18:16:30] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:16:30] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726190564
[2025-05-31 18:16:30] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFBNjEyRjEzRkY3NkVFQ0NCMwA=",
                "status": "sent",
                "timestamp": "1748726212",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "expiration_timestamp": "1748732640",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:16:30] info: ‚ö° Evento de status recebido, ignorando.
[2025-05-31 18:16:31] debug: [rateLimiter] Permitido: POST /webhook IP=::1
[2025-05-31 18:16:31] info: ‚ö° Novo webhook POST recebido ‚Äî timestamp=1748726191154
[2025-05-31 18:16:31] debug: [webhook] Payload recebido: {
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "636076756097070",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15551931866",
              "phone_number_id": "658586517333983"
            },
            "statuses": [
              {
                "id": "wamid.HBgNNTUxMjk4ODI1NjQwNBUCABEYEjFBNjEyRjEzRkY3NkVFQ0NCMwA=",
                "status": "delivered",
                "timestamp": "1748726212",
                "recipient_id": "5512988256404",
                "conversation": {
                  "id": "1ad564e2c9127c60f063b5fc386eb1e8",
                  "origin": {
                    "type": "utility"
                  }
                },
                "pricing": {
                  "billable": true,
                  "pricing_model": "CBP",
                  "category": "utility"
                }
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
[2025-05-31 18:16:31] info: ‚ö° Evento de status recebido, ignorando.











